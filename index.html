<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Floppy Kirby — Telegram WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Nunito:800,700,600,400|Poppins:600,400&display=swap" rel="stylesheet">
  <style>
    html, body { margin: 0; padding: 0; width: 100vw; height: 100vh; font-family: 'Nunito', 'Poppins', 'Open Sans', sans-serif; background: #f7f4ff; overflow: hidden; user-select: none;}
    #mainMenu, #leaderboardContainer, #infoContainer, #gameOverPopup {
      width: 100vw; height: 100vh;
      display: none; position: fixed; top:0; left:0;
      flex-direction: column; align-items: center; justify-content: flex-start;
      background: linear-gradient(120deg, #a2d2ff 0%, #ffe7f3 100%);
      overflow-y: auto; padding: 0 !important;
    }
    #mainMenu .menu-inner,
    #leaderboardContainer .menu-inner,
    #infoContainer .menu-inner,
    #gameOverPopup .menu-inner { margin-top: 80px; width: 100%; display: flex; flex-direction: column; align-items: center; }
    #gameContainer { width: 100vw; height: 100vh; display: none; position: fixed; top:0; left:0; background: #fff; z-index: 20; overflow: hidden; padding: 0;}
    #gameCanvas { display: block; margin: 0; background: #fff; }
    .main-btn { margin: 14px 0; padding: 15px 36px; font-size: 1.15em; background: linear-gradient(90deg, #f7c8e0 0%, #b6eaff 100%); border: none; border-radius: 29px; box-shadow: 0 3px 16px #a2d2ff4d, 0 1px 1px #fff; cursor: pointer; font-weight: 700; color: #493a66; transition: 0.16s; display: block; }
    .main-btn:hover { background: linear-gradient(90deg, #ffc0cb 10%, #a2d2ff 100%); transform: scale(1.06);}
    .main-btn:active { transform: scale(0.96);}
    #leaderboardBackBtn, #infoBackBtn {
      position: absolute; top: 40px; left: 24px;
      padding: 11px 30px;
      background: linear-gradient(90deg, #f8daea 0%, #d1eaff 100%);
      border: none; border-radius: 22px;
      font-size: 1.04em; font-weight: 700; color: #4e3888;
      cursor: pointer;
      box-shadow: 0 3px 0 #c8a2c8, 0 2px 8px #ffdbf933;
      z-index: 99;
      transition: background 0.22s;
    }
    #leaderboardBackBtn:hover, #infoBackBtn:hover { background: linear-gradient(90deg, #c186fd 0, #ffb5d1 100%); color: #fff; }
    .popup-box { background: linear-gradient(120deg, #fff 63%, #ffe3fa 100%); border-radius: 32px; padding: 34px 36px 28px 36px; min-width: 240px; box-shadow: 0 8px 30px #e3caff88; display: flex; flex-direction: column; align-items: center; gap: 18px; margin-top: 80px;}
    .popup-box h2 { margin:0 0 8px 0; color: #9857d3; font-size: 1.23em;}
    .popup-box p { color: #47366b; font-size: 1.07em; margin: 0; }
    .popup-box button { margin-top: 5px; padding: 13px 32px; background: linear-gradient(90deg,#f7c8e0 0,#b6eaff 100%); border-radius: 20px; border: none; color: #44335b; font-weight: 700; font-size: 1.09em; box-shadow: 0 2px 12px #a2d2ff3b; cursor: pointer; transition: background 0.14s; display: block;}
    .popup-box button#gameOverCloseBtn { display: block; }
    #countdownOverlay { display:none;position:absolute;top:0;left:0;width:100vw;height:100vh;z-index:222; align-items:center;justify-content:center; background:rgba(248,245,255,0.78); font-size:3em;color:#9857d3;font-weight:900; font-family:'Nunito',sans-serif; letter-spacing:.08em; text-shadow:0 2px 12px #fff;}
  </style>
</head>
<body>
  <div id="mainMenu">
    <div class="menu-inner">
      <div class="tooltip">Collect coins and dodge enemies! 🪙</div>
      <div class="user-header">
        <img id="userPhoto" src="" alt="Avatar" />
        <span id="userName">@User</span>
      </div>
      <div class="user-meta">
        <div id="yourPlace">Rank: ...</div>
        <div id="yourHighScore">Best: ...</div>
      </div>
      <div id="coinsDisplay"></div>
      <button id="startGameBtn" class="main-btn">Start Game</button>
      <button id="leaderboardBtn" class="main-btn">Leaderboard</button>
      <button id="infoBtn" class="main-btn">How to Play?</button>
    </div>
  </div>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="countdownOverlay"></div>
  </div>
  <div id="leaderboardContainer">
    <div class="menu-inner">
      <button id="leaderboardBackBtn" class="main-btn" style="position:absolute;">Back</button>
      <h2 style="color:#7c46a3;text-align:center;margin:8px 0 0 0">Leaderboard</h2>
      <table>
        <thead>
          <tr><th>User</th><th>Best</th></tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>
  <div id="infoContainer">
    <div class="menu-inner">
      <button id="infoBackBtn" class="main-btn" style="position:absolute;">Back</button>
      <h2 style="color:#7c46a3;text-align:center;margin:5px 0 10px 0;">How to Play?</h2>
      <p>
        <b>Kirby</b> flies endlessly, collecting coins and dodging enemies.<br>
        If Kirby hits an enemy or falls — the game is over.<br>
        <b>Controls:</b> Tap / Click or Space.<br>
        The goal is to collect as many coins as possible in one run!<br>
        <br>
        Your record is saved and displayed in the leaderboard. Good luck!
      </p>
    </div>
  </div>
  <div id="gameOverPopup">
    <div class="menu-inner">
      <div class="popup-box">
        <h2>Game Over!</h2>
        <p id="gameOverText"></p>
        <button id="gameOverCloseBtn" class="main-btn">Back to Menu</button>
      </div>
    </div>
  </div>
  <script type="module">
    // --- Assets
    const kirbyImg = new window.Image();
    kirbyImg.src = "kirby.gif"; // любой gif/png (будет просто картинка, без анимации)
    const coinImg = new window.Image();
    coinImg.src = "https://donatepay.ru/uploads/notification/images/830208_1664005822.gif";
    const enemyImg = new window.Image();
    enemyImg.src = "https://i.pinimg.com/originals/4b/4f/a1/4b4fa16fff0d9782b6e53db976f89f78.gif";
    const bgImage = new window.Image();
    bgImage.src = "https://i.pinimg.com/736x/20/e9/cf/20e9cf219337614640886180cc5d1c34.jpg";

    // --- UI
    const mainMenu = document.getElementById("mainMenu");
    const startGameBtn = document.getElementById("startGameBtn");
    const gameContainer = document.getElementById("gameContainer");
    const gameCanvas = document.getElementById("gameCanvas");
    const gameOverPopup = document.getElementById("gameOverPopup");
    const gameOverText = document.getElementById("gameOverText");
    const gameOverCloseBtn = document.getElementById("gameOverCloseBtn");
    const countdownOverlay = document.getElementById("countdownOverlay");
    const coinsDisplay = document.getElementById("coinsDisplay");
    const yourHighScore = document.getElementById("yourHighScore");
    const yourPlace = document.getElementById("yourPlace");
    // --- Leaderboard & Info left out for brevity ---

    // --- GAME CONSTANTS
    const FIXED_FPS = 60;
    const ENEMY_SPAWN_SEC = 1.4;
    const COIN_SPAWN_SEC = 0.95;
    const BASE_GRAVITY = 0.3;
    const BASE_LIFT = -5.2;
    const BASE_SCROLL = 1.8;
    const BASE_MAXFALL = 3.1;

    // --- GAME STATE
    let ctx, animationId, isGameRunning = false;
    let canvasWidth = 0, canvasHeight = 0;
    let player, enemies, coins;
    let enemySpawnTimer = 0, coinSpawnTimer = 0;
    let scoreThisRun = 0, bgX = 0;
    let slowStart = true, showPlayer = false, deathFall = false, gameStartTime = 0, lastFrameTime = 0, firstTapDone = false;
    let ticksAfterStart = 0, slowStartFrame = 0;
    let highScore = 0;

    // --- Menu UI ---
    startGameBtn.onclick = () => { mainMenu.style.display = "none"; startGameWithCountdown(); };
    function resizeCanvas() {
      canvasWidth = window.innerWidth;
      canvasHeight = window.innerHeight;
      gameCanvas.width = canvasWidth;
      gameCanvas.height = canvasHeight;
    }
    window.addEventListener("resize", () => { if (isGameRunning) resizeCanvas(); });

    function startGameWithCountdown() {
      gameContainer.style.display = "block";
      gameOverPopup.style.display = "none";
      ctx = gameCanvas.getContext("2d");
      resizeCanvas();
      scoreThisRun = 0;
      player = {
        x: 100, y: canvasHeight / 2, width: 45, height: 45, velocityY: 0,
        gravity: BASE_GRAVITY, lift: BASE_LIFT, alive: true,
        maxFallSpeed: BASE_MAXFALL, rotating: false, rotAngle: 0
      };
      enemies = [];
      coins = [];
      enemySpawnTimer = 0; coinSpawnTimer = 0;
      bgX = 0; deathFall = false;
      showPlayer = false; slowStart = true; slowStartFrame = 0;
      lastFrameTime = performance.now(); firstTapDone = false; ticksAfterStart = 0;
      let countdown = 3;
      countdownOverlay.style.display = "flex";
      countdownOverlay.textContent = countdown;
      let cdInt = setInterval(() => {
        countdown--;
        if (countdown === 0) { countdownOverlay.textContent = "GO!"; }
        else if (countdown < 0) {
          countdownOverlay.style.display = "none";
          clearInterval(cdInt);
          showPlayer = true;
          startGameCore();
        } else { countdownOverlay.textContent = countdown; }
      }, 900);
    }
    function startGameCore() {
      isGameRunning = true;
      slowStart = true;
      slowStartFrame = 0;
      document.addEventListener("keydown", onKeyDown);
      document.addEventListener("mousedown", onClickOrTouch);
      document.addEventListener("touchstart", onClickOrTouch);
      lastFrameTime = performance.now();
      ticksAfterStart = 0;
      animationId = requestAnimationFrame(updateGame);
    }
    function updateGame(now = performance.now()) {
      let dt = Math.min((now - lastFrameTime) / 1000, 0.2); // seconds, clamp max
      lastFrameTime = now;
      // Draw background
      bgX -= BASE_SCROLL * dt * FIXED_FPS;
      if (bgX <= -canvasWidth) { bgX = 0; }
      ctx.drawImage(bgImage, bgX, 0, canvasWidth, canvasHeight);
      ctx.drawImage(bgImage, bgX + canvasWidth, 0, canvasWidth, canvasHeight);
      // Draw HUD
      ctx.save();
      ctx.font = "bold 2em Nunito";
      ctx.textAlign = "center";
      ctx.fillStyle = "#fff";
      ctx.shadowColor = "#b07cff";
      ctx.shadowBlur = 6;
      ctx.fillText(`Coins: ${scoreThisRun}`, canvasWidth / 2, 100);
      ctx.restore();
      if (!showPlayer) return; // skip drawing objects
      // Enemy & Coin spawn logic (in seconds)
      ticksAfterStart++;
      if (ticksAfterStart > 120) {
        enemySpawnTimer += dt;
        if (enemySpawnTimer > ENEMY_SPAWN_SEC) { spawnEnemy(); enemySpawnTimer = 0; }
      }
      coinSpawnTimer += dt;
      if (coinSpawnTimer > COIN_SPAWN_SEC) { spawnCoin(); coinSpawnTimer = 0; }
      // Enemies
      for (let e of enemies) e.x -= BASE_SCROLL * dt * FIXED_FPS;
      for (let i = enemies.length - 1; i >= 0; i--) {
        let e = enemies[i];
        ctx.drawImage(enemyImg, e.x, e.y, e.width, e.height);
        if (checkCollision(player, e)) { handleDeathAnimation(); return; }
        if (e.x + e.width < 0) enemies.splice(i, 1);
      }
      // Coins
      for (let c of coins) c.x -= BASE_SCROLL * dt * FIXED_FPS;
      for (let i = coins.length - 1; i >= 0; i--) {
        let c = coins[i];
        ctx.drawImage(coinImg, c.x, c.y, c.size, c.size);
        if (checkCollision(player, c)) { scoreThisRun++; coins.splice(i, 1); }
        else if (c.x + c.size < 0) coins.splice(i, 1);
      }
      // Player
      updatePlayer(dt);
      ctx.save();
      ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
      if (player.rotating) ctx.rotate(Math.PI / 2); // 90deg on death
      ctx.drawImage(kirbyImg, -player.width / 2, -player.height / 2, player.width, player.height);
      ctx.restore();
      if (player.alive) animationId = requestAnimationFrame(updateGame);
      if (deathFall) updateDeathFall(dt);
    }
    function spawnEnemy() {
      const randY = Math.random() * (canvasHeight - 80 - 20) + 10;
      enemies.push({ x: canvasWidth, y: randY, width: 80, height: 80 });
    }
    function spawnCoin() {
      const randY = Math.random() * (canvasHeight - 40 - 20) + 10;
      coins.push({ x: canvasWidth, y: randY, size: 40 });
    }
    function updatePlayer(dt) {
      let gravity = player.gravity;
      if (slowStart) {
        slowStartFrame++;
        gravity = 0.07;
        if (slowStartFrame > 72) slowStart = false;
      }
      player.velocityY += gravity * dt * FIXED_FPS;
      if (player.velocityY > player.maxFallSpeed) player.velocityY = player.maxFallSpeed;
      player.y += player.velocityY * dt * FIXED_FPS;
      if (player.y < 0) { player.y = 0; player.velocityY = 0; }
      if (player.y + player.height > canvasHeight) { handleDeathAnimation(); }
    }
    function onKeyDown(e) { if (e.code === "Space") handleFlap(); }
    function onClickOrTouch() { handleFlap(); }
    function handleFlap() {
      if (!player.alive) return;
      if (!firstTapDone) { firstTapDone = true; player.velocityY = player.lift; }
      else player.velocityY = player.lift;
    }
    function checkCollision(pl, obj) {
      const pr = { x: pl.x + 10, y: pl.y + 10, width: pl.width - 20, height: pl.height - 20 };
      const ow = (obj.width || obj.size) - 20;
      const oh = (obj.height || obj.size) - 20;
      const or = { x: obj.x + 10, y: obj.y + 10, width: ow > 0 ? ow : 0, height: oh > 0 ? oh : 0 };
      return !(
        or.x > pr.x + pr.width ||
        or.x + or.width < pr.x ||
        or.y > pr.y + pr.height ||
        or.y + or.height < pr.y
      );
    }
    function handleDeathAnimation() {
      if (!player.alive) return;
      player.alive = false; isGameRunning = false; deathFall = true;
      document.removeEventListener("keydown", onKeyDown);
      document.removeEventListener("mousedown", onClickOrTouch);
      document.removeEventListener("touchstart", onClickOrTouch);
      player.rotating = true;
      player.velocityY = 3.5;
      lastFrameTime = performance.now();
      animationId = requestAnimationFrame(updateGame);
    }
    function updateDeathFall(dt) {
      player.y += player.velocityY * dt * FIXED_FPS * 1.1;
      player.velocityY += 0.33 * dt * FIXED_FPS;
      if (player.y > canvasHeight + player.height) {
        deathFall = false;
        showGameOverSequence();
      } else {
        requestAnimationFrame(updateGame);
      }
    }
    function showGameOverSequence() {
      let newHigh = false;
      if (scoreThisRun > highScore) {
        highScore = scoreThisRun;
        newHigh = true;
      }
      let popupText = `You collected <b>${scoreThisRun}</b> coins this run.<br>`;
      if (newHigh) popupText += "<span style='color:#b13df3'>NEW RECORD!</span><br>";
      popupText += `Your best: <b>${highScore}</b>`;
      setTimeout(() => showGameOverPopup(popupText), 500);
    }
    function showGameOverPopup(html) {
      gameOverText.innerHTML = html;
      gameOverPopup.style.display = "flex";
    }
    gameOverCloseBtn.onclick = endGameAndReturn;
    function endGameAndReturn() {
      cancelAnimationFrame(animationId);
      document.removeEventListener("keydown", onKeyDown);
      document.removeEventListener("mousedown", onClickOrTouch);
      document.removeEventListener("touchstart", onClickOrTouch);
      isGameRunning = false; deathFall = false;
      gameContainer.style.display = "none";
      gameOverPopup.style.display = "none";
      mainMenu.style.display = "flex";
      // leaderboard etc. update logic сюда
    }
  </script>
</body>
</html>
