<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Floppy Kirby ‚Äî Telegram WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Nunito:800,700,600,400|Poppins:600,400&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0; padding: 0; width: 100vw; height: 100vh;
      font-family: 'Nunito', 'Poppins', 'Open Sans', sans-serif;
      background: #f7f4ff;
      overflow: hidden;
      user-select: none;
    }
    #mainMenu, #leaderboardContainer, #infoContainer, #gameOverPopup {
      width: 100vw; height: 100vh;
      display: none; position: fixed; top:0; left:0;
      flex-direction: column;
      padding-top: 50px !important; /* –°–≤–æ–±–æ–¥–Ω–æ —Å–≤–µ—Ä—Ö—É */
      box-sizing: border-box;
    }
    #mainMenu, #leaderboardContainer, #infoContainer {
      background: linear-gradient(120deg, #A2D2FF 0%, #FFC0CB 100%);
    }
    #mainMenu { align-items: center; justify-content: flex-start; }
    .tooltip {
      margin-bottom: 20px; background: #fff7; color: #8a67a8;
      font-size: 1.13em; padding: 10px 22px; border-radius: 18px;
      box-shadow: 0 4px 14px #b8d8fa36;
    }
    .user-header {
      display: flex; flex-direction: column; align-items: center; margin-bottom: 18px; gap: 6px;
    }
    .user-header img {
      width: 68px; height: 68px; border-radius: 50%; border:3.5px solid #fff;
      box-shadow: 0 6px 22px 0 #a2d2ff66; background: #fff;
    }
    .user-header span {
      font-size: 1.19em; color: #47366b; font-weight: bold;
      text-shadow: 0 1px 2px #eee;
      max-width: 180px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;
    }
    .user-meta { display: flex; flex-direction: column; gap: 5px; margin-bottom: 12px; align-items: center; }
    .user-meta div {
      font-size: 1.01em; color: #44335b; background: #fff6; border-radius: 10px;
      padding: 4px 16px; margin: 2px 0; box-shadow: 0 2px 6px 0 #a2d2ff1a;
      min-width: 140px; text-align: center;
    }
    #coinsDisplay {
      color: #fff; background: linear-gradient(90deg,#b07cff 0,#ffb5d1 100%);
      font-size: 1.14em; font-weight: 700;
      margin-bottom: 13px; padding: 7px 20px;
      border-radius: 30px; box-shadow: 0 2px 18px #c2a4ff22; text-shadow: 0 2px 2px #fff7; border: 2px solid #fff;
    }
    #mainMenu button {
      margin: 12px; padding: 14px 32px; font-size: 1.14em;
      background: linear-gradient(90deg, #f7c8e0 0%, #b6eaff 100%);
      border: none; border-radius: 28px; box-shadow: 0 3px 14px #a2d2ff4d;
      cursor: pointer; font-weight: 700; color: #44335b; transition: 0.16s;
    }
    #mainMenu button:hover { background: linear-gradient(90deg, #ffc0cb 20%, #A2D2FF 100%); transform: scale(1.04);}
    #mainMenu button:active { transform: scale(0.97);}
    #gameContainer { background: #fff; z-index: 20; width:100vw;height:100vh;position:fixed;top:0;left:0;}
    #leaderboardContainer, #infoContainer {
      z-index: 50; overflow-y: auto; animation: fadeIn 0.3s;
    }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    #leaderboardBackBtn, #infoBackBtn {
      position: absolute; top: 60px; left: 18px;
      padding: 10px 24px; background: linear-gradient(90deg, #ffdaea 0%, #cceaff 100%);
      border: none; border-radius: 22px; font-size: 1.01em; font-weight: 700; color: #574488;
      cursor: pointer; box-shadow: 0 3px 0 #C8A2C8, 0 2px 8px #ffdbf933; z-index: 99;
    }
    #leaderboardBackBtn:hover, #infoBackBtn:hover {
      background: linear-gradient(90deg, #b07cff 0, #ffb5d1 100%); color: #fff;
    }
    table { width: 95%; margin: 26px auto 0 auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 18px 0 #c2a4ff29;}
    th, td { padding: 14px 10px; text-align: left; font-size: 1.09em;}
    th { background: #C8A2C8; color: #fff; border-radius: 10px 10px 0 0;}
    tr:nth-child(odd) { background: #f9f5ff; }
    .medal { font-size:1.23em; font-weight:900;}
    #infoContainer p { font-size: 1.09em; color: #493A64; background: #fff7; border-radius: 12px; padding: 10px 14px;}
    #gameOverPopup {
      z-index: 999; display: flex; align-items: center; justify-content: center;
      background: rgba(60,30,80,0.42);
      animation: fadeIn 0.25s; flex-direction:column; padding-top:50px;
    }
    .popup-box {
      background: linear-gradient(120deg, #fff 60%, #ffe3fa 100%);
      border-radius: 30px; padding: 32px 30px; min-width: 240px;
      box-shadow: 0 6px 30px #e3caff70;
      display: flex; flex-direction: column; align-items: center; gap: 16px;
    }
    .popup-box h2 { margin:0 0 8px 0; color: #9857d3; font-size: 1.17em;}
    .popup-box p { color: #47366b; font-size: 1.03em; margin: 0; }
    .popup-box button {
      margin-top: 8px; padding: 12px 30px;
      background: linear-gradient(90deg,#f7c8e0 0,#b6eaff 100%);
      border-radius: 20px; border: none;
      color: #44335b; font-weight: 700; font-size: 1.07em; box-shadow: 0 2px 12px #a2d2ff3b; cursor: pointer;
    }
    .popup-box button:hover { background: linear-gradient(90deg, #ffc0cb 20%, #A2D2FF 100%);}
    @media (max-width: 600px) {
      #mainMenu button, #leaderboardBackBtn, #infoBackBtn, .popup-box button { font-size: 0.97em; padding:10px 12px;}
      .user-header img { width: 58px; height: 58px;}
    }
    @media (max-width: 390px) {
      #coinsDisplay { font-size: 0.96em; padding: 7px 10px;}
      .user-meta div { font-size: 0.93em;}
    }
  </style>
</head>
<body>
  <!-- Main Menu -->
  <div id="mainMenu">
    <div class="tooltip">Collect coins and dodge enemies! ü™ô</div>
    <div class="user-header">
      <img id="userPhoto" src="" alt="Avatar" />
      <span id="userName">@User</span>
    </div>
    <div class="user-meta">
      <div id="yourPlace">Rank: ...</div>
      <div id="yourHighScore">Best: ...</div>
    </div>
    <div id="coinsDisplay"></div>
    <button id="startGameBtn">Start Game</button>
    <button id="leaderboardBtn">Leaderboard</button>
    <button id="infoBtn">How to Play?</button>
  </div>

  <!-- Game Screen -->
  <div id="gameContainer" style="display:none;">
    <canvas id="gameCanvas"></canvas>
    <!-- countdown overlay -->
    <div id="countdownOverlay" style="display:none;position:absolute;top:0;left:0;width:100vw;height:100vh;z-index:222;align-items:center;justify-content:center;background:rgba(248,245,255,0.78);font-size:3em;color:#9857d3;font-weight:900;font-family:'Nunito',sans-serif;"></div>
  </div>

  <!-- Leaderboard -->
  <div id="leaderboardContainer">
    <button id="leaderboardBackBtn">Back</button>
    <h2 style="color:#7c46a3;text-align:center;margin:10px 0 0 0">Leaderboard</h2>
    <table>
      <thead>
        <tr><th></th><th>User</th><th>Best</th></tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>

  <!-- Info -->
  <div id="infoContainer">
    <button id="infoBackBtn">Back</button>
    <h2 style="color:#7c46a3;text-align:center;">How to Play?</h2>
    <p>
      <b>Kirby</b> flies endlessly, collecting coins and dodging enemies.<br>
      If Kirby hits an enemy or falls ‚Äî the game is over.<br>
      <b>Controls:</b> Tap / Click or Space.<br>
      Bonus coins give extra points!<br>
      The goal is to collect as many coins as possible in one run!<br>
      <br>
      Your record is saved and displayed in the leaderboard. Good luck!
    </p>
  </div>

  <!-- Game Over Popup -->
  <div id="gameOverPopup">
    <div class="popup-box">
      <h2>Game Over!</h2>
      <p id="gameOverText"></p>
      <button id="gameOverCloseBtn">Back to Menu</button>
      <button id="playAgainBtn">Play Again</button>
    </div>
  </div>

  <script type="module">
    // --- setup, firebase, user ---
    const tg = window.Telegram.WebApp;
    if (typeof tg.requestFullscreen === 'function') tg.requestFullscreen();
    else tg.expand();

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    const firebaseConfig = {apiKey:"AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",authDomain:"test-with-likes.firebaseapp.com",databaseURL:"https://test-with-likes-default-rtdb.firebaseio.com",projectId:"test-with-likes",storageBucket:"test-with-likes.appspot.com",messagingSenderId:"764738820142",appId:"1:764738820142:web:b22c6608a30e46cdcea7bf",measurementId:"G-WJNF0HSN9P"};
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM
    const mainMenu = document.getElementById("mainMenu");
    const userPhoto = document.getElementById("userPhoto");
    const userName = document.getElementById("userName");
    const coinsDisplay = document.getElementById("coinsDisplay");
    const startGameBtn = document.getElementById("startGameBtn");
    const leaderboardBtn = document.getElementById("leaderboardBtn");
    const infoBtn = document.getElementById("infoBtn");
    const gameContainer = document.getElementById("gameContainer");
    const gameCanvas = document.getElementById("gameCanvas");
    const leaderboardContainer = document.getElementById("leaderboardContainer");
    const leaderboardBackBtn = document.getElementById("leaderboardBackBtn");
    const leaderboardBody = document.getElementById("leaderboardBody");
    const infoContainer = document.getElementById("infoContainer");
    const infoBackBtn = document.getElementById("infoBackBtn");
    const yourPlace = document.getElementById("yourPlace");
    const yourHighScore = document.getElementById("yourHighScore");
    const gameOverPopup = document.getElementById("gameOverPopup");
    const gameOverText = document.getElementById("gameOverText");
    const gameOverCloseBtn = document.getElementById("gameOverCloseBtn");
    const playAgainBtn = document.getElementById("playAgainBtn");
    const countdownOverlay = document.getElementById("countdownOverlay");
    gameOverPopup.style.display = "none";

    // User
    let tgUser = tg.initDataUnsafe?.user;
    if (!tgUser) {mainMenu.innerHTML = "<h2>Please open in Telegram!</h2>"; throw new Error("Not Telegram WebApp");}
    const userId = tgUser.id.toString();
    let highScore = 0;

    async function loadUser() {
      userPhoto.src = tgUser.photo_url || "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png";
      userName.textContent = tgUser.username ? "@" + tgUser.username : "No username";
      const userRef = ref(db, `users/${userId}`);
      let snapshot = await get(userRef);
      if (!snapshot.exists()) {
        await set(userRef, {highScore: 0, username: tgUser.username || "", photo: tgUser.photo_url || ""});
        highScore = 0;
      } else { highScore = snapshot.val().highScore || 0; }
      coinsDisplay.textContent = `Best: ${highScore}`;
      yourHighScore.textContent = `Best: ${highScore}`;
      await updatePlace();
      mainMenu.style.display = "flex";
    }
    window.onload = loadUser;

    async function updatePlace() {
      yourPlace.textContent = "Rank: ...";
      const usersRef = ref(db, "users/");
      const snapshot = await get(usersRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        const usersArray = Object.entries(data).map(([id, u]) => ({id, highScore: u.highScore || 0}));
        usersArray.sort((a, b) => b.highScore - a.highScore);
        const place = usersArray.findIndex(x => x.id === userId) + 1;
        if (place > 0) yourPlace.textContent = `Rank: ${place} of ${usersArray.length}`;
        else yourPlace.textContent = `Rank: ‚Äî`;
      }
    }

    startGameBtn.onclick = () => {mainMenu.style.display = "none"; startGameWithCountdown();};
    leaderboardBtn.onclick = () => {mainMenu.style.display = "none"; leaderboardContainer.style.display = "flex"; loadLeaderboard();};
    infoBtn.onclick = () => {mainMenu.style.display = "none"; infoContainer.style.display = "flex";};
    leaderboardBackBtn.onclick = () => {leaderboardContainer.style.display = "none"; mainMenu.style.display = "flex";};
    infoBackBtn.onclick = () => {infoContainer.style.display = "none"; mainMenu.style.display = "flex";};

    // –õ–∏–¥–µ—Ä—ã + –º–µ–¥–∞–ª–∏ —Ç–æ–ø-3
    async function loadLeaderboard() {
      leaderboardBody.innerHTML = "";
      const usersRef = ref(db, "users/");
      const snapshot = await get(usersRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        const usersArray = Object.entries(data).map(([id, u]) => ({
          username: u.username ? `@${u.username}` : "User " + id,
          highScore: u.highScore || 0,
        }));
        usersArray.sort((a, b) => b.highScore - a.highScore);
        usersArray.forEach((user, idx) => {
          const tr = document.createElement("tr");
          let medal = "";
          if (idx === 0) medal = "<span class='medal' style='color:#ffe46b'>ü•á</span>";
          if (idx === 1) medal = "<span class='medal' style='color:#b6b2b2'>ü•à</span>";
          if (idx === 2) medal = "<span class='medal' style='color:#d99360'>ü•â</span>";
          tr.innerHTML = `<td>${medal}</td><td>${user.username}</td><td>${user.highScore}</td>`;
          if (idx === 0) tr.style.background="#f7efba";
          if (idx === 1) tr.style.background="#e7e4ed";
          if (idx === 2) tr.style.background="#fde2c7";
          leaderboardBody.appendChild(tr);
        });
      }
    }

    // --- Game Logic ---
    let ctx, animationId, isGameRunning = false;
    let canvasWidth = 0, canvasHeight = 0;
    let enemySlowTimer = 0; // —ç—Ñ—Ñ–µ–∫—Ç –∑–∞–º–µ–¥–ª–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤

    const player = { x: 100, y: 150, width: 45, height: 45, velocityY: 0, gravity: 0.3, lift: -5, alive: true, maxFallSpeed: 3, el: null, angle: 0 };
    const scrollSpeed = 1.8;
    let enemies = [], enemyTimer = 0, enemyInterval = 150;
    const enemyGif = "https://i.pinimg.com/originals/4b/4f/a1/4b4fa16fff0d9782b6e53db976f89f78.gif";
    const enemyWidth = 80, enemyHeight = 80;
    let coins = [], coinTimer = 0, coinInterval = 80;
    const coinSize = 40, coinGifURL = "https://donatepay.ru/uploads/notification/images/830208_1664005822.gif";
    let scoreThisRun = 0, bgX = 0, bonusStreak = 0;
    let bonusCoins = []; // –±–æ–Ω—É—Å-–º–æ–Ω–µ—Ç—ã
    const bonusCoinImg = "https://static.vecteezy.com/system/resources/previews/009/663/044/original/golden-coin-3d-isolated-png.png";
    const bgImage = new window.Image();
    bgImage.src = "https://i.pinimg.com/736x/20/e9/cf/20e9cf219337614640886180cc5d1c34.jpg";
    const collisionMargin = 10;

    // -- –ù–æ–≤—ã–π —Å—Ç–∞—Ä—Ç —Å –æ—Ç—Å—á–µ—Ç–æ–º
    function startGameWithCountdown() {
      gameContainer.style.display = "block";
      gameOverPopup.style.display = "none";
      ctx = gameCanvas.getContext("2d");
      resizeCanvas();
      scoreThisRun = 0; bonusStreak = 0;
      player.y = canvasHeight / 2; player.velocityY = 0; player.angle = 0; player.alive = true;
      enemies = []; enemyTimer = 0; coins = []; coinTimer = 0; bonusCoins = []; bgX = 0; enemySlowTimer = 0;
      if (!player.el) {
        const kirby = document.createElement("img");
        kirby.src = "kirby.gif";
        kirby.style.position = "absolute";
        kirby.style.width = player.width + "px";
        kirby.style.height = player.height + "px";
        kirby.style.left = player.x + "px";
        kirby.style.top = player.y + "px";
        kirby.style.zIndex = "900"; kirby.draggable = false;
        gameContainer.appendChild(kirby);
        player.el = kirby;
      } else { player.el.style.display = "block"; }
      player.el.style.transform = "rotate(0deg)";
      let countdown = 3;
      countdownOverlay.style.display = "flex";
      countdownOverlay.textContent = countdown;
      let cdInt = setInterval(() => {
        countdown--;
        if (countdown === 0) countdownOverlay.textContent = "GO!";
        else if (countdown < 0) {
          countdownOverlay.style.display = "none";
          clearInterval(cdInt);
          startGameCore();
        } else countdownOverlay.textContent = countdown;
      }, 900);
    }

    function startGameCore() {
      isGameRunning = true;
      ticksAfterStart = 0; slowStart = true;
      document.addEventListener("keydown", onKeyDown);
      document.addEventListener("mousedown", onClickOrTouch);
      document.addEventListener("touchstart", onClickOrTouch);
      animationId = requestAnimationFrame(updateGame);
    }

    function resizeCanvas() {
      canvasWidth = window.innerWidth;
      canvasHeight = window.innerHeight;
      gameCanvas.width = canvasWidth;
      gameCanvas.height = canvasHeight;
    }
    window.addEventListener("resize", () => { if (isGameRunning) resizeCanvas(); });

    // –¢–∞–π–º–µ—Ä –≤—Ä–∞–≥–æ–≤ - 2 —Å–µ–∫ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è + –º–µ–¥–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç –ø–∞–¥–µ–Ω–∏—è
    let ticksAfterStart = 0;
    let slowStart = true;
    function updateGame() {
      if (!isGameRunning) return;
      ctx.clearRect(0, 0, canvasWidth, canvasHeight);
      drawScrollingBackground();
      ticksAfterStart++;
      // Slow start: –ø–µ—Ä–≤—ã–µ 1.5 —Å–µ–∫—É–Ω–¥—ã –∏–≥—Ä–æ–∫ –ø–æ—á—Ç–∏ –Ω–µ –ø–∞–¥–∞–µ—Ç
      let nowGravity = player.gravity;
      if (ticksAfterStart < 90) { nowGravity = 0.09; } // –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–≤—ã–µ ~1.5 —Å–µ–∫
      if (ticksAfterStart > 120) { // –≤—Ä–∞–≥–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ 2 —Å–µ–∫
        let interval = enemyInterval;
        if (enemySlowTimer > 0) interval = enemyInterval * 2;
        enemyTimer++; if (enemyTimer > interval) { createEnemy(); enemyTimer = 0; }
      }
      coinTimer++; if (coinTimer > coinInterval) { createCoin(); coinTimer = 0; }
      // –ë–æ–Ω—É—Å –º–æ–Ω–µ—Ç–∞ —à–∞–Ω—Å 1 –∫ 90 –∑–∞ —Ç–∏–∫, —Ç–æ–ª—å–∫–æ 1 –Ω–∞ —ç–∫—Ä–∞–Ω–µ
      if (Math.random() < 1/90 && bonusCoins.length === 0) createBonusCoin();

      for (let i = 0; i < enemies.length; i++) {
        const e = enemies[i];
        let moveSpeed = scrollSpeed;
        if (enemySlowTimer > 0) moveSpeed *= 0.45;
        e.x -= moveSpeed;
        e.el.style.left = e.x + "px"; e.el.style.top = e.y + "px";
        if (checkCollision(player, e) && player.alive) { player.alive = false; animateDeath(); return; }
      }
      enemies = enemies.filter(e => { if (e.x + e.width < 0) { gameContainer.removeChild(e.el); return false; } return true; });
      for (let i = 0; i < coins.length; i++) {
        const c = coins[i];
        c.x -= scrollSpeed;
        c.el.style.left = c.x + "px"; c.el.style.top = c.y + "px";
        if (checkCollision(player, c) && player.alive) {
          scoreThisRun++; c.collected = true; bonusStreak++; animateCoinCollect(c);
          if (bonusStreak % 10 === 0) {enemySlowTimer = 120;} // –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
        }
      }
      coins = coins.filter(c => { if (c.collected || (c.x + c.size < 0)) { gameContainer.removeChild(c.el); return false; } return true; });

      // –ë–æ–Ω—É—Å –º–æ–Ω–µ—Ç—ã
      for (let i = 0; i < bonusCoins.length; i++) {
        const bc = bonusCoins[i];
        bc.x -= scrollSpeed * 0.9;
        bc.el.style.left = bc.x + "px"; bc.el.style.top = bc.y + "px";
        if (checkCollision(player, bc) && player.alive) {
          scoreThisRun += 3; bc.collected = true; bonusStreak++; animateBonusCoin(bc);
        }
      }
      bonusCoins = bonusCoins.filter(bc => { if (bc.collected || (bc.x + bc.size < 0)) { gameContainer.removeChild(bc.el); return false; } return true; });

      if (enemySlowTimer > 0) enemySlowTimer--;

      updatePlayer(nowGravity);
      ctx.fillStyle = "white"; ctx.font = "24px Nunito, Arial";
      ctx.fillText(`Coins this run: ${scoreThisRun}`, 20, 40);
      if (player.alive) { animationId = requestAnimationFrame(updateGame); }
    }

    function drawScrollingBackground() {
      bgX -= 1; if (bgX <= -canvasWidth) { bgX = 0; }
      ctx.drawImage(bgImage, bgX, 0, canvasWidth, canvasHeight);
      ctx.drawImage(bgImage, bgX + canvasWidth, 0, canvasWidth, canvasHeight);
    }
    function createEnemy() {
      const randY = Math.random() * (canvasHeight - enemyHeight - 20) + 10;
      const enemyEl = document.createElement("img");
      enemyEl.src = enemyGif; enemyEl.style.position = "absolute";
      enemyEl.style.width = enemyWidth + "px"; enemyEl.style.height = enemyHeight + "px";
      enemyEl.style.left = canvasWidth + "px"; enemyEl.style.top = randY + "px";
      enemyEl.style.zIndex = "850"; enemyEl.draggable = false; gameContainer.appendChild(enemyEl);
      enemies.push({ x: canvasWidth, y: randY, width: enemyWidth, height: enemyHeight, el: enemyEl });
    }
    function createCoin() {
      const randY = Math.random() * (canvasHeight - coinSize - 20) + 10;
      const coinEl = document.createElement("img");
      coinEl.src = coinGifURL; coinEl.style.position = "absolute";
      coinEl.style.width = coinSize + "px"; coinEl.style.height = coinSize + "px";
      coinEl.style.left = canvasWidth + "px"; coinEl.style.top = randY + "px";
      coinEl.style.zIndex = "800"; coinEl.draggable = false; gameContainer.appendChild(coinEl);
      coins.push({ x: canvasWidth, y: randY, size: coinSize, collected: false, el: coinEl });
    }
    function createBonusCoin() {
      const randY = Math.random() * (canvasHeight - coinSize - 30) + 10;
      const bonusEl = document.createElement("img");
      bonusEl.src = bonusCoinImg; bonusEl.style.position = "absolute";
      bonusEl.style.width = (coinSize*1.5) + "px"; bonusEl.style.height = (coinSize*1.5) + "px";
      bonusEl.style.left = canvasWidth + "px"; bonusEl.style.top = randY + "px";
      bonusEl.style.zIndex = "820"; bonusEl.draggable = false; bonusEl.style.filter = "drop-shadow(0 0 20px #ffd700cc)";
      gameContainer.appendChild(bonusEl);
      bonusCoins.push({ x: canvasWidth, y: randY, size: coinSize*1.5, collected: false, el: bonusEl });
    }

    // --- –ê–Ω–∏–º–∞—Ü–∏—è –≤–∑—è—Ç–∏—è –æ–±—ã—á–Ω–æ–π –º–æ–Ω–µ—Ç—ã
    function animateCoinCollect(c) {
      c.el.style.transition = "all 0.33s cubic-bezier(.7,.6,.6,1.7)";
      c.el.style.transform = "scale(1.55) rotate(27deg)";
      setTimeout(()=>{ if (c.el) c.el.style.display="none"; },300);
    }
    // --- –ê–Ω–∏–º–∞—Ü–∏—è –≤–∑—è—Ç–∏—è –±–æ–Ω—É—Å-–º–æ–Ω–µ—Ç—ã
    function animateBonusCoin(c) {
      c.el.style.transition = "all 0.44s cubic-bezier(.6,1.4,.8,1.3)";
      c.el.style.transform = "scale(1.7) rotate(-17deg)";
      setTimeout(()=>{ if (c.el) c.el.style.display="none"; },330);
    }

    function updatePlayer(gOverride) {
      player.velocityY += typeof gOverride === "number" ? gOverride : player.gravity;
      if (player.velocityY > player.maxFallSpeed) player.velocityY = player.maxFallSpeed;
      player.y += player.velocityY;
      if (player.y < 0) { player.y = 0; player.velocityY = 0; }
      if (player.y + player.height > canvasHeight && player.alive) { player.alive = false; animateDeath(); return; }
      if (player.el) {
        player.el.style.left = player.x + "px";
        player.el.style.top = player.y + "px";
        player.el.style.transform = `rotate(${player.angle || 0}deg)`;
      }
    }
    function onKeyDown(e) { if (e.code === "Space") flap(); }
    function onClickOrTouch() { flap(); }
    function flap() {
      if (!player.alive) return;
      player.velocityY = player.lift;
      player.angle = -18 + Math.random()*10;
      player.el.style.filter = "drop-shadow(0 0 14px #ffcbf9)";
      setTimeout(() => { player.el.style.filter = "none"; player.angle = 0; }, 100);
    }
    function checkCollision(pl, obj) {
      const pr = { x: pl.x + collisionMargin, y: pl.y + collisionMargin, width: pl.width - collisionMargin * 2, height: pl.height - collisionMargin * 2 };
      const ow = (obj.width  || obj.size) - collisionMargin * 2;
      const oh = (obj.height || obj.size) - collisionMargin * 2;
      const or = { x: obj.x + collisionMargin, y: obj.y + collisionMargin, width:  ow > 0 ? ow : 0, height: oh > 0 ? oh : 0 };
      return !(or.x > pr.x + pr.width || or.x + or.width < pr.x || or.y > pr.y + pr.height || or.y + or.height < pr.y);
    }

    // --- –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–∏–≥—Ä—ã—à–∞ ---
    function animateDeath() {
      // –ö–∏—Ä–±–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤–Ω–∏–∑ –∏ –ø–∞–¥–∞–µ—Ç –∑–∞ —ç–∫—Ä–∞–Ω
      let fallInterval = setInterval(()=>{
        player.angle += 8; player.y += 12; player.el.style.transform = `rotate(${player.angle}deg)`;
        if (player.y > canvasHeight + 80) {
          clearInterval(fallInterval);
          setTimeout(()=>gameOver(), 350);
        }
      },18);
    }

    function gameOver() {
      cancelAnimationFrame(animationId);
      document.removeEventListener("keydown", onKeyDown);
      document.removeEventListener("mousedown", onClickOrTouch);
      document.removeEventListener("touchstart", onClickOrTouch);
      isGameRunning = false;
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥, –µ—Å–ª–∏ –æ–Ω –ø–æ–±–∏—Ç
      let newHigh = false;
      if (scoreThisRun > highScore) { highScore = scoreThisRun; newHigh = true; }
      updateScoreInDB(newHigh, scoreThisRun);
      // Popup
      let popupText = `You collected <b>${scoreThisRun}</b> coins this run.<br>`;
      if (newHigh) popupText += "<span style='color:#b13df3'>NEW RECORD!</span><br>";
      popupText += `Your best: <b>${highScore}</b>`;
      setTimeout(() => showGameOverPopup(popupText), 200);
    }
    function showGameOverPopup(html) {
      gameOverText.innerHTML = html;
      gameOverPopup.style.display = "flex";
    }
    gameOverCloseBtn.onclick = endGameAndReturn;
    playAgainBtn.onclick = () => {gameOverPopup.style.display = "none"; startGameWithCountdown();};

    function endGameAndReturn() {
      if (isGameRunning) {
        cancelAnimationFrame(animationId);
        document.removeEventListener("keydown", onKeyDown);
        document.removeEventListener("mousedown", onClickOrTouch);
        document.removeEventListener("touchstart", onClickOrTouch);
        isGameRunning = false;
      }
      if (player.el) player.el.style.display = "none";
      for (const e of enemies) if (e.el) gameContainer.removeChild(e.el);
      enemies = [];
      for (const c of coins) if (c.el) gameContainer.removeChild(c.el);
      coins = [];
      for (const bc of bonusCoins) if (bc.el) gameContainer.removeChild(bc.el);
      bonusCoins = [];
      gameContainer.style.display = "none";
      gameOverPopup.style.display = "none";
      coinsDisplay.textContent = `Best: ${highScore}`;
      yourHighScore.textContent = `Best: ${highScore}`;
      updatePlace();
      mainMenu.style.display = "flex";
      ticksAfterStart = 0;
    }

    async function updateScoreInDB(isNewHigh, latestScore) {
      const userRef = ref(db, `users/${userId}`);
      let updateData = {};
      if (isNewHigh) updateData.highScore = latestScore;
      await update(userRef, updateData);
      coinsDisplay.textContent = `Best: ${highScore}`;
      yourHighScore.textContent = `Best: ${highScore}`;
    }
  </script>
</body>
</html>
