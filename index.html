<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Floppy Kirby ‚Äî Telegram WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Nunito:800,700,600,400|Poppins:600,400&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0; padding: 0; width: 100vw; height: 100vh;
      font-family: 'Nunito', 'Poppins', 'Open Sans', sans-serif;
      background: #f7f4ff;
      overflow: hidden;
      user-select: none;
    }
    .top-gap { margin-top: 80px !important; }
    #mainMenu, #leaderboardContainer, #infoContainer, #gameOverPopup {
      width: 100vw; height: 100vh;
      display: none; position: fixed; top:0; left:0;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background: linear-gradient(120deg, #a2d2ff 0%, #ffe7f3 100%);
      overflow-y: auto;
      padding: 0 !important;
    }
    #mainMenu .menu-inner,
    #leaderboardContainer .menu-inner,
    #infoContainer .menu-inner,
    #gameOverPopup .menu-inner {
      margin-top: 80px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #gameContainer {
      width: 100vw; height: 100vh;
      display: none; position: fixed; top:0; left:0;
      background: #fff;
      z-index: 20;
      overflow: hidden;
      padding: 0;
    }
    .tooltip {
      margin-bottom: 22px;
      background: #fff4;
      color: #7e47a8;
      font-size: 1.13em;
      padding: 9px 22px;
      border-radius: 20px;
      box-shadow: 0 8px 22px #b8d8fa36;
      letter-spacing: .03em;
      transition: background 0.3s;
      max-width: 90vw;
      text-align: center;
    }
    .user-header {
      display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; gap: 6px;
      background: rgba(255,255,255,0.63);
      border-radius: 18px;
      box-shadow: 0 4px 16px #c8a2c866;
      padding: 18px 32px 15px 32px;
    }
    .user-header img {
      width: 72px; height: 72px; border-radius: 50%; border:3.5px solid #fff;
      box-shadow: 0 4px 24px 0 #a2d2ff61;
      background: #fff;
      margin-bottom: 3px;
    }
    .user-header span {
      font-size: 1.14em; color: #4b3570; font-weight: 700;
      text-shadow: 0 2px 4px #eee;
      max-width: 200px;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      letter-spacing: .01em;
    }
    .user-meta {
      display: flex; flex-direction: row; gap: 10px;
      margin-bottom: 18px; align-items: center;
      width: 100%; justify-content: center;
    }
    .user-meta div {
      font-size: 1.01em; color: #44335b; background: #fff9;
      border-radius: 13px;
      padding: 5px 18px; margin: 2px 0;
      box-shadow: 0 2px 8px #a2d2ff1a;
      min-width: 90px; text-align: center;
      font-weight: 600;
    }
    #coinsDisplay {
      color: #fff; background: linear-gradient(90deg,#c186fd 0,#ffb5d1 100%);
      font-size: 1.12em; font-weight: 700;
      margin-bottom: 16px; padding: 8px 24px;
      border-radius: 30px;
      box-shadow: 0 3px 12px #c2a4ff1a;
      text-shadow: 0 2px 2px #fff9;
      border: 2px solid #fff;
      letter-spacing: .04em;
      display: inline-block;
    }
    .main-btn {
      margin: 14px 0; padding: 15px 36px;
      font-size: 1.15em;
      background: linear-gradient(90deg, #f7c8e0 0%, #b6eaff 100%);
      border: none; border-radius: 29px;
      box-shadow: 0 3px 16px #a2d2ff4d, 0 1px 1px #fff;
      cursor: pointer; font-weight: 700; color: #493a66;
      transition: 0.16s;
      display: block;
    }
    .main-btn:hover { background: linear-gradient(90deg, #ffc0cb 10%, #a2d2ff 100%); transform: scale(1.06);}
    .main-btn:active { transform: scale(0.96);}
    /* Leaderboard table */
    #leaderboardContainer h2 { margin-bottom: 10px; }
    table { width: 94%; margin: 12px auto 0 auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 18px 0 #c2a4ff29;}
    th, td { padding: 15px 10px; text-align: left; font-size: 1.08em;}
    th { background: #c186fd; color: #fff; border-radius: 12px 12px 0 0;}
    tr:nth-child(odd) { background: #f9f5ff; }
    tr:nth-child(even) { background: #f4ecfb; }
    #leaderboardBackBtn, #infoBackBtn {
      position: absolute; top: 40px; left: 24px;
      padding: 11px 30px;
      background: linear-gradient(90deg, #f8daea 0%, #d1eaff 100%);
      border: none; border-radius: 22px;
      font-size: 1.04em; font-weight: 700; color: #4e3888;
      cursor: pointer;
      box-shadow: 0 3px 0 #c8a2c8, 0 2px 8px #ffdbf933;
      z-index: 99;
      transition: background 0.22s;
    }
    #leaderboardBackBtn:hover, #infoBackBtn:hover {
      background: linear-gradient(90deg, #c186fd 0, #ffb5d1 100%);
      color: #fff;
    }
    #infoContainer p { font-size: 1.10em; color: #493A64; background: #fff7; border-radius: 12px; padding: 10px 14px; margin-top: 0;}
    /* Game Over Popup */
    #gameOverPopup {
      z-index: 999; display: none; align-items: center; justify-content: center;
      background: rgba(60,30,80,0.42);
      animation: fadeIn 0.23s;
    }
    .popup-box {
      background: linear-gradient(120deg, #fff 63%, #ffe3fa 100%);
      border-radius: 32px; padding: 34px 36px 28px 36px; min-width: 240px;
      box-shadow: 0 8px 30px #e3caff88;
      display: flex; flex-direction: column; align-items: center; gap: 18px;
      margin-top: 80px;
    }
    .popup-box h2 { margin:0 0 8px 0; color: #9857d3; font-size: 1.23em;}
    .popup-box p { color: #47366b; font-size: 1.07em; margin: 0; }
    .popup-box button {
      margin-top: 5px; padding: 13px 32px;
      background: linear-gradient(90deg,#f7c8e0 0,#b6eaff 100%);
      border-radius: 20px; border: none;
      color: #44335b; font-weight: 700; font-size: 1.09em; box-shadow: 0 2px 12px #a2d2ff3b;
      cursor: pointer;
      transition: background 0.14s;
      display: none;
    }
    .popup-box button#gameOverCloseBtn { display: block; }
    /* Countdown Overlay */
    #countdownOverlay {
      display:none;position:absolute;top:0;left:0;width:100vw;height:100vh;z-index:222;
      align-items:center;justify-content:center;
      background:rgba(248,245,255,0.78);
      font-size:3em;color:#9857d3;font-weight:900;
      font-family:'Nunito',sans-serif;
      letter-spacing:.08em;
      text-shadow:0 2px 12px #fff;
    }
    /* –ò–≥—Ä–æ–≤–æ–π —Ç–µ–∫—Å—Ç —Å –æ—Ç—Å—Ç—É–ø–æ–º –≤–Ω–∏–∑ */
    #gameCoinsText {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 50px;
      font-family: 'Nunito', 'Arial', sans-serif;
      font-size: 1.28em;
      color: #fff;
      background: linear-gradient(90deg,#c186fd 0,#ffb5d1 100%);
      padding: 7px 30px;
      border-radius: 30px;
      font-weight: bold;
      box-shadow: 0 3px 16px #b8a8ee3a;
      border: 2px solid #fff;
      z-index: 12;
      text-shadow: 0 1px 10px #a2d2ff88, 0 1px 1px #fff7;
      user-select: none;
      pointer-events: none;
    }
    /* Responsive */
    @media (max-width: 600px) {
      .main-btn, #leaderboardBackBtn, #infoBackBtn, .popup-box button { font-size: 0.97em; padding:11px 12px;}
      .user-header img { width: 60px; height: 60px;}
      .popup-box {padding:22px 10vw;}
      #gameCoinsText { font-size: 1.05em; padding: 5px 15px;}
    }
    @media (max-width: 390px) {
      #coinsDisplay { font-size: 0.94em; padding: 7px 10px;}
      .user-meta div { font-size: 0.92em;}
      .user-header {padding:10px 7vw;}
      #gameCoinsText { font-size: 0.96em; }
    }
  </style>
</head>
<body>
  <!-- Main Menu -->
  <div id="mainMenu">
    <div class="menu-inner">
      <div class="tooltip">Collect coins and dodge enemies! ü™ô</div>
      <div class="user-header">
        <img id="userPhoto" src="" alt="Avatar" />
        <span id="userName">@User</span>
      </div>
      <div class="user-meta">
        <div id="yourPlace">Rank: ...</div>
        <div id="yourHighScore">Best: ...</div>
      </div>
      <div id="coinsDisplay"></div>
      <button id="startGameBtn" class="main-btn">Start Game</button>
      <button id="leaderboardBtn" class="main-btn">Leaderboard</button>
      <button id="infoBtn" class="main-btn">How to Play?</button>
    </div>
  </div>
  <!-- Game Screen -->
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="countdownOverlay"></div>
    <div id="gameCoinsText">Coins: 0</div>
  </div>
  <!-- Leaderboard -->
  <div id="leaderboardContainer">
    <div class="menu-inner">
      <button id="leaderboardBackBtn" class="main-btn" style="position:absolute;">Back</button>
      <h2 style="color:#7c46a3;text-align:center;margin:8px 0 0 0">Leaderboard</h2>
      <table>
        <thead>
          <tr><th>User</th><th>Best</th></tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>
  <!-- Info -->
  <div id="infoContainer">
    <div class="menu-inner">
      <button id="infoBackBtn" class="main-btn" style="position:absolute;">Back</button>
      <h2 style="color:#7c46a3;text-align:center;margin:5px 0 10px 0;">How to Play?</h2>
      <p>
        <b>Kirby</b> flies endlessly, collecting coins and dodging enemies.<br>
        If Kirby hits an enemy or falls ‚Äî the game is over.<br>
        <b>Controls:</b> Tap / Click or Space.<br>
        The goal is to collect as many coins as possible in one run!<br>
        <br>
        Your record is saved and displayed in the leaderboard. Good luck!
      </p>
    </div>
  </div>
  <!-- Game Over Popup -->
  <div id="gameOverPopup">
    <div class="menu-inner">
      <div class="popup-box">
        <h2>Game Over!</h2>
        <p id="gameOverText"></p>
        <button id="gameOverCloseBtn" class="main-btn">Back to Menu</button>
      </div>
    </div>
  </div>
  <script type="module">
    // Telegram WebApp
    const tg = window.Telegram.WebApp;
    if (typeof tg.requestFullscreen === 'function') tg.requestFullscreen();
    else tg.expand();

    // Firebase 9+
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM Elements
    const mainMenu = document.getElementById("mainMenu");
    const userPhoto = document.getElementById("userPhoto");
    const userName = document.getElementById("userName");
    const coinsDisplay = document.getElementById("coinsDisplay");
    const startGameBtn = document.getElementById("startGameBtn");
    const leaderboardBtn = document.getElementById("leaderboardBtn");
    const infoBtn = document.getElementById("infoBtn");
    const gameContainer = document.getElementById("gameContainer");
    const gameCanvas = document.getElementById("gameCanvas");
    const gameCoinsText = document.getElementById("gameCoinsText");
    const leaderboardContainer = document.getElementById("leaderboardContainer");
    const leaderboardBackBtn = document.getElementById("leaderboardBackBtn");
    const leaderboardBody = document.getElementById("leaderboardBody");
    const infoContainer = document.getElementById("infoContainer");
    const infoBackBtn = document.getElementById("infoBackBtn");
    const yourPlace = document.getElementById("yourPlace");
    const yourHighScore = document.getElementById("yourHighScore");
    const gameOverPopup = document.getElementById("gameOverPopup");
    const gameOverText = document.getElementById("gameOverText");
    const gameOverCloseBtn = document.getElementById("gameOverCloseBtn");
    const countdownOverlay = document.getElementById("countdownOverlay");

    // User
    let tgUser = tg.initDataUnsafe?.user;
    if (!tgUser) {
      mainMenu.innerHTML = "<h2>Please open in Telegram!</h2>";
      throw new Error("Not Telegram WebApp");
    }
    const userId = tgUser.id.toString();
    let highScore = 0;

    // Main UI Load
    async function loadUser() {
      userPhoto.src = tgUser.photo_url || "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png";
      userName.textContent = tgUser.username ? "@" + tgUser.username : "No username";
      const userRef = ref(db, `users/${userId}`);
      let snapshot = await get(userRef);
      if (!snapshot.exists()) {
        await set(userRef, {
          highScore: 0,
          username: tgUser.username || "",
          photo: tgUser.photo_url || ""
        });
        highScore = 0;
      } else {
        highScore = snapshot.val().highScore || 0;
      }
      coinsDisplay.textContent = `Best: ${highScore}`;
      yourHighScore.textContent = `Best: ${highScore}`;
      await updatePlace();
      mainMenu.style.display = "flex";
    }
    window.onload = loadUser;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Å—Ç–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –ª–∏–¥–µ—Ä–æ–≤
    async function updatePlace() {
      yourPlace.textContent = "Rank: ...";
      const usersRef = ref(db, "users/");
      const snapshot = await get(usersRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        const usersArray = Object.entries(data).map(([id, u]) => ({
          id, highScore: u.highScore || 0
        }));
        usersArray.sort((a, b) => b.highScore - a.highScore);
        const place = usersArray.findIndex(x => x.id === userId) + 1;
        if (place > 0) yourPlace.textContent = `Rank: ${place} of ${usersArray.length}`;
        else yourPlace.textContent = `Rank: ‚Äî`;
      }
    }

    // –ú–µ–Ω—é
    startGameBtn.onclick = () => { mainMenu.style.display = "none"; startGameWithCountdown(); };
    leaderboardBtn.onclick = () => { mainMenu.style.display = "none"; leaderboardContainer.style.display = "flex"; loadLeaderboard(); };
    infoBtn.onclick = () => { mainMenu.style.display = "none"; infoContainer.style.display = "flex"; };
    leaderboardBackBtn.onclick = () => { leaderboardContainer.style.display = "none"; mainMenu.style.display = "flex"; };
    infoBackBtn.onclick = () => { infoContainer.style.display = "none"; mainMenu.style.display = "flex"; };

    // –õ–∏–¥–µ—Ä—ã (—Ç–æ–ª—å–∫–æ –ø–æ Best/HighScore)
    async function loadLeaderboard() {
      leaderboardBody.innerHTML = "";
      const usersRef = ref(db, "users/");
      const snapshot = await get(usersRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        const usersArray = Object.entries(data).map(([id, u]) => ({
          username: u.username ? `@${u.username}` : "User " + id,
          highScore: u.highScore || 0,
        }));
        usersArray.sort((a, b) => b.highScore - a.highScore);
        usersArray.forEach(user => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${user.username}</td><td>${user.highScore}</td>`;
          leaderboardBody.appendChild(tr);
        });
      }
    }

    // Game Logic
    let ctx, animationId, isGameRunning = false;
    let canvasWidth = 0, canvasHeight = 0;
    // –£—Å–∫–æ—Ä–µ–Ω–Ω–∞—è —Ñ–∏–∑–∏–∫–∞ –∏ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥
    const BASE_GRAVITY = 0.46, BASE_LIFT = -8.3, BASE_SCROLL_SPEED = 2.7, BASE_MAX_FALL = 5;
    const player = {
      x: 100, y: 150, width: 45, height: 45, velocityY: 0,
      gravity: BASE_GRAVITY, lift: BASE_LIFT, alive: true, maxFallSpeed: BASE_MAX_FALL,
      el: null, rotating: false, rotAngle: 0
    };
    let scrollSpeed = BASE_SCROLL_SPEED;
    let enemies = [], enemyTimer = 0, enemyInterval = 110;
    const enemyGif = "https://i.pinimg.com/originals/4b/4f/a1/4b4fa16fff0d9782b6e53db976f89f78.gif";
    const enemyWidth = 80, enemyHeight = 80;
    let coins = [], coinTimer = 0, coinInterval = 65;
    const coinSize = 40, coinGifURL = "https://donatepay.ru/uploads/notification/images/830208_1664005822.gif";
    let scoreThisRun = 0, bgX = 0;
    const bgImage = new window.Image();
    bgImage.src = "https://i.pinimg.com/736x/20/e9/cf/20e9cf219337614640886180cc5d1c34.jpg";
    const collisionMargin = 10;
    let slowStart = true, showPlayer = false, deathFall = false, firstInput = false;
    // –°—Ç–∞—Ä—Ç —Å –æ—Ç—Å—á—ë—Ç–æ–º
    function startGameWithCountdown() {
      gameContainer.style.display = "block";
      gameOverPopup.style.display = "none";
      gameCoinsText.textContent = "Coins: 0";
      gameCoinsText.style.display = "block";
      ctx = gameCanvas.getContext("2d");
      resizeCanvas();
      scoreThisRun = 0;
      player.y = canvasHeight / 2;
      player.velocityY = 0;
      player.alive = true;
      player.rotating = false;
      player.rotAngle = 0;
      enemies = []; enemyTimer = 0;
      coins = []; coinTimer = 0;
      bgX = 0;
      deathFall = false;
      showPlayer = false;
      firstInput = false;
      if (!player.el) {
        const kirby = document.createElement("img");
        kirby.src = "kirby.gif";
        kirby.style.position = "absolute";
        kirby.style.width = player.width + "px";
        kirby.style.height = player.height + "px";
        kirby.style.left = player.x + "px";
        kirby.style.top = player.y + "px";
        kirby.style.zIndex = "900";
        kirby.draggable = false;
        gameContainer.appendChild(kirby);
        player.el = kirby;
      } else { player.el.style.display = "none"; }
      // Countdown: –ø–µ—Ä—Å–æ–Ω–∞–∂ —Å–∫—Ä—ã—Ç!
      let countdown = 3;
      countdownOverlay.style.display = "flex";
      countdownOverlay.textContent = countdown;
      let cdInt = setInterval(() => {
        countdown--;
        if (countdown === 0) {
          countdownOverlay.textContent = "GO!";
        } else if (countdown < 0) {
          countdownOverlay.style.display = "none";
          clearInterval(cdInt);
          showPlayer = true;
          player.el.style.display = "block";
          startGameCore();
        } else {
          countdownOverlay.textContent = countdown;
        }
      }, 900);
    }
    let slowStartFrame = 0;
    function startGameCore() {
      isGameRunning = true;
      slowStart = true;
      slowStartFrame = 0;
      player.gravity = BASE_GRAVITY;
      player.lift = BASE_LIFT;
      player.maxFallSpeed = BASE_MAX_FALL;
      scrollSpeed = BASE_SCROLL_SPEED;
      document.addEventListener("keydown", onKeyDown);
      document.addEventListener("mousedown", onClickOrTouch);
      document.addEventListener("touchstart", onClickOrTouch);
      animationId = requestAnimationFrame(updateGame);
      ticksAfterStart = 0;
    }
    function resizeCanvas() {
      canvasWidth = window.innerWidth;
      canvasHeight = window.innerHeight;
      gameCanvas.width = canvasWidth;
      gameCanvas.height = canvasHeight;
    }
    window.addEventListener("resize", () => { if (isGameRunning) resizeCanvas(); });
    let ticksAfterStart = 0;
    function updateGame() {
      if (!isGameRunning && !deathFall) return;
      ctx.clearRect(0, 0, canvasWidth, canvasHeight);
      drawScrollingBackground();
      if (showPlayer && player.el) player.el.style.display = "block";
      else if (player.el) player.el.style.display = "none";
      // –ù–∞–¥–ø–∏—Å—å Coins –≤ –∏–≥—Ä–µ
      gameCoinsText.textContent = "Coins: " + scoreThisRun;
      // ==== –û–°–ù–û–í–ù–û–ô GAME LOOP ====
      if (isGameRunning) {
        ticksAfterStart++;
        if (ticksAfterStart > 120) {
          enemyTimer++; if (enemyTimer > enemyInterval) { createEnemy(); enemyTimer = 0; }
        }
        coinTimer++; if (coinTimer > coinInterval) { createCoin(); coinTimer = 0; }
        for (let i = 0; i < enemies.length; i++) {
          const e = enemies[i];
          e.x -= scrollSpeed;
          e.el.style.left = e.x + "px"; e.el.style.top = e.y + "px";
          if (checkCollision(player, e)) { handleDeathAnimation(); return; }
        }
        enemies = enemies.filter(e => { if (e.x + e.width < 0) { gameContainer.removeChild(e.el); return false; } return true; });
        for (let i = 0; i < coins.length; i++) {
          const c = coins[i];
          c.x -= scrollSpeed;
          c.el.style.left = c.x + "px"; c.el.style.top = c.y + "px";
          if (checkCollision(player, c)) { scoreThisRun++; c.collected = true; }
        }
        coins = coins.filter(c => { if (c.collected || (c.x + c.size < 0)) { gameContainer.removeChild(c.el); return false; } return true; });
        updatePlayer();
        if (player.alive) { animationId = requestAnimationFrame(updateGame); }
      }
      // DeathFall
      if (deathFall) {
        updateDeathFall();
      }
    }
    function drawScrollingBackground() {
      bgX -= scrollSpeed;
      if (bgX <= -canvasWidth) { bgX = 0; }
      ctx.drawImage(bgImage, bgX, 0, canvasWidth, canvasHeight);
      ctx.drawImage(bgImage, bgX + canvasWidth, 0, canvasWidth, canvasHeight);
    }
    function createEnemy() {
      const randY = Math.random() * (canvasHeight - enemyHeight - 20) + 10;
      const enemyEl = document.createElement("img");
      enemyEl.src = enemyGif; enemyEl.style.position = "absolute";
      enemyEl.style.width = enemyWidth + "px"; enemyEl.style.height = enemyHeight + "px";
      enemyEl.style.left = canvasWidth + "px"; enemyEl.style.top = randY + "px";
      enemyEl.style.zIndex = "850"; enemyEl.draggable = false; gameContainer.appendChild(enemyEl);
      enemies.push({ x: canvasWidth, y: randY, width: enemyWidth, height: enemyHeight, el: enemyEl });
    }
    function createCoin() {
      const randY = Math.random() * (canvasHeight - coinSize - 20) + 10;
      const coinEl = document.createElement("img");
      coinEl.src = coinGifURL; coinEl.style.position = "absolute";
      coinEl.style.width = coinSize + "px"; coinEl.style.height = coinSize + "px";
      coinEl.style.left = canvasWidth + "px"; coinEl.style.top = randY + "px";
      coinEl.style.zIndex = "800"; coinEl.draggable = false; gameContainer.appendChild(coinEl);
      coins.push({ x: canvasWidth, y: randY, size: coinSize, collected: false, el: coinEl });
    }
    function updatePlayer() {
      // –¢–æ–ª—å–∫–æ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è ‚Äî slow –Ω–∞ —Å—Ç–∞—Ä—Ç–µ (—Ñ–æ–Ω –∏ –≤—Ä–∞–≥–∏ –æ–±—ã—á–Ω—ã–µ)
      let gravity = slowStart ? 0.14 : BASE_GRAVITY;
      if (slowStart) {
        slowStartFrame++;
        if (slowStartFrame > 72) slowStart = false;
      }
      player.velocityY += gravity;
      if (player.velocityY > player.maxFallSpeed) player.velocityY = player.maxFallSpeed;
      player.y += player.velocityY;
      if (player.y < 0) { player.y = 0; player.velocityY = 0; }
      if (player.y + player.height > canvasHeight) { handleDeathAnimation(); }
      player.el.style.left = player.x + "px";
      player.el.style.top = player.y + "px";
      player.el.style.transform = player.rotating ? `rotate(${player.rotAngle}deg)` : "none";
    }
    function onKeyDown(e) { if (e.code === "Space") doFlap(); }
    function onClickOrTouch() { doFlap(); }
    function doFlap() {
      if (!player.alive) return;
      // –ü–µ—Ä–≤—ã–π —Ç–∞–ø ‚Äî –±–µ–∑ boost (—Ñ–∏–∫—Å–∏–º "—Å–∏–ª—å–Ω—ã–π –ø–µ—Ä–≤—ã–π –ø—Ä—ã–∂–æ–∫")
      if (!firstInput) {
        firstInput = true;
        return;
      }
      player.velocityY = player.lift;
      player.el.style.filter = "drop-shadow(0 0 14px #ffcbf9)";
      setTimeout(() => player.el.style.filter = "none", 120);
    }
    function checkCollision(pl, obj) {
      const pr = { x: pl.x + collisionMargin, y: pl.y + collisionMargin, width: pl.width - collisionMargin * 2, height: pl.height - collisionMargin * 2 };
      const ow = (obj.width  || obj.size) - collisionMargin * 2;
      const oh = (obj.height || obj.size) - collisionMargin * 2;
      const or = { x: obj.x + collisionMargin, y: obj.y + collisionMargin, width:  ow > 0 ? ow : 0, height: oh > 0 ? oh : 0 };
      return !(
        or.x > pr.x + pr.width ||
        or.x + or.width < pr.x ||
        or.y > pr.y + pr.height ||
        or.y + or.height < pr.y
      );
    }
    // Death animation
    function handleDeathAnimation() {
      if (!player.alive) return;
      player.alive = false;
      isGameRunning = false;
      deathFall = true;
      document.removeEventListener("keydown", onKeyDown);
      document.removeEventListener("mousedown", onClickOrTouch);
      document.removeEventListener("touchstart", onClickOrTouch);
      player.rotating = true;
      player.rotAngle = 90;
      player.velocityY = 7;
      animationId = requestAnimationFrame(updateGame);
    }
    function updateDeathFall() {
      player.y += player.velocityY;
      player.velocityY += 0.53;
      if (player.el) {
        player.el.style.top = player.y + "px";
        player.el.style.transform = `rotate(90deg)`;
      }
      if (player.y > canvasHeight + player.height) {
        deathFall = false;
        gameCoinsText.style.display = "none";
        showGameOverSequence();
      } else {
        requestAnimationFrame(updateGame);
      }
    }
    function showGameOverSequence() {
      let newHigh = false;
      if (scoreThisRun > highScore) {
        highScore = scoreThisRun;
        newHigh = true;
      }
      updateScoreInDB(newHigh, scoreThisRun);
      let popupText = `You collected <b>${scoreThisRun}</b> coins.<br>`;
      if (newHigh) popupText += "<span style='color:#b13df3'>NEW RECORD!</span><br>";
      popupText += `Your best: <b>${highScore}</b>`;
      setTimeout(() => showGameOverPopup(popupText), 400);
    }
    function showGameOverPopup(html) {
      gameOverText.innerHTML = html;
      gameOverPopup.style.display = "flex";
    }
    gameOverCloseBtn.onclick = endGameAndReturn;
    function endGameAndReturn() {
      if (isGameRunning || deathFall) {
        cancelAnimationFrame(animationId);
        document.removeEventListener("keydown", onKeyDown);
        document.removeEventListener("mousedown", onClickOrTouch);
        document.removeEventListener("touchstart", onClickOrTouch);
        isGameRunning = false;
        deathFall = false;
      }
      if (player.el) player.el.style.display = "none";
      for (const e of enemies) if (e.el) gameContainer.removeChild(e.el);
      enemies = [];
      for (const c of coins) if (c.el) gameContainer.removeChild(c.el);
      coins = [];
      gameContainer.style.display = "none";
      gameOverPopup.style.display = "none";
      coinsDisplay.textContent = `Best: ${highScore}`;
      yourHighScore.textContent = `Best: ${highScore}`;
      updatePlace();
      mainMenu.style.display = "flex";
      ticksAfterStart = 0;
      gameCoinsText.style.display = "none";
    }
    async function updateScoreInDB(isNewHigh, latestScore) {
      const userRef = ref(db, `users/${userId}`);
      let updateData = {};
      if (isNewHigh) updateData.highScore = latestScore;
      await update(userRef, updateData);
      coinsDisplay.textContent = `Best: ${highScore}`;
      yourHighScore.textContent = `Best: ${highScore}`;
    }
  </script>
</body>
</html>
