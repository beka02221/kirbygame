<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Galaxy Ton Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Nunito:800,700,600,400|Poppins:600,400&display=swap" rel="stylesheet">
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; background: #12082e; overflow: hidden; }
    #gameCanvas { display: block; margin: 0 auto; background: #161642; }
    #ui { position: fixed; left:0; top:0; width:100vw; height:100vh; pointer-events:none; z-index:10; }
    #coinsUI {
      position: absolute; left: 50%; transform: translateX(-50%);
      top: 50px; font-family: 'Nunito',sans-serif; font-weight: 900;
      font-size: 2em; color: #fff; background:rgba(60,40,100,.16);
      padding: 14px 32px; border-radius: 18px; text-shadow: 0 2px 8px #0009;
      box-shadow: 0 2px 10px #5e4cff1a; letter-spacing: 0.08em; user-select: none;
    }
    #menuOverlay, #leaderboardOverlay, #infoOverlay, #gameOverPopup {
      position: absolute; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(18,8,46,0.97); color: #fff; z-index: 20;
      display: none; flex-direction: column; align-items: center;
      font-family: 'Nunito',sans-serif; font-weight: 800;
      padding-top: 80px;
    }
    #menuOverlay .user-header {
      display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; gap: 6px;
      background: rgba(255,255,255,0.12); border-radius: 18px; box-shadow: 0 4px 16px #c8a2c866; padding: 18px 32px 15px 32px;
    }
    #menuOverlay .user-header img {
      width: 74px; height: 74px; border-radius: 50%; border:4px solid #fff;
      box-shadow: 0 4px 24px 0 #a2d2ff61; background: #fff; margin-bottom: 4px;
    }
    #menuOverlay .user-header span {
      font-size: 1.12em; color: #4b3570; font-weight: 700; text-shadow: 0 2px 4px #eee;
      max-width: 200px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; letter-spacing: .01em;
    }
    .user-meta { display: flex; flex-direction: row; gap: 10px; margin-bottom: 18px; align-items: center; width: 100%; justify-content: center; }
    .user-meta div {
      font-size: 1.01em; color: #44335b; background: #fff9; border-radius: 13px;
      padding: 5px 18px; margin: 2px 0; box-shadow: 0 2px 8px #a2d2ff1a; min-width: 90px; text-align: center; font-weight: 600;
    }
    .main-btn {
      margin: 18px 0; padding: 17px 42px; font-size: 1.15em;
      background: linear-gradient(90deg, #5f6cff 0%, #8b70fd 100%);
      border: none; border-radius: 29px; box-shadow: 0 3px 16px #a2d2ff4d, 0 1px 1px #fff;
      cursor: pointer; font-weight: 700; color: #fff; transition: 0.16s; display: block;
    }
    .main-btn:hover { background: linear-gradient(90deg, #8b70fd 20%, #5f6cff 100%); transform: scale(1.06);}
    .main-btn:active { transform: scale(0.97);}
    #leaderboardOverlay, #infoOverlay, #gameOverPopup {padding-top:80px;}
    #leaderboardOverlay h2 {margin-bottom: 12px;}
    #leaderboardBackBtn, #infoBackBtn {
      position: absolute; top: 40px; left: 24px; padding: 13px 35px;
      background: linear-gradient(90deg, #6a6aff 0%, #d1eaff 100%);
      border: none; border-radius: 22px; font-size: 1.04em; font-weight: 700; color: #4e3888;
      cursor: pointer; box-shadow: 0 3px 0 #c8a2c8, 0 2px 8px #ffdbf933; z-index: 99; transition: background 0.22s;
    }
    #leaderboardBackBtn:hover, #infoBackBtn:hover {
      background: linear-gradient(90deg, #8b70fd 0, #5f6cff 100%); color: #fff;
    }
    table { width: 93vw; max-width: 530px; margin: 15px auto 0 auto; background: #fff2; border-radius: 18px; box-shadow: 0 4px 18px 0 #c2a4ff29;}
    th, td { padding: 15px 10px; text-align: left; font-size: 1.07em;}
    th { background: #8b70fd; color: #fff; border-radius: 12px 12px 0 0;}
    tr:nth-child(odd) { background: #201344; color:#fff;}
    tr:nth-child(even) { background: #23245e; color:#fff;}
    #infoOverlay p { font-size: 1.10em; color: #d6e1ff; background: #fff1; border-radius: 12px; padding: 16px 20px; margin-top: 0;}
    #gameOverPopup .popup-box {
      background: linear-gradient(120deg, #fff 63%, #ffe3fa 100%);
      border-radius: 32px; padding: 38px 36px 32px 36px; min-width: 240px; box-shadow: 0 8px 30px #e3caff88;
      display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 80px;
    }
    .popup-box h2 { margin:0 0 8px 0; color: #8b70fd; font-size: 1.23em;}
    .popup-box p { color: #47366b; font-size: 1.09em; margin: 0; }
    .popup-box button { margin-top: 9px; padding: 13px 32px; background: linear-gradient(90deg,#5f6cff 0,#8b70fd 100%); border-radius: 20px; border: none; color: #fff; font-weight: 700; font-size: 1.09em; box-shadow: 0 2px 12px #a2d2ff3b; cursor: pointer; transition: background 0.14s; }
    .popup-box button:active { transform:scale(.96);}
    #countdownOverlay {
      display:none;position:absolute;top:0;left:0;width:100vw;height:100vh;z-index:222;
      align-items:center;justify-content:center;
      background:rgba(20,16,44,0.92);
      font-size:3em;color:#8b70fd;font-weight:900;
      font-family:'Nunito',sans-serif;letter-spacing:.08em;text-shadow:0 2px 16px #fff7;
    }
    @media (max-width: 600px) {
      #menuOverlay .user-header img {width:54px;height:54px;}
      .main-btn, #leaderboardBackBtn, #infoBackBtn { font-size: 1em; padding:11px 12px;}
      #coinsUI { font-size:1.13em;padding:9px 14px;}
    }
    @media (max-width: 390px) {
      .user-meta div { font-size: 0.92em;}
      #coinsUI { font-size: 0.95em;}
      #menuOverlay .user-header {padding:10px 7vw;}
    }
  </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="ui">
  <div id="coinsUI">Coins: 0</div>
  <div id="countdownOverlay"></div>
  <div id="menuOverlay">
    <div style="font-size:1.34em;margin-bottom:20px;color:#8b70fd;">GALAXY TON mini-game</div>
    <div class="user-header">
      <img id="userPhoto" src="" alt="Avatar" />
      <span id="userName">@User</span>
    </div>
    <div class="user-meta">
      <div id="yourPlace">Rank: ...</div>
      <div id="yourHighScore">Best: ...</div>
    </div>
    <div id="menuCoinsDisplay"></div>
    <button id="startGameBtn" class="main-btn">Start Game</button>
    <button id="leaderboardBtn" class="main-btn">Leaderboard</button>
    <button id="infoBtn" class="main-btn">How to Play?</button>
  </div>
  <div id="leaderboardOverlay">
    <button id="leaderboardBackBtn" class="main-btn" style="position:absolute;">Back</button>
    <h2 style="color:#8b70fd;text-align:center;margin:8px 0 0 0">Leaderboard</h2>
    <table>
      <thead>
        <tr><th>User</th><th>Best</th></tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>
  <div id="infoOverlay">
    <button id="infoBackBtn" class="main-btn" style="position:absolute;">Back</button>
    <h2 style="color:#8b70fd;text-align:center;margin:5px 0 10px 0;">How to Play?</h2>
    <p>
      <b>Kirby</b> flies through Galaxy Ton, collecting coins and dodging asteroids.<br>
      If you hit an asteroid or fall — game over.<br>
      <b>Controls:</b> Tap/click or press Space.<br>
      Your record is saved and shown in the leaderboard. Good luck!
    </p>
  </div>
  <div id="gameOverPopup">
    <div class="popup-box">
      <h2>Game Over!</h2>
      <p id="gameOverText"></p>
      <button id="gameOverCloseBtn" class="main-btn">Back to Menu</button>
    </div>
  </div>
</div>
<script type="module">
  // Telegram WebApp
  const tg = window.Telegram.WebApp;
  if (typeof tg.requestFullscreen === 'function') tg.requestFullscreen();
  else tg.expand();

  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
  import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
  const firebaseConfig = {
    apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
    authDomain: "test-with-likes.firebaseapp.com",
    databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
    projectId: "test-with-likes",
    storageBucket: "test-with-likes.appspot.com",
    messagingSenderId: "764738820142",
    appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
    measurementId: "G-WJNF0HSN9P"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // DOM
  const mainMenu = document.getElementById("menuOverlay");
  const userPhoto = document.getElementById("userPhoto");
  const userName = document.getElementById("userName");
  const menuCoinsDisplay = document.getElementById("menuCoinsDisplay");
  const startGameBtn = document.getElementById("startGameBtn");
  const leaderboardBtn = document.getElementById("leaderboardBtn");
  const infoBtn = document.getElementById("infoBtn");
  const leaderboardOverlay = document.getElementById("leaderboardOverlay");
  const leaderboardBackBtn = document.getElementById("leaderboardBackBtn");
  const leaderboardBody = document.getElementById("leaderboardBody");
  const infoOverlay = document.getElementById("infoOverlay");
  const infoBackBtn = document.getElementById("infoBackBtn");
  const yourPlace = document.getElementById("yourPlace");
  const yourHighScore = document.getElementById("yourHighScore");
  const gameOverPopup = document.getElementById("gameOverPopup");
  const gameOverText = document.getElementById("gameOverText");
  const gameOverCloseBtn = document.getElementById("gameOverCloseBtn");
  const coinsUI = document.getElementById("coinsUI");
  const countdownOverlay = document.getElementById("countdownOverlay");

  // Telegram User
  let tgUser = tg.initDataUnsafe?.user;
  if (!tgUser) {
    mainMenu.innerHTML = "<h2>Please open in Telegram!</h2>";
    throw new Error("Not Telegram WebApp");
  }
  const userId = tgUser.id.toString();
  let highScore = 0;

  // Load User Info
  async function loadUser() {
    userPhoto.src = tgUser.photo_url || "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png";
    userName.textContent = tgUser.username ? "@" + tgUser.username : "No username";
    const userRef = ref(db, `users/${userId}`);
    let snapshot = await get(userRef);
    if (!snapshot.exists()) {
      await set(userRef, {
        highScore: 0,
        username: tgUser.username || "",
        photo: tgUser.photo_url || ""
      });
      highScore = 0;
    } else {
      highScore = snapshot.val().highScore || 0;
    }
    menuCoinsDisplay.textContent = `Best: ${highScore}`;
    yourHighScore.textContent = `Best: ${highScore}`;
    await updatePlace();
    mainMenu.style.display = "flex";
  }
  window.onload = loadUser;
  async function updatePlace() {
    yourPlace.textContent = "Rank: ...";
    const usersRef = ref(db, "users/");
    const snapshot = await get(usersRef);
    if (snapshot.exists()) {
      const data = snapshot.val();
      const usersArray = Object.entries(data).map(([id, u]) => ({
        id, highScore: u.highScore || 0
      }));
      usersArray.sort((a, b) => b.highScore - a.highScore);
      const place = usersArray.findIndex(x => x.id === userId) + 1;
      if (place > 0) yourPlace.textContent = `Rank: ${place} of ${usersArray.length}`;
      else yourPlace.textContent = `Rank: —`;
    }
  }

  // Меню
  startGameBtn.onclick = () => { mainMenu.style.display = "none"; startGameWithCountdown(); };
  leaderboardBtn.onclick = () => { mainMenu.style.display = "none"; leaderboardOverlay.style.display = "flex"; loadLeaderboard(); };
  infoBtn.onclick = () => { mainMenu.style.display = "none"; infoOverlay.style.display = "flex"; };
  leaderboardBackBtn.onclick = () => { leaderboardOverlay.style.display = "none"; mainMenu.style.display = "flex"; };
  infoBackBtn.onclick = () => { infoOverlay.style.display = "none"; mainMenu.style.display = "flex"; };
  async function loadLeaderboard() {
    leaderboardBody.innerHTML = "";
    const usersRef = ref(db, "users/");
    const snapshot = await get(usersRef);
    if (snapshot.exists()) {
      const data = snapshot.val();
      const usersArray = Object.entries(data).map(([id, u]) => ({
        username: u.username ? `@${u.username}` : "User " + id,
        highScore: u.highScore || 0,
      }));
      usersArray.sort((a, b) => b.highScore - a.highScore);
      usersArray.forEach(user => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${user.username}</td><td>${user.highScore}</td>`;
        leaderboardBody.appendChild(tr);
      });
    }
  }

  // ============= GAME CORE LOGIC ===============
  // Canvas adaptive, retina
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  function resizeCanvas() {
    const logicalWidth = 480, logicalHeight = 720;
    const dpr = window.devicePixelRatio || 1;
    canvas.width = logicalWidth * dpr;
    canvas.height = logicalHeight * dpr;
    canvas.style.width = logicalWidth + 'px';
    canvas.style.height = logicalHeight + 'px';
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);
    return { w: logicalWidth, h: logicalHeight };
  }
  let GAME = resizeCanvas();
  window.addEventListener('resize',()=>{ GAME=resizeCanvas(); });

  // Game objects and settings
  const player = {
    x: 80, y: 300, vy: 0, w: 44, h: 44, gravity: 1300, jumpPower: -410, alive: true, img: null, deadFall: false
  };
  player.img = new window.Image();
  player.img.src = "https://raw.githubusercontent.com/qnexst/404token/main/kirby.gif";
  const coinImg = new window.Image();
  coinImg.src = "https://donatepay.ru/uploads/notification/images/830208_1664005822.gif";
  let coinsArr = [];
  let enemies = [];
  let coins = 0, state = 'wait', last = null, ticksAfterStart = 0;
  let bgOffset = 0;
  // For countdown at start
  function startGameWithCountdown() {
    state = 'countdown';
    countdownOverlay.style.display = "flex";
    let countdown = 3;
    countdownOverlay.textContent = countdown;
    let cdInt = setInterval(() => {
      countdown--;
      if (countdown === 0) {
        countdownOverlay.textContent = "GO!";
      } else if (countdown < 0) {
        countdownOverlay.style.display = "none";
        clearInterval(cdInt);
        startGameCore();
      } else {
        countdownOverlay.textContent = countdown;
      }
    }, 900);
  }
  function startGameCore() {
    state = "run";
    coins = 0; coinsArr = []; enemies = []; ticksAfterStart = 0; bgOffset = 0;
    player.x=80; player.y=300; player.vy=0; player.alive=true; player.deadFall=false; player.gravity=1300;
    coinsUI.textContent = "Coins: 0";
  }
  function spawnEnemy() {
    const h = 48 + Math.random()*32;
    enemies.push({
      x: GAME.w+40, y: Math.random()*(GAME.h-h-120)+60,
      w: h, h: h, speed: 240 + Math.random()*70
    });
  }
  function spawnCoin() {
    coinsArr.push({
      x: GAME.w+30, y: Math.random()*(GAME.h-110)+60,
      size: 38, speed: 180
    });
  }
  function gameUpdate(dt) {
    ticksAfterStart++;
    // === ENEMIES
    for(const e of enemies) e.x -= e.speed * dt;
    if(enemies.length<2 && Math.random()<dt*1.4) spawnEnemy();
    while(enemies.length && enemies[0].x+enemies[0].w<0) enemies.shift();
    // === COINS
    for(const c of coinsArr) c.x -= c.speed * dt;
    if(coinsArr.length<2 && Math.random()<dt*1.1) spawnCoin();
    while(coinsArr.length && coinsArr[0].x+coinsArr[0].size<0) coinsArr.shift();
    // === PLAYER
    if(player.deadFall) {
      player.vy += player.gravity*dt;
      player.y += player.vy*dt;
      if(player.y>GAME.h) setTimeout(()=>showGameOverPopupSeq(),420);
      return;
    }
    let slowFall = ticksAfterStart < 65;
    let grav = slowFall ? 0.14*player.gravity : player.gravity;
    player.vy += grav*dt;
    player.y += player.vy*dt;
    if(player.y>GAME.h-player.h) {
      player.y=GAME.h-player.h;
      gameOver();
    }
    // COIN COLLISION
    for(const c of coinsArr) {
      if(Math.abs((player.x+player.w/2)-(c.x+c.size/2))<32 && Math.abs((player.y+player.h/2)-(c.y+c.size/2))<32) {
        coins++; c.x = -1000;
      }
    }
    // ENEMY COLLISION
    for(const e of enemies) {
      if(Math.abs((player.x+player.w/2)-(e.x+e.w/2))<(player.w+e.w)/2-8 && Math.abs((player.y+player.h/2)-(e.y+e.h/2))<(player.h+e.h)/2-8) {
        player.deadFall = true; player.vy = 120; player.gravity = 1800;
      }
    }
    coinsUI.textContent = "Coins: " + coins;
  }
  function drawBG(dt) {
    bgOffset -= 72 * dt; if(bgOffset < -GAME.w) bgOffset += GAME.w;
    ctx.fillStyle = "#201344";
    ctx.fillRect(0,0,GAME.w,GAME.h);
    // Stars
    ctx.save();
    ctx.globalAlpha = 0.38;
    for(let i=0;i<64;i++) {
      ctx.beginPath();
      ctx.arc((i*71+Math.floor(bgOffset))%GAME.w, (i*29)%GAME.h, 1.2, 0, 7);
      ctx.fillStyle = "#fff";
      ctx.fill();
    }
    ctx.restore();
  }
  function drawGame(dt) {
    for(const c of coinsArr) ctx.drawImage(coinImg, c.x, c.y, c.size, c.size);
    for(const e of enemies) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(e.x+e.w/2, e.y+e.h/2, e.w/2, 0, 7);
      ctx.fillStyle="#3918be"; ctx.shadowColor="#fff"; ctx.shadowBlur=9; ctx.fill();
      ctx.restore();
    }
    ctx.save();
    if(player.deadFall) {
      ctx.translate(player.x+player.w/2, player.y+player.h/2);
      ctx.rotate(Math.PI/2);
      ctx.drawImage(player.img, -player.w/2, -player.h/2, player.w, player.h);
    } else {
      ctx.drawImage(player.img, player.x, player.y, player.w, player.h);
    }
    ctx.restore();
  }
  function gameOver() { player.deadFall=true; }
  function showGameOverPopupSeq() {
    state = "gameover";
    let newHigh = false;
    if (coins > highScore) { highScore = coins; newHigh = true; }
    updateScoreInDB(newHigh, coins);
    let popupText = `You collected <b>${coins}</b> coins.<br>`;
    if (newHigh) popupText += "<span style='color:#8b70fd'>NEW RECORD!</span><br>";
    popupText += `Your best: <b>${highScore}</b>`;
    coinsUI.textContent = "Coins: 0";
    gameOverText.innerHTML = popupText;
    gameOverPopup.style.display = "flex";
  }
  gameOverCloseBtn.onclick = () => {
    gameOverPopup.style.display = "none";
    mainMenu.style.display = "flex";
    menuCoinsDisplay.textContent = `Best: ${highScore}`;
    yourHighScore.textContent = `Best: ${highScore}`;
    updatePlace();
    state = "wait";
  };
  async function updateScoreInDB(isNewHigh, latestScore) {
    const userRef = ref(db, `users/${userId}`);
    let updateData = {};
    if (isNewHigh) updateData.highScore = latestScore;
    await update(userRef, updateData);
    menuCoinsDisplay.textContent = `Best: ${highScore}`;
    yourHighScore.textContent = `Best: ${highScore}`;
  }

  // Контролы
  window.addEventListener('keydown',e=>{
    if(state!=="run") return;
    if(e.code==="Space" || e.code==="ArrowUp") {
      if(!player.deadFall) player.vy = player.jumpPower;
    }
  });
  window.addEventListener('mousedown',()=>{ if(state==="run" && !player.deadFall) player.vy = player.jumpPower; });
  window.addEventListener('touchstart',()=>{ if(state==="run" && !player.deadFall) player.vy = player.jumpPower; });

  // Main loop
  function loop(ts) {
    if(!last) last = ts;
    let dt = (ts-last)/1000;
    if(dt > 0.08) dt = 0.08;
    last = ts;
    if(state==="run") gameUpdate(dt);
    drawBG(dt);
    if(state==="run"||state==="gameover") drawGame(dt);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
</script>
</body>
</html>
