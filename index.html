<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Floppy Kirby â€” Telegram WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Nunito:800,700,600,400|Poppins:600,400&display=swap" rel="stylesheet">
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; font-family:'Nunito','Poppins','Open Sans',sans-serif; background:#f7f4ff; overflow:hidden; user-select:none;}
    #mainMenu, #leaderboardContainer, #infoContainer, #gameOverPopup {
      width:100vw;height:100vh;display:none;position:fixed;top:0;left:0;
      flex-direction:column;align-items:center;justify-content:flex-start;
      background:linear-gradient(120deg,#a2d2ff 0%,#ffe7f3 100%);
      overflow-y:auto;padding:0!important;
    }
    #mainMenu .menu-inner,
    #leaderboardContainer .menu-inner,
    #infoContainer .menu-inner,
    #gameOverPopup .menu-inner {
      margin-top:80px;width:100%;display:flex;flex-direction:column;align-items:center;
    }
    #gameContainer {width:100vw;height:100vh;display:none;position:fixed;top:0;left:0;background:#fff;z-index:20;overflow:hidden;}
    #gameHudCoins {position:absolute;top:50px;left:50%;transform:translateX(-50%);font-size:2em;font-weight:900;color:#fff;background:linear-gradient(90deg,#b07cff 0,#ffb5d1 100%);padding:10px 32px;border-radius:28px;box-shadow:0 6px 28px #c2a4ff22;text-shadow:0 2px 6px #a2d2ffb2;border:2px solid #fff;pointer-events:none;z-index:110;letter-spacing:.02em;font-family:'Nunito','Poppins',sans-serif;transition:background 0.28s;user-select:none;}
    .tooltip {margin-bottom:22px;background:#fff4;color:#7e47a8;font-size:1.13em;padding:9px 22px;border-radius:20px;box-shadow:0 8px 22px #b8d8fa36;letter-spacing:.03em;transition:background 0.3s;max-width:90vw;text-align:center;}
    .user-header {display:flex;flex-direction:column;align-items:center;margin-bottom:20px;gap:6px;background:rgba(255,255,255,0.63);border-radius:18px;box-shadow:0 4px 16px #c8a2c866;padding:18px 32px 15px 32px;}
    .user-header img {width:72px;height:72px;border-radius:50%;border:3.5px solid #fff;box-shadow:0 4px 24px 0 #a2d2ff61;background:#fff;margin-bottom:3px;object-fit:cover;}
    .user-header span {font-size:1.14em;color:#4b3570;font-weight:700;text-shadow:0 2px 4px #eee;max-width:200px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;letter-spacing:.01em;}
    .user-meta {display:flex;flex-direction:row;gap:10px;margin-bottom:18px;align-items:center;width:100%;justify-content:center;}
    .user-meta div {font-size:1.01em;color:#44335b;background:#fff9;border-radius:13px;padding:5px 18px;margin:2px 0;box-shadow:0 2px 8px #a2d2ff1a;min-width:90px;text-align:center;font-weight:600;}
    #coinsDisplay {color:#fff;background:linear-gradient(90deg,#c186fd 0,#ffb5d1 100%);font-size:1.12em;font-weight:700;margin-bottom:16px;padding:8px 24px;border-radius:30px;box-shadow:0 3px 12px #c2a4ff1a;text-shadow:0 2px 2px #fff9;border:2px solid #fff;letter-spacing:.04em;display:inline-block;}
    .main-btn {margin:14px 0;padding:15px 36px;font-size:1.15em;background:linear-gradient(90deg,#f7c8e0 0%,#b6eaff 100%);border:none;border-radius:29px;box-shadow:0 3px 16px #a2d2ff4d,0 1px 1px #fff;cursor:pointer;font-weight:700;color:#493a66;transition:0.16s;display:block;}
    .main-btn:hover {background:linear-gradient(90deg,#ffc0cb 10%,#a2d2ff 100%);transform:scale(1.06);}
    .main-btn:active {transform:scale(0.96);}
    #leaderboardBackBtn, #infoBackBtn {position:absolute;top:40px;left:24px;padding:11px 30px;background:linear-gradient(90deg,#f8daea 0%,#d1eaff 100%);border:none;border-radius:22px;font-size:1.04em;font-weight:700;color:#4e3888;cursor:pointer;box-shadow:0 3px 0 #c8a2c8,0 2px 8px #ffdbf933;z-index:99;transition:background 0.22s;}
    #leaderboardBackBtn:hover, #infoBackBtn:hover {background:linear-gradient(90deg,#c186fd 0,#ffb5d1 100%);color:#fff;}
    #infoContainer p {font-size:1.10em;color:#493A64;background:#fff7;border-radius:12px;padding:10px 14px;margin-top:0;}
    #gameOverPopup {z-index:999;display:none;align-items:center;justify-content:center;background:rgba(60,30,80,0.42);animation:fadeIn 0.23s;}
    .popup-box {background:linear-gradient(120deg,#fff 63%,#ffe3fa 100%);border-radius:32px;padding:34px 36px 28px 36px;min-width:240px;box-shadow:0 8px 30px #e3caff88;display:flex;flex-direction:column;align-items:center;gap:18px;margin-top:80px;}
    .popup-box h2 {margin:0 0 8px 0;color:#9857d3;font-size:1.23em;}
    .popup-box p {color:#47366b;font-size:1.07em;margin:0;}
    .popup-box button {margin-top:5px;padding:13px 32px;background:linear-gradient(90deg,#f7c8e0 0,#b6eaff 100%);border-radius:20px;border:none;color:#44335b;font-weight:700;font-size:1.09em;box-shadow:0 2px 12px #a2d2ff3b;cursor:pointer;transition:background 0.14s;display:block;}
    .popup-box button#gameOverCloseBtn {display:block;}
    #countdownOverlay {display:none;position:absolute;top:0;left:0;width:100vw;height:100vh;z-index:222;align-items:center;justify-content:center;background:rgba(248,245,255,0.78);font-size:3em;color:#9857d3;font-weight:900;font-family:'Nunito',sans-serif;letter-spacing:.08em;text-shadow:0 2px 12px #fff;}
    @media (max-width:600px){.main-btn,#leaderboardBackBtn,#infoBackBtn,.popup-box button{font-size:0.97em;padding:11px 12px;}.user-header img{width:60px;height:60px;}.popup-box{padding:22px 10vw;}#gameHudCoins{font-size:1.3em;padding:7px 10vw;}}
    @media (max-width:390px){#coinsDisplay{font-size:0.94em;padding:7px 10px;}.user-meta div{font-size:0.92em;}.user-header{padding:10px 7vw;}#gameHudCoins{font-size:1.12em;padding:7px 4vw;}}
  </style>
</head>
<body>
  <!-- Main Menu -->
  <div id="mainMenu">
    <div class="menu-inner">
      <div class="tooltip">Collect coins and dodge enemies! ðŸª™</div>
      <div class="user-header">
        <img id="userPhoto" src="" alt="Avatar" />
        <span id="userName">@User</span>
      </div>
      <div class="user-meta">
        <div id="yourPlace">Rank: ...</div>
        <div id="yourHighScore">Best: ...</div>
      </div>
      <div id="coinsDisplay"></div>
      <button id="startGameBtn" class="main-btn">Start Game</button>
      <button id="leaderboardBtn" class="main-btn">Leaderboard</button>
      <button id="infoBtn" class="main-btn">How to Play?</button>
    </div>
  </div>
  <!-- Game Screen -->
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="gameHudCoins" style="display:none;">Coins: 0</div>
    <div id="countdownOverlay"></div>
  </div>
  <!-- Leaderboard -->
  <div id="leaderboardContainer">
    <div class="menu-inner">
      <button id="leaderboardBackBtn" class="main-btn" style="position:absolute;">Back</button>
      <h2 style="color:#7c46a3;text-align:center;margin:8px 0 0 0">Leaderboard</h2>
      <table>
        <thead>
          <tr><th>User</th><th>Best</th></tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>
  <!-- Info -->
  <div id="infoContainer">
    <div class="menu-inner">
      <button id="infoBackBtn" class="main-btn" style="position:absolute;">Back</button>
      <h2 style="color:#7c46a3;text-align:center;margin:5px 0 10px 0;">How to Play?</h2>
      <p>
        <b>Kirby</b> flies endlessly, collecting coins and dodging enemies.<br>
        If Kirby hits an enemy or falls â€” the game is over.<br>
        <b>Controls:</b> Tap / Click or Space.<br>
        The goal is to collect as many coins as possible in one run!<br>
        <br>
        Your record is saved and displayed in the leaderboard. Good luck!
      </p>
    </div>
  </div>
  <!-- Game Over Popup -->
  <div id="gameOverPopup">
    <div class="menu-inner">
      <div class="popup-box">
        <h2>Game Over!</h2>
        <p id="gameOverText"></p>
        <button id="gameOverCloseBtn" class="main-btn">Back to Menu</button>
      </div>
    </div>
  </div>
  <script type="module">
    // Telegram WebApp
    const tg = window.Telegram.WebApp;
    if (typeof tg.requestFullscreen === 'function') tg.requestFullscreen();
    else tg.expand();
    // Firebase 9+
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    // DOM Elements
    const mainMenu = document.getElementById("mainMenu");
    const userPhoto = document.getElementById("userPhoto");
    const userName = document.getElementById("userName");
    const coinsDisplay = document.getElementById("coinsDisplay");
    const startGameBtn = document.getElementById("startGameBtn");
    const leaderboardBtn = document.getElementById("leaderboardBtn");
    const infoBtn = document.getElementById("infoBtn");
    const gameContainer = document.getElementById("gameContainer");
    const gameCanvas = document.getElementById("gameCanvas");
    const leaderboardContainer = document.getElementById("leaderboardContainer");
    const leaderboardBackBtn = document.getElementById("leaderboardBackBtn");
    const leaderboardBody = document.getElementById("leaderboardBody");
    const infoContainer = document.getElementById("infoContainer");
    const infoBackBtn = document.getElementById("infoBackBtn");
    const yourPlace = document.getElementById("yourPlace");
    const yourHighScore = document.getElementById("yourHighScore");
    const gameOverPopup = document.getElementById("gameOverPopup");
    const gameOverText = document.getElementById("gameOverText");
    const gameOverCloseBtn = document.getElementById("gameOverCloseBtn");
    const countdownOverlay = document.getElementById("countdownOverlay");
    const gameHudCoins = document.getElementById("gameHudCoins");
    // User
    let tgUser = tg.initDataUnsafe?.user;
    if (!tgUser) {
      mainMenu.innerHTML = "<h2>Please open in Telegram!</h2>";
      throw new Error("Not Telegram WebApp");
    }
    const userId = tgUser.id.toString();
    let highScore = 0;
    async function loadUser() {
      userPhoto.src = tgUser.photo_url || "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png";
      userPhoto.onerror = function() {
        if (userPhoto.src !== "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png") {
          userPhoto.src = "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png";
        }
      };
      userName.textContent = tgUser.username ? "@" + tgUser.username : "No username";
      const userRef = ref(db, `users/${userId}`);
      let snapshot = await get(userRef);
      if (!snapshot.exists()) {
        await set(userRef, {highScore:0,username:tgUser.username||"",photo:tgUser.photo_url||""});
        highScore = 0;
      } else {
        highScore = snapshot.val().highScore || 0;
      }
      coinsDisplay.textContent = `Best: ${highScore}`;
      yourHighScore.textContent = `Best: ${highScore}`;
      await updatePlace();
      mainMenu.style.display = "flex";
    }
    window.onload = loadUser;
    async function updatePlace() {
      yourPlace.textContent = "Rank: ...";
      const usersRef = ref(db, "users/");
      const snapshot = await get(usersRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        const usersArray = Object.entries(data).map(([id, u]) => ({id,highScore:u.highScore||0}));
        usersArray.sort((a, b) => b.highScore - a.highScore);
        const place = usersArray.findIndex(x => x.id === userId) + 1;
        if (place > 0) yourPlace.textContent = `Rank: ${place} of ${usersArray.length}`;
        else yourPlace.textContent = `Rank: â€”`;
      }
    }
    startGameBtn.onclick = () => { mainMenu.style.display = "none"; startGameWithCountdown(); };
    leaderboardBtn.onclick = () => { mainMenu.style.display = "none"; leaderboardContainer.style.display = "flex"; loadLeaderboard(); };
    infoBtn.onclick = () => { mainMenu.style.display = "none"; infoContainer.style.display = "flex"; };
    leaderboardBackBtn.onclick = () => { leaderboardContainer.style.display = "none"; mainMenu.style.display = "flex"; };
    infoBackBtn.onclick = () => { infoContainer.style.display = "none"; mainMenu.style.display = "flex"; };
    async function loadLeaderboard() {
      leaderboardBody.innerHTML = "";
      const usersRef = ref(db, "users/");
      const snapshot = await get(usersRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        const usersArray = Object.entries(data).map(([id, u]) => ({username:u.username?`@${u.username}`:"User "+id,highScore:u.highScore||0,}));
        usersArray.sort((a, b) => b.highScore - a.highScore);
        usersArray.forEach(user => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${user.username}</td><td>${user.highScore}</td>`;
          leaderboardBody.appendChild(tr);
        });
      }
    }

    // -------- CANVAS GAME --------
    const FIXED_FPS = 60;
    const BASE_GRAVITY = 0.3;
    const BASE_LIFT = -5.2;
    const BASE_SCROLL = 1.8;
    const BASE_MAXFALL = 3.1;
    const ENEMY_SPAWN_SEC = 1.4;
    const COIN_SPAWN_SEC = 0.95;

    let ctx, animationId, isGameRunning = false;
    let canvasWidth = 0, canvasHeight = 0;
    let player = {};
    let enemies = [];
    let coins = [];
    let enemySpawnTimer = 0;
    let coinSpawnTimer = 0;
    let scoreThisRun = 0, bgX = 0;
    let showPlayer = false, slowStart = true, deathFall = false;
    let gameStartTime = 0, lastFrameTime = 0, firstTapDone = false;

    // --- ÐÐ¾Ð²Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±: Ð¼Ð°ÑÑÐ¸Ð² ÐºÐ°Ð´Ñ€Ð¾Ð² ---
    let kirbyImgs = [new Image(), new Image()];
    kirbyImgs[0].src = "k1.png"; // Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐ¿Ñ€Ð°Ð¹Ñ‚
    kirbyImgs[1].src = "k2.png"; // alternate frame (Ð¿Ñ€Ð¸ Ñ‚Ð°Ð¿Ðµ)
    let kirbyCurrentFrame = 0; // 0 = k1, 1 = k2

    // ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ ÐºÐ°Ðº Ñ€Ð°Ð½ÑŒÑˆÐµ
    let enemyImg = new Image(), coinImg = new Image();
    enemyImg.src = "https://i.pinimg.com/originals/4b/4f/a1/4b4fa16fff0d9782b6e53db976f89f78.gif";
    coinImg.src = "https://donatepay.ru/uploads/notification/images/830208_1664005822.gif";
    function resizeCanvas() {
      canvasWidth = window.innerWidth;
      canvasHeight = window.innerHeight;
      gameCanvas.width = canvasWidth;
      gameCanvas.height = canvasHeight;
    }
    window.addEventListener("resize", () => { if (isGameRunning) resizeCanvas(); });

    function startGameWithCountdown() {
      gameContainer.style.display = "block";
      gameOverPopup.style.display = "none";
      gameHudCoins.style.display = "none";
      ctx = gameCanvas.getContext("2d");
      resizeCanvas();
      scoreThisRun = 0;
      player = {
        x: 100, y: canvasHeight/2, width: 48, height: 48, velocityY: 0, gravity: BASE_GRAVITY,
        lift: BASE_LIFT, alive: true, maxFallSpeed: BASE_MAXFALL, rotating: false, rotAngle: 0
      };
      enemies = [];
      coins = [];
      enemySpawnTimer = 0;
      coinSpawnTimer = 0;
      bgX = 0;
      deathFall = false;
      showPlayer = false;
      slowStart = true;
      slowStartFrame = 0;
      gameStartTime = performance.now();
      lastFrameTime = gameStartTime;
      firstTapDone = false;
      kirbyCurrentFrame = 0; // Ð²ÑÐµÐ³Ð´Ð° ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð²Ð°Ñ‚ÑŒ Ñ k1
      let countdown = 3;
      countdownOverlay.style.display = "flex";
      countdownOverlay.textContent = countdown;
      let cdInt = setInterval(() => {
        countdown--;
        if (countdown === 0) {
          countdownOverlay.textContent = "GO!";
        } else if (countdown < 0) {
          countdownOverlay.style.display = "none";
          clearInterval(cdInt);
          showPlayer = true;
          startGameCore();
        } else {
          countdownOverlay.textContent = countdown;
        }
      }, 900);
    }
    let slowStartFrame = 0, ticksAfterStart = 0;
    function startGameCore() {
      isGameRunning = true;
      slowStart = true; slowStartFrame = 0; ticksAfterStart = 0;
      gameHudCoins.textContent = "Coins: 0";
      gameHudCoins.style.display = "block";
      document.addEventListener("keydown", onKeyDown);
      document.addEventListener("mousedown", onClickOrTouch);
      document.addEventListener("touchstart", onClickOrTouch);
      lastFrameTime = performance.now();
      animationId = requestAnimationFrame(updateGame);
    }

    function updateGame(now = performance.now()) {
      let dt = Math.min((now - lastFrameTime) / 1000, 0.2);
      lastFrameTime = now;

      // --- Ð’ÐœÐ•Ð¡Ð¢Ðž drawScrollingBackground â€” Ñ€Ð¸ÑÑƒÐµÐ¼ Ð¿Ð°ÑÑ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð³Ñ€Ð°Ð´Ð¸ÐµÐ½Ñ‚ ---
      drawGradientBackground();

      if (showPlayer) {
        updatePlayer(dt);
        drawPlayer();
        if (isGameRunning) {
          ticksAfterStart++;
          if (ticksAfterStart > 120) {
            enemySpawnTimer += dt;
            if (enemySpawnTimer > ENEMY_SPAWN_SEC) { createEnemy(); enemySpawnTimer = 0; }
          }
          coinSpawnTimer += dt;
          if (coinSpawnTimer > COIN_SPAWN_SEC) { createCoin(); coinSpawnTimer = 0; }
          for (let i = 0; i < enemies.length; i++) {
            enemies[i].x -= BASE_SCROLL * dt * FIXED_FPS;
            drawEnemy(enemies[i]);
            if (checkCollision(player, enemies[i])) { handleDeathAnimation(); return; }
          }
          enemies = enemies.filter(e => e.x + e.width > 0);
          for (let i = 0; i < coins.length; i++) {
            coins[i].x -= BASE_SCROLL * dt * FIXED_FPS;
            drawCoin(coins[i]);
            if (checkCollision(player, coins[i])) { scoreThisRun++; coins[i].collected = true; }
          }
          coins = coins.filter(c => !c.collected && c.x + c.size > 0);
          gameHudCoins.textContent = "Coins: " + scoreThisRun;
          if (player.alive) { animationId = requestAnimationFrame(updateGame); }
        }
      }
      if (deathFall) updateDeathFall(dt);
    }

    // --- Ð’ÐœÐ•Ð¡Ð¢Ðž drawScrollingBackground(dt) ---
    function drawGradientBackground() {
      let gradient = ctx.createLinearGradient(0, 0, 0, canvasHeight);
      gradient.addColorStop(0, '#a2d2ff');    // Ð¿Ð°ÑÑ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ ÑÐ¸Ð½Ð¸Ð¹
      gradient.addColorStop(0.5, '#b07cff');  // Ð¿Ð°ÑÑ‚ÐµÐ»ÑŒÐ½Ð¾-Ñ„Ð¸Ð¾Ð»ÐµÑ‚Ð¾Ð²Ñ‹Ð¹
      gradient.addColorStop(1, '#ffe7f3');    // Ð¿Ð°ÑÑ‚ÐµÐ»ÑŒÐ½Ð¾-Ñ€Ð¾Ð·Ð¾Ð²Ñ‹Ð¹
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    }

    function drawPlayer() {
      const img = kirbyImgs[kirbyCurrentFrame];
      if (!player.rotating)
        ctx.drawImage(img, player.x, player.y, player.width, player.height);
      else {
        ctx.save();
        ctx.translate(player.x + player.width / 2, player.y + player.height / 2);
        ctx.rotate(player.rotAngle * Math.PI / 180);
        ctx.drawImage(img, -player.width/2, -player.height/2, player.width, player.height);
        ctx.restore();
      }
    }
    function drawEnemy(e) {
      ctx.drawImage(enemyImg, e.x, e.y, e.width, e.height);
    }
    function drawCoin(c) {
      ctx.drawImage(coinImg, c.x, c.y, c.size, c.size);
    }
    function createEnemy() {
      const randY = Math.random() * (canvasHeight - 80 - 20) + 10;
      enemies.push({ x: canvasWidth, y: randY, width: 80, height: 80 });
    }
    function createCoin() {
      const randY = Math.random() * (canvasHeight - 40 - 20) + 10;
      coins.push({ x: canvasWidth, y: randY, size: 40, collected: false });
    }
    function updatePlayer(dt) {
      let gravity = player.gravity;
      if (slowStart) {
        slowStartFrame++;
        gravity = 0.07;
        if (slowStartFrame > 72) slowStart = false;
      }
      player.velocityY += gravity * dt * FIXED_FPS;
      if (player.velocityY > player.maxFallSpeed) player.velocityY = player.maxFallSpeed;
      player.y += player.velocityY * dt * FIXED_FPS;
      if (player.y < 0) { player.y = 0; player.velocityY = 0; }
      if (player.y + player.height > canvasHeight) { handleDeathAnimation(); }
    }
    function onKeyDown(e) { if (e.code === "Space") { handleFlap(); switchKirbyFrame(); } }
    function onClickOrTouch() { handleFlap(); switchKirbyFrame(); }
    function handleFlap() {
      if (!player.alive) return;
      if (!firstTapDone) { firstTapDone = true; player.velocityY = player.lift; }
      else player.velocityY = player.lift;
    }
    function switchKirbyFrame() {
      kirbyCurrentFrame = 1 - kirbyCurrentFrame; // 0â†’1, 1â†’0
    }
    function checkCollision(pl, obj) {
      const pr = { x: pl.x + 10, y: pl.y + 10, width: pl.width - 20, height: pl.height - 20 };
      const ow = (obj.width  || obj.size) - 20;
      const oh = (obj.height || obj.size) - 20;
      const or = { x: obj.x + 10, y: obj.y + 10, width:  ow > 0 ? ow : 0, height: oh > 0 ? oh : 0 };
      return !(
        or.x > pr.x + pr.width ||
        or.x + or.width < pr.x ||
        or.y > pr.y + pr.height ||
        or.y + or.height < pr.y
      );
    }
    function handleDeathAnimation() {
      if (!player.alive) return;
      player.alive = false;
      isGameRunning = false;
      deathFall = true;
      gameHudCoins.style.display = "none";
      document.removeEventListener("keydown", onKeyDown);
      document.removeEventListener("mousedown", onClickOrTouch);
      document.removeEventListener("touchstart", onClickOrTouch);
      player.rotating = true;
      player.rotAngle = 90;
      player.velocityY = 3.5;
      lastFrameTime = performance.now();
      animationId = requestAnimationFrame(updateGame);
    }
    function updateDeathFall(dt) {
      player.y += player.velocityY * dt * FIXED_FPS * 1.1;
      player.velocityY += 0.33 * dt * FIXED_FPS;
      if (player.y > canvasHeight + player.height) {
        deathFall = false;
        showGameOverSequence();
      } else {
        animationId = requestAnimationFrame(updateGame);
      }
    }
    function showGameOverSequence() {
      let newHigh = false;
      if (scoreThisRun > highScore) {
        highScore = scoreThisRun;
        newHigh = true;
      }
      updateScoreInDB(newHigh, scoreThisRun);
      let popupText = `You collected <b>${scoreThisRun}</b> coins this run.<br>`;
      if (newHigh) popupText += "<span style='color:#b13df3'>NEW RECORD!</span><br>";
      popupText += `Your best: <b>${highScore}</b>`;
      setTimeout(() => showGameOverPopup(popupText), 500);
    }
    function showGameOverPopup(html) {
      gameOverText.innerHTML = html;
      gameOverPopup.style.display = "flex";
    }
    gameOverCloseBtn.onclick = endGameAndReturn;
    function endGameAndReturn() {
      if (isGameRunning || deathFall) {
        cancelAnimationFrame(animationId);
        document.removeEventListener("keydown", onKeyDown);
        document.removeEventListener("mousedown", onClickOrTouch);
        document.removeEventListener("touchstart", onClickOrTouch);
        isGameRunning = false; deathFall = false;
      }
      gameContainer.style.display = "none";
      gameOverPopup.style.display = "none";
      coinsDisplay.textContent = `Best: ${highScore}`;
      yourHighScore.textContent = `Best: ${highScore}`;
      updatePlace();
      mainMenu.style.display = "flex";
      ticksAfterStart = 0;
    }
    async function updateScoreInDB(isNewHigh, latestScore) {
      const userRef = ref(db, `users/${userId}`);
      let updateData = {};
      if (isNewHigh) updateData.highScore = latestScore;
      await update(userRef, updateData);
      coinsDisplay.textContent = `Best: ${highScore}`;
      yourHighScore.textContent = `Best: ${highScore}`;
    }
  </script>
</body>
</html>

