<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Floppy Kirby ‚Äî Telegram WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Nunito:800,700,600,400|Poppins:600,400&display=swap" rel="stylesheet">
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; font-family:'Nunito','Poppins','Open Sans',sans-serif; background:#f7f4ff; overflow:hidden; user-select:none;}
    #mainMenu, #leaderboardContainer, #infoContainer, #gameOverPopup {
      width:100vw;height:100vh;display:none;position:fixed;top:0;left:0;
      flex-direction:column;align-items:center;justify-content:flex-start;
      background:linear-gradient(120deg,#a2d2ff 0%,#ffe7f3 100%);
      overflow-y:auto;padding:0!important;
    }
    #mainMenu .menu-inner,
    #leaderboardContainer .menu-inner,
    #infoContainer .menu-inner,
    #gameOverPopup .menu-inner {
      margin-top:80px;width:100%;display:flex;flex-direction:column;align-items:center;
    }
    #gameContainer {width:100vw;height:100vh;display:none;position:fixed;top:0;left:0;background:#fff;z-index:20;overflow:hidden;}
    #gameHudCoins {position:absolute;top:50px;left:50%;transform:translateX(-50%);font-size:2em;font-weight:900;color:#fff;background:linear-gradient(90deg,#b07cff 0,#ffb5d1 100%);padding:10px 32px;border-radius:28px;box-shadow:0 6px 28px #c2a4ff22;text-shadow:0 2px 6px #a2d2ffb2;border:2px solid #fff;pointer-events:none;z-index:110;letter-spacing:.02em;font-family:'Nunito','Poppins',sans-serif;transition:background 0.28s;user-select:none;}
    .tooltip {margin-bottom:22px;background:#fff4;color:#7e47a8;font-size:1.13em;padding:9px 22px;border-radius:20px;box-shadow:0 8px 22px #b8d8fa36;letter-spacing:.03em;transition:background 0.3s;max-width:90vw;text-align:center;}
    .user-header {display:flex;flex-direction:column;align-items:center;margin-bottom:20px;gap:6px;background:rgba(255,255,255,0.63);border-radius:18px;box-shadow:0 4px 16px #c8a2c866;padding:18px 32px 15px 32px;}
    .user-header img {width:72px;height:72px;border-radius:50%;border:3.5px solid #fff;box-shadow:0 4px 24px 0 #a2d2ff61;background:#fff;margin-bottom:3px;object-fit:cover;}
    .user-header span {font-size:1.14em;color:#4b3570;font-weight:700;text-shadow:0 2px 4px #eee;max-width:200px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;letter-spacing:.01em;}
    .user-meta {display:flex;flex-direction:row;gap:10px;margin-bottom:18px;align-items:center;width:100%;justify-content:center;}
    .user-meta div {font-size:1.01em;color:#44335b;background:#fff9;border-radius:13px;padding:5px 18px;margin:2px 0;box-shadow:0 2px 8px #a2d2ff1a;min-width:90px;text-align:center;font-weight:600;}
    #coinsDisplay {color:#fff;background:linear-gradient(90deg,#c186fd 0,#ffb5d1 100%);font-size:1.12em;font-weight:700;margin-bottom:16px;padding:8px 24px;border-radius:30px;box-shadow:0 3px 12px #c2a4ff1a;text-shadow:0 2px 2px #fff9;border:2px solid #fff;letter-spacing:.04em;display:inline-block;}
    .main-btn {margin:14px 0;padding:15px 36px;font-size:1.15em;background:linear-gradient(90deg,#f7c8e0 0%,#b6eaff 100%);border:none;border-radius:29px;box-shadow:0 3px 16px #a2d2ff4d,0 1px 1px #fff;cursor:pointer;font-weight:700;color:#493a66;transition:0.16s;display:block;}
    .main-btn:hover {background:linear-gradient(90deg,#ffc0cb 10%,#a2d2ff 100%);transform:scale(1.06);}
    .main-btn:active {transform:scale(0.96);}
    #leaderboardBackBtn, #infoBackBtn {position:absolute;top:40px;left:24px;padding:11px 30px;background:linear-gradient(90deg,#f8daea 0%,#d1eaff 100%);border:none;border-radius:22px;font-size:1.04em;font-weight:700;color:#4e3888;cursor:pointer;box-shadow:0 3px 0 #c8a2c8,0 2px 8px #ffdbf933;z-index:99;transition:background 0.22s;}
    #leaderboardBackBtn:hover, #infoBackBtn:hover {background:linear-gradient(90deg,#c186fd 0,#ffb5d1 100%);color:#fff;}
    #infoContainer p {font-size:1.10em;color:#493A64;background:#fff7;border-radius:12px;padding:10px 14px;margin-top:0;}
    #gameOverPopup {z-index:999;display:none;align-items:center;justify-content:center;background:rgba(60,30,80,0.42);animation:fadeIn 0.23s;}
    .popup-box {background:linear-gradient(120deg,#fff 63%,#ffe3fa 100%);border-radius:32px;padding:34px 36px 28px 36px;min-width:240px;box-shadow:0 8px 30px #e3caff88;display:flex;flex-direction:column;align-items:center;gap:18px;margin-top:80px;}
    .popup-box h2 {margin:0 0 8px 0;color:#9857d3;font-size:1.23em;}
    .popup-box p {color:#47366b;font-size:1.07em;margin:0;}
    .popup-box button {margin-top:5px;padding:13px 32px;background:linear-gradient(90deg,#f7c8e0 0,#b6eaff 100%);border-radius:20px;border:none;color:#44335b;font-weight:700;font-size:1.09em;box-shadow:0 2px 12px #a2d2ff3b;cursor:pointer;transition:background 0.14s;display:block;}
    .popup-box button#gameOverCloseBtn {display:block;}
    #countdownOverlay {display:none;position:absolute;top:0;left:0;width:100vw;height:100vh;z-index:222;align-items:center;justify-content:center;background:rgba(248,245,255,0.78);font-size:3em;color:#9857d3;font-weight:900;font-family:'Nunito',sans-serif;letter-spacing:.08em;text-shadow:0 2px 12px #fff;}
    /* NEW LEADERBOARD STYLES */
    #leaderboardContainer .menu-inner {margin-top:40px;}
    #leaderboardContainer table {
      width:92vw;max-width:440px;margin:18px auto 0 auto;
      border-radius:20px;background:#fff9fda6;
      box-shadow:0 8px 40px #b8d8fa44,0 1px 0 #f0d5ff;
      overflow:hidden;border-collapse:separate;border-spacing:0;
    }
    #leaderboardContainer thead th {
      background:linear-gradient(90deg,#d4afff 0%,#fcdcff 100%);
      color:#7c46a3;font-size:1.18em;padding:16px 0;font-weight:800;
      border-bottom:2.5px solid #e1bee7;
      text-align:center;
      letter-spacing:.03em;
    }
    #leaderboardContainer tbody td {
      color:#493a66;font-size:1.1em;padding:13px 0;font-weight:700;
      border-bottom:1.5px solid #e1bee7;
      text-align:center;
      background:rgba(255,255,255,0.98);
      letter-spacing:.01em;
    }
    #leaderboardContainer tbody tr:nth-child(1) td {background:linear-gradient(90deg,#ffe27c33 0,#b8ffcb1a 100%);color:#d39e18;}
    #leaderboardContainer tbody tr:nth-child(2) td {background:linear-gradient(90deg,#f9f9e6 0,#d2edfc 100%);color:#a3a3a3;}
    #leaderboardContainer tbody tr:nth-child(3) td {background:linear-gradient(90deg,#ffd9e6 0,#f5f5f5 100%);color:#bd76b3;}
    #leaderboardContainer tbody tr:last-child td {border-bottom:none;}
    @media (max-width:600px){.main-btn,#leaderboardBackBtn,#infoBackBtn,.popup-box button{font-size:0.97em;padding:11px 12px;}.user-header img{width:60px;height:60px;}.popup-box{padding:22px 10vw;}#gameHudCoins{font-size:1.3em;padding:7px 10vw;}}
    @media (max-width:390px){#coinsDisplay{font-size:0.94em;padding:7px 10px;}.user-meta div{font-size:0.92em;}.user-header{padding:10px 7vw;}#gameHudCoins{font-size:1.12em;padding:7px 4vw;}}
  </style>
</head>
<body>
  <!-- Main Menu -->
  <div id="mainMenu">
    <div class="menu-inner">
      <div class="tooltip">Collect coins and dodge enemies! ü™ô</div>
      <div class="user-header">
        <img id="userPhoto" src="" alt="Avatar" />
        <span id="userName">@User</span>
      </div>
      <div class="user-meta">
        <div id="yourPlace">Rank: ...</div>
        <div id="yourHighScore">Best: ...</div>
      </div>
      <div id="coinsDisplay"></div>
      <button id="startGameBtn" class="main-btn">Start Game</button>
      <button id="leaderboardBtn" class="main-btn">Leaderboard</button>
      <button id="infoBtn" class="main-btn">How to Play?</button>
    </div>
  </div>
  <!-- Game Screen -->
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="gameHudCoins" style="display:none;">Coins: 0</div>
    <div id="countdownOverlay"></div>
  </div>
  <!-- Leaderboard -->
  <div id="leaderboardContainer">
    <div class="menu-inner">
      <button id="leaderboardBackBtn" class="main-btn" style="position:absolute;">Back</button>
      <h2 style="color:#7c46a3;text-align:center;margin:8px 0 0 0">Leaderboard</h2>
      <table>
        <thead>
          <tr><th>User</th><th>Best</th></tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>
  <!-- Info -->
  <div id="infoContainer">
    <div class="menu-inner">
      <button id="infoBackBtn" class="main-btn" style="position:absolute;">Back</button>
      <h2 style="color:#7c46a3;text-align:center;margin:5px 0 10px 0;">How to Play?</h2>
      <p>
        <b>Kirby</b> flies endlessly, collecting coins and dodging enemies.<br>
        If Kirby hits an enemy or falls ‚Äî the game is over.<br>
        <b>Controls:</b> Tap / Click or Space.<br>
        The goal is to collect as many coins as possible in one run!<br>
        <br>
        Your record is saved and displayed in the leaderboard. Good luck!
      </p>
    </div>
  </div>
  <!-- Game Over Popup -->
  <div id="gameOverPopup">
    <div class="menu-inner">
      <div class="popup-box">
        <h2>Game Over!</h2>
        <p id="gameOverText"></p>
        <button id="gameOverCloseBtn" class="main-btn">Back to Menu</button>
      </div>
    </div>
  </div>
 <audio id="sfx_die" src="sfx_die.mp3" preload="auto"></audio>
 <audio id="sfx_point" src="sfx_point.mp3" preload="auto"></audio>
 <audio id="sfx_wing" src="sfx_wing.mp3" preload="auto"></audio>
 <script type="module">
  // Telegram WebApp
  const tg = window.Telegram.WebApp;
  if (typeof tg.requestFullscreen === 'function') tg.requestFullscreen();
  else tg.expand();
  // Firebase 9+
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
  import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
  const firebaseConfig = {
    apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
    authDomain: "test-with-likes.firebaseapp.com",
    databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
    projectId: "test-with-likes",
    storageBucket: "test-with-likes.appspot.com",
    messagingSenderId: "764738820142",
    appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
    measurementId: "G-WJNF0HSN9P"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // SFX
  const sfx_die = document.getElementById("sfx_die");
  const sfx_point = document.getElementById("sfx_point");
  const sfx_wing = document.getElementById("sfx_wing");
  function playSFX(audio) {
    audio.currentTime = 0;
    audio.play();
  }

  // DOM Elements
  const mainMenu = document.getElementById("mainMenu");
  const userPhoto = document.getElementById("userPhoto");
  const userName = document.getElementById("userName");
  const coinsDisplay = document.getElementById("coinsDisplay");
  const startGameBtn = document.getElementById("startGameBtn");
  const leaderboardBtn = document.getElementById("leaderboardBtn");
  const infoBtn = document.getElementById("infoBtn");
  const gameContainer = document.getElementById("gameContainer");
  const gameCanvas = document.getElementById("gameCanvas");
  const leaderboardContainer = document.getElementById("leaderboardContainer");
  const leaderboardBackBtn = document.getElementById("leaderboardBackBtn");
  const leaderboardBody = document.getElementById("leaderboardBody");
  const infoContainer = document.getElementById("infoContainer");
  const infoBackBtn = document.getElementById("infoBackBtn");
  const yourPlace = document.getElementById("yourPlace");
  const yourHighScore = document.getElementById("yourHighScore");
  const gameOverPopup = document.getElementById("gameOverPopup");
  const gameOverText = document.getElementById("gameOverText");
  const gameOverCloseBtn = document.getElementById("gameOverCloseBtn");
  const countdownOverlay = document.getElementById("countdownOverlay");
  const gameHudCoins = document.getElementById("gameHudCoins");
  // User
  let tgUser = tg.initDataUnsafe?.user;
  if (!tgUser) {
    mainMenu.innerHTML = "<h2>Please open in Telegram!</h2>";
    throw new Error("Not Telegram WebApp");
  }
  const userId = tgUser.id.toString();
  let highScore = 0;
  async function loadUser() {
    userPhoto.src = tgUser.photo_url || "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png";
    userPhoto.onerror = function() {
      if (userPhoto.src !== "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png") {
        userPhoto.src = "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png";
      }
    };
    userName.textContent = tgUser.username ? "@" + tgUser.username : "No username";
    const userRef = ref(db, `users/${userId}`);
    let snapshot = await get(userRef);
    if (!snapshot.exists()) {
      await set(userRef, {highScore:0,username:tgUser.username||"",photo:tgUser.photo_url||""});
      highScore = 0;
    } else {
      highScore = snapshot.val().highScore || 0;
    }
    coinsDisplay.textContent = `Best: ${highScore}`;
    yourHighScore.textContent = `Best: ${highScore}`;
    await updatePlace();
    mainMenu.style.display = "flex";
  }
  window.onload = loadUser;
  async function updatePlace() {
    yourPlace.textContent = "Rank: ...";
    const usersRef = ref(db, "users/");
    const snapshot = await get(usersRef);
    if (snapshot.exists()) {
      const data = snapshot.val();
      const usersArray = Object.entries(data).map(([id, u]) => ({id,highScore:u.highScore||0}));
      usersArray.sort((a, b) => b.highScore - a.highScore);
      const place = usersArray.findIndex(x => x.id === userId) + 1;
      if (place > 0) yourPlace.textContent = `Rank: ${place} of ${usersArray.length}`;
      else yourPlace.textContent = `Rank: ‚Äî`;
    }
  }
  startGameBtn.onclick = () => { mainMenu.style.display = "none"; startGameWithCountdown(); };
  leaderboardBtn.onclick = () => { mainMenu.style.display = "none"; leaderboardContainer.style.display = "flex"; loadLeaderboard(); };
  infoBtn.onclick = () => { mainMenu.style.display = "none"; infoContainer.style.display = "flex"; };
  leaderboardBackBtn.onclick = () => { leaderboardContainer.style.display = "none"; mainMenu.style.display = "flex"; };
  infoBackBtn.onclick = () => { infoContainer.style.display = "none"; mainMenu.style.display = "flex"; };
  async function loadLeaderboard() {
    leaderboardBody.innerHTML = "";
    const usersRef = ref(db, "users/");
    const snapshot = await get(usersRef);
    if (snapshot.exists()) {
      const data = snapshot.val();
      const usersArray = Object.entries(data).map(([id, u]) => ({
        username: u.username ? `@${u.username}` : "User " + id,
        highScore: u.highScore || 0,
      }));
      usersArray.sort((a, b) => b.highScore - a.highScore);
      usersArray.forEach((user, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${user.username}</td><td>${user.highScore}</td>`;
        leaderboardBody.appendChild(tr);
      });
    }
  }

  // -------- CANVAS GAME --------
  const FIXED_FPS = 60;
  const BASE_GRAVITY = 0.2;
  const BASE_LIFT = -4.5;
  const BASE_SCROLL = 2;
  const BASE_MAXFALL = 4.5;
  const ENEMY_SPAWN_SEC = 1;
  const COIN_SPAWN_SEC = 0.95;

  let ctx, animationId, isGameRunning = false;
  let canvasWidth = 0, canvasHeight = 0;
  let player = {};
  let enemies = [];
  let coins = [];
  let enemySpawnTimer = 0;
  let coinSpawnTimer = 0;
  let scoreThisRun = 0, bgX = 0;
  let showPlayer = false, slowStart = true, deathFall = false;
  let gameStartTime = 0, lastFrameTime = 0, firstTapDone = false;

  // Kirby (–∏–≥—Ä–æ–∫)
  let kirbyImgs = [new Image(), new Image()];
  kirbyImgs[0].src = "k1.png";
  kirbyImgs[1].src = "k2.png";
  let kirbyCurrentFrame = 0;
  let kirbyAngle = 0;
  const MIN_ANGLE = -27;
  const MAX_ANGLE = 78;
  const ANGLE_RETURN_SPEED = 8;

  // --- –í—Ä–∞–≥–∏ (–∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø—Ä–∞–π—Ç) ---
  let enemyImgs = [new Image(), new Image()];
  enemyImgs[0].src = "e1.png";
  enemyImgs[1].src = "e2.png";
  let enemyAnimFrame = 0;
  let enemyAnimLastTime = performance.now();

  // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  let coinImg = new Image(), bgImage = new Image();
  coinImg.src = "https://donatepay.ru/uploads/notification/images/830208_1664005822.gif";
  bgImage.src = "https://blog.itselectlab.com/wp-content/uploads/background.png";

  function resizeCanvas() {
    canvasWidth = window.innerWidth;
    canvasHeight = window.innerHeight;
    gameCanvas.width = canvasWidth;
    gameCanvas.height = canvasHeight;
  }
  window.addEventListener("resize", () => { if (isGameRunning) resizeCanvas(); });

  function startGameWithCountdown() {
    gameContainer.style.display = "block";
    gameOverPopup.style.display = "none";
    gameHudCoins.style.display = "none";
    ctx = gameCanvas.getContext("2d");
    resizeCanvas();
    scoreThisRun = 0;
    player = {
      x: 100, y: canvasHeight/2, width: 48, height: 48, velocityY: 0, gravity: BASE_GRAVITY,
      lift: BASE_LIFT, alive: true, maxFallSpeed: BASE_MAXFALL, rotating: false
    };
    enemies = [];
    coins = [];
    enemySpawnTimer = 0;
    coinSpawnTimer = 0;
    bgX = 0;
    deathFall = false;
    showPlayer = false;
    slowStart = true;
    slowStartFrame = 0;
    gameStartTime = performance.now();
    lastFrameTime = gameStartTime;
    firstTapDone = false;
    kirbyCurrentFrame = 0;
    kirbyAngle = 0;
    let countdown = 3;
    countdownOverlay.style.display = "flex";
    countdownOverlay.textContent = countdown;
    let cdInt = setInterval(() => {
      countdown--;
      if (countdown === 0) {
        countdownOverlay.textContent = "GO!";
      } else if (countdown < 0) {
        countdownOverlay.style.display = "none";
        clearInterval(cdInt);
        showPlayer = true;
        startGameCore();
      } else {
        countdownOverlay.textContent = countdown;
      }
    }, 900);
  }
  let slowStartFrame = 0, ticksAfterStart = 0;
  function startGameCore() {
    isGameRunning = true;
    slowStart = true; slowStartFrame = 0; ticksAfterStart = 0;
    gameHudCoins.textContent = "Coins: 0";
    gameHudCoins.style.display = "block";
    document.addEventListener("keydown", onKeyDown);
    document.addEventListener("mousedown", onClickOrTouch);
    document.addEventListener("touchstart", onClickOrTouch);
    lastFrameTime = performance.now();
    animationId = requestAnimationFrame(updateGame);
  }

  function updateGame(now = performance.now()) {
    let dt = Math.min((now - lastFrameTime) / 1000, 0.2);
    lastFrameTime = now;

    // –§–æ–Ω (–¥–≤–æ–π–Ω–æ–π —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —â–µ–ª–∏)
    bgX -= BASE_SCROLL * dt * FIXED_FPS;
    if (bgX <= -canvasWidth) { bgX += canvasWidth; }
    ctx.drawImage(bgImage, Math.round(bgX), 0, canvasWidth, canvasHeight);
    ctx.drawImage(bgImage, Math.round(bgX + canvasWidth), 0, canvasWidth, canvasHeight);

    // --- –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞–≥–∞ ---
    if (now - enemyAnimLastTime > 160) {
      enemyAnimFrame = 1 - enemyAnimFrame;
      enemyAnimLastTime = now;
    }

    if (showPlayer) {
      updatePlayer(dt);
      drawPlayer();

      if (isGameRunning) {
        ticksAfterStart++;
        // –í—Ä–∞–≥–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–µ —Å—Ä–∞–∑—É (–æ—Ç–ª–æ–∂–µ–Ω–æ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞)
        if (ticksAfterStart > 120) {
          enemySpawnTimer += dt;
          if (enemySpawnTimer > ENEMY_SPAWN_SEC) { createEnemy(); enemySpawnTimer = 0; }
        }
        coinSpawnTimer += dt;
        if (coinSpawnTimer > COIN_SPAWN_SEC) { createCoin(); coinSpawnTimer = 0; }

        // --- –í—Ä–∞–≥–∏: –¥–≤–∏–≥–∞—é—Ç—Å—è –≤–ª–µ–≤–æ –∏ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω—ã ---
        for (let i = 0; i < enemies.length; i++) {
          // NEW: —É–Ω–∏–∫–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—Ä–∞–≥–∞ (0.9..1.35 BASE_SCROLL)
          enemies[i].x -= enemies[i].speed * dt * FIXED_FPS;
          drawEnemy(enemies[i]);
          if (checkCollision(player, enemies[i])) { handleDeathAnimation(); return; }
        }
        enemies = enemies.filter(e => e.x + e.width > 0);

        // --- –ú–æ–Ω–µ—Ç—ã ---
        for (let i = 0; i < coins.length; i++) {
          coins[i].x -= BASE_SCROLL * dt * FIXED_FPS;
          drawCoin(coins[i]);
          if (checkCollision(player, coins[i])) {
            scoreThisRun++;
            coins[i].collected = true;
            playSFX(sfx_point);
          }
        }
        coins = coins.filter(c => !c.collected && c.x + c.size > 0);

        gameHudCoins.textContent = "Coins: " + scoreThisRun;
        if (player.alive) { animationId = requestAnimationFrame(updateGame); }
      }
    }
    if (deathFall) updateDeathFall(dt);
  }

  function drawPlayer() {
    const img = kirbyImgs[kirbyCurrentFrame];
    ctx.save();
    ctx.translate(player.x + player.width/2, player.y + player.height/2);
    ctx.rotate((kirbyAngle * Math.PI) / 180);
    ctx.drawImage(img, -player.width/2, -player.height/2, player.width, player.height);
    ctx.restore();
  }
  function drawEnemy(e) {
    ctx.drawImage(enemyImgs[enemyAnimFrame], e.x, e.y, e.width, e.height);
  }
  function drawCoin(c) {
    ctx.drawImage(coinImg, c.x, c.y, c.size, c.size);
  }
  function createEnemy() {
    const randY = Math.random() * (canvasHeight - 42 - 20) + 10;
    // –ú–∏–Ω–∏–º—É–º 0.9 BASE_SCROLL, –º–∞–∫—Å–∏–º—É–º 1.35 BASE_SCROLL (—Ä–∞–∑–Ω—ã–µ —Å–∫–æ—Ä–æ—Å—Ç–∏)
    const speedMult = Math.random() * 0.45 + 0.9;
    enemies.push({ x: canvasWidth, y: randY, width: 54, height: 40, speed: BASE_SCROLL * speedMult });
  }
  function createCoin() {
    const randY = Math.random() * (canvasHeight - 40 - 20) + 10;
    coins.push({ x: canvasWidth, y: randY, size: 40, collected: false });
  }

  function updatePlayer(dt) {
    let gravity = player.gravity;
    if (slowStart) {
      slowStartFrame++;
      gravity = 0.07;
      if (slowStartFrame > 72) slowStart = false;
    }
    player.velocityY += gravity * dt * FIXED_FPS;
    if (player.velocityY > player.maxFallSpeed) player.velocityY = player.maxFallSpeed;
    player.y += player.velocityY * dt * FIXED_FPS;
    if (player.y < 0) { player.y = 0; player.velocityY = 0; }

    // --- –õ–æ–≥–∏–∫–∞ –Ω–∞–∫–ª–æ–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ---
    let targetAngle = 0;
    if (player.velocityY < -1) targetAngle = MIN_ANGLE;
    else if (player.velocityY > 2) targetAngle = MAX_ANGLE;
    else targetAngle = 24;
    kirbyAngle += (targetAngle - kirbyAngle) * Math.min(dt * ANGLE_RETURN_SPEED, 1);

    if (player.y + player.height > canvasHeight) { handleDeathAnimation(); }
  }

  function onKeyDown(e) { if (e.code === "Space") { handleFlap(); switchKirbyFrame(); } }
  function onClickOrTouch() { handleFlap(); switchKirbyFrame(); }

  function handleFlap() {
    if (!player.alive) return;
    if (!firstTapDone) { firstTapDone = true; player.velocityY = player.lift; }
    else player.velocityY = player.lift;
    kirbyAngle = MIN_ANGLE;
    playSFX(sfx_wing);
  }
  function switchKirbyFrame() {
    kirbyCurrentFrame = 1 - kirbyCurrentFrame;
  }
  function checkCollision(pl, obj) {
    const pr = { x: pl.x + 10, y: pl.y + 10, width: pl.width - 20, height: pl.height - 20 };
    const ow = (obj.width  || obj.size) - 20;
    const oh = (obj.height || obj.size) - 20;
    const or = { x: obj.x + 10, y: obj.y + 10, width:  ow > 0 ? ow : 0, height: oh > 0 ? oh : 0 };
    return !(
      or.x > pr.x + pr.width ||
      or.x + or.width < pr.x ||
      or.y > pr.y + pr.height ||
      or.y + or.height < pr.y
    );
  }
  function handleDeathAnimation() {
    if (!player.alive) return;
    player.alive = false;
    isGameRunning = false;
    deathFall = true;
    gameHudCoins.style.display = "none";
    document.removeEventListener("keydown", onKeyDown);
    document.removeEventListener("mousedown", onClickOrTouch);
    document.removeEventListener("touchstart", onClickOrTouch);
    player.rotating = true;
    kirbyAngle = MAX_ANGLE;
    player.velocityY = 3.5;
    lastFrameTime = performance.now();
    playSFX(sfx_die);
    // –í–∏–±—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
    if (window.navigator.vibrate) window.navigator.vibrate([200, 100, 150]);
    animationId = requestAnimationFrame(updateGame);
  }
  function updateDeathFall(dt) {
    player.y += player.velocityY * dt * FIXED_FPS * 1.1;
    player.velocityY += 0.33 * dt * FIXED_FPS;
    kirbyAngle += (MAX_ANGLE - kirbyAngle) * Math.min(dt * 8, 1);
    if (player.y > canvasHeight + player.height) {
      deathFall = false;
      showGameOverSequence();
    } else {
      animationId = requestAnimationFrame(updateGame);
    }
  }
  function showGameOverSequence() {
    let newHigh = false;
    if (scoreThisRun > highScore) {
      highScore = scoreThisRun;
      newHigh = true;
    }
    updateScoreInDB(newHigh, scoreThisRun);
    let popupText = `You collected <b>${scoreThisRun}</b> coins this run.<br>`;
    if (newHigh) popupText += "<span style='color:#b13df3'>NEW RECORD!</span><br>";
    popupText += `Your best: <b>${highScore}</b>`;
    setTimeout(() => showGameOverPopup(popupText), 500);
  }
  function showGameOverPopup(html) {
    gameOverText.innerHTML = html;
    gameOverPopup.style.display = "flex";
  }
  gameOverCloseBtn.onclick = endGameAndReturn;
  function endGameAndReturn() {
    if (isGameRunning || deathFall) {
      cancelAnimationFrame(animationId);
      document.removeEventListener("keydown", onKeyDown);
      document.removeEventListener("mousedown", onClickOrTouch);
      document.removeEventListener("touchstart", onClickOrTouch);
      isGameRunning = false; deathFall = false;
    }
    gameContainer.style.display = "none";
    gameOverPopup.style.display = "none";
    coinsDisplay.textContent = `Best: ${highScore}`;
    yourHighScore.textContent = `Best: ${highScore}`;
    updatePlace();
    mainMenu.style.display = "flex";
    ticksAfterStart = 0;
  }
  async function updateScoreInDB(isNewHigh, latestScore) {
    const userRef = ref(db, `users/${userId}`);
    let updateData = {};
    if (isNewHigh) updateData.highScore = latestScore;
    await update(userRef, updateData);
    coinsDisplay.textContent = `Best: ${highScore}`;
    yourHighScore.textContent = `Best: ${highScore}`;
  }
</script>
</body>
</html>

