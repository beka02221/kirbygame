<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Floppy Kirby</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <style>
    :root {
      --bg-gradient: linear-gradient(120deg, #A2D2FF 0%, #FFC0CB 100%);
      --btn-gradient: linear-gradient(90deg, #f7c8e0 0%, #b6eaff 100%);
      --btn-hover: linear-gradient(90deg, #ffc0cb 20%, #A2D2FF 100%);
    }
    body, html {
      margin: 0; padding: 0;
      width: 100vw; height: 100vh;
      overflow: hidden;
      font-family: 'Nunito', sans-serif;
    }
    body.dark {
      --bg-gradient: #333;
      --btn-gradient: #666;
      --btn-hover: #555;
      background: #222;
      color: #eee;
    }
    /* Screens */
    #mainMenu, #leaderboardContainer, #infoContainer, #gameContainer, #gameOverPopup {
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      display: none;
    }
    /* Main Menu */
    #mainMenu {
      display: flex; flex-direction: column; align-items: center;
      padding-top: 80px; padding-bottom: 20px;
      background: var(--bg-gradient);
      gap: 12px;
    }
    #themeToggleBtn {
      position: absolute; top: 20px; right: 20px;
      padding: 8px 12px; border: none; border-radius: 20px;
      background: var(--btn-gradient); cursor: pointer;
      font-size: 0.9em; font-weight: bold;
    }
    #mainMenu button {
      padding: 14px 32px;
      font-size: 1.2em; font-weight: 700;
      background: var(--btn-gradient);
      border: none; border-radius: 28px;
      box-shadow: 0 3px 14px rgba(0,0,0,0.2);
      cursor: pointer; transition: 0.16s;
    }
    #mainMenu button:hover {
      background: var(--btn-hover);
      transform: scale(1.04);
    }
    /* Game Container */
    #gameContainer {
      background: #fff;
    }
    #gameCanvas {
      position: absolute; top: 80px; left: 0;
      width: 100%; height: calc(100% - 80px);
    }
    #countdownOverlay {
      position: absolute; top: 80px; left: 0;
      width: 100%; height: calc(100% - 80px);
      display: flex; align-items: center; justify-content: center;
      background: rgba(248,245,255,0.8);
      font-size: 4em; color: #9857d3; font-weight: 900;
      z-index: 10;
    }
    /* Leaderboard & Info */
    #leaderboardContainer, #infoContainer {
      background: var(--bg-gradient);
      padding-top: 80px; overflow-y: auto;
    }
    #leaderboardContainer h2, #infoContainer h2 {
      text-align: center; margin: 0 0 12px;
      color: #47366b;
    }
    #leaderboardContainer table {
      width: 90%; margin: 0 auto; border-collapse: collapse;
      background: #fff; border-radius: 12px; overflow: hidden;
    }
    #leaderboardContainer th, #leaderboardContainer td {
      padding: 10px; text-align: left; font-size: 1em;
    }
    #leaderboardContainer th {
      background: #C8A2C8; color: #fff;
    }
    #leaderboardContainer tr:nth-child(odd) { background: #f9f5ff; }
    #infoContainer p {
      width: 90%; margin: 0 auto; font-size: 1.05em;
      background: #fff8; padding: 12px; border-radius: 10px;
      line-height: 1.4;
    }
    /* Game Over Popup */
    #gameOverPopup {
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.5);
      z-index: 20;
    }
    .popup-box {
      background: #fff;
      padding: 24px; border-radius: 20px;
      text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .popup-box h2 { margin: 0 0 12px; color: #9857d3; }
    .popup-box p { margin: 0 0 16px; }
    .popup-box button {
      margin: 4px; padding: 10px 20px;
      border: none; border-radius: 18px;
      background: var(--btn-gradient); font-weight: bold;
      cursor: pointer; transition: 0.16s;
    }
    .popup-box button:hover { background: var(--btn-hover); }
  </style>
</head>
<body>
  <!-- Main Menu -->
  <div id="mainMenu">
    <button id="themeToggleBtn">Toggle Theme</button>
    <h1>Floppy Kirby</h1>
    <button id="startGameBtn">Start Game</button>
    <button id="leaderboardBtn">Leaderboard</button>
    <button id="infoBtn">How to Play?</button>
  </div>

  <!-- Game Screen -->
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="countdownOverlay"></div>
  </div>

  <!-- Leaderboard -->
  <div id="leaderboardContainer">
    <button id="leaderboardBackBtn">Back</button>
    <h2>Leaderboard</h2>
    <table>
      <thead>
        <tr><th>Player</th><th>Best Score</th></tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>

  <!-- Info -->
  <div id="infoContainer">
    <button id="infoBackBtn">Back</button>
    <h2>How to Play?</h2>
    <p>
      Help Kirby fly through the endless sky!<br>
      Collect coins by tapping or pressing Space.<br>
      Dodge enemies—if you crash, it’s game over.<br>
      Your best score is saved locally.<br>
      Good luck!
    </p>
  </div>

  <!-- Game Over Popup -->
  <div id="gameOverPopup">
    <div class="popup-box">
      <h2>Game Over!</h2>
      <p id="gameOverText"></p>
      <button id="playAgainBtn">Play Again</button>
      <button id="menuBtn">Main Menu</button>
    </div>
  </div>

  <script>
    // Elements
    const mainMenu = document.getElementById('mainMenu');
    const startGameBtn = document.getElementById('startGameBtn');
    const leaderboardBtn = document.getElementById('leaderboardBtn');
    const infoBtn = document.getElementById('infoBtn');
    const themeToggle = document.getElementById('themeToggleBtn');
    const leaderboardContainer = document.getElementById('leaderboardContainer');
    const leaderboardBackBtn = document.getElementById('leaderboardBackBtn');
    const leaderboardBody = document.getElementById('leaderboardBody');
    const infoContainer = document.getElementById('infoContainer');
    const infoBackBtn = document.getElementById('infoBackBtn');
    const gameContainer = document.getElementById('gameContainer');
    const gameCanvas = document.getElementById('gameCanvas');
    const countdownOverlay = document.getElementById('countdownOverlay');
    const gameOverPopup = document.getElementById('gameOverPopup');
    const gameOverText = document.getElementById('gameOverText');
    const playAgainBtn = document.getElementById('playAgainBtn');
    const menuBtn = document.getElementById('menuBtn');

    // Canvas setup
    const ctx = gameCanvas.getContext('2d');
    function resize() {
      gameCanvas.width = window.innerWidth;
      gameCanvas.height = window.innerHeight - 80;
    }
    window.addEventListener('resize', resize);
    resize();

    // State
    let highScore = parseInt(localStorage.getItem('floppyHighScore') || '0', 10);
    let isRunning = false;
    let player, enemies, coins, score, frameCount, slowTimer;

    // Theme toggle
    themeToggle.onclick = () => document.body.classList.toggle('dark');

    // Navigation
    startGameBtn.onclick = () => showScreen(gameContainer) || startGame();
    leaderboardBtn.onclick = () => { showScreen(leaderboardContainer); loadLeaderboard(); };
    infoBtn.onclick = () => showScreen(infoContainer);
    leaderboardBackBtn.onclick = () => showScreen(mainMenu);
    infoBackBtn.onclick = () => showScreen(mainMenu);
    playAgainBtn.onclick = () => gameOverPopup.style.display = 'none' || startGame();
    menuBtn.onclick = () => showScreen(mainMenu);

    function showScreen(screen) {
      [mainMenu, gameContainer, leaderboardContainer, infoContainer, gameOverPopup]
        .forEach(el => el.style.display = (el === screen) ? 'flex' : 'none');
    }
    showScreen(mainMenu);

    // Leaderboard (localStorage)
    function loadLeaderboard() {
      leaderboardBody.innerHTML = '';
      const stored = JSON.parse(localStorage.getItem('floppyScores') || '[]');
      stored.sort((a,b) => b.score - a.score);
      stored.forEach(({name, score}) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${name}</td><td>${score}</td>`;
        leaderboardBody.appendChild(tr);
      });
    }

    // Game Objects
    function initGame() {
      player = { x: 100, y: 100, size: 40, vy: 0 };
      enemies = [];
      coins = [];
      score = 0;
      frameCount = 0;
      slowTimer = 0;
    }

    // Countdown + start
    function startGame() {
      initGame();
      showScreen(gameContainer);
      countdownOverlay.style.display = 'flex';
      let cnt = 3;
      countdownOverlay.textContent = cnt;
      const iv = setInterval(() => {
        cnt--;
        if (cnt > 0) countdownOverlay.textContent = cnt;
        else if (cnt === 0) countdownOverlay.textContent = 'GO!';
        else {
          clearInterval(iv);
          countdownOverlay.style.display = 'none';
          isRunning = true;
          animate();
        }
      }, 800);
    }

    // Main loop
    function animate() {
      if (!isRunning) return;
      frameCount++;
      // clear
      ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
      // background
      ctx.fillStyle = '#e3e0ff';
      ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);
      // dynamic difficulty
      const baseInterval = Math.max(60, 150 - Math.floor(score/5)*10);
      // spawn enemy
      if (frameCount % baseInterval === 0) spawnEnemy();
      // spawn coin
      if (frameCount % 80 === 0) spawnCoin();
      // update & draw coins
      ctx.fillStyle = '#f5d74f';
      coins = coins.filter(c => {
        c.x -= 2;
        if (c.x < -c.size) return false;
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.size/2, 0, 2*Math.PI);
        ctx.fill();
        // collision
        if (Math.hypot(c.x - (player.x+player.size/2), c.y - (player.y+player.size/2)) < (c.size+player.size)/2) {
          score++;
          return false;
        }
        return true;
      });
      // update & draw enemies
      ctx.fillStyle = '#d9534f';
      enemies = enemies.filter(e => {
        e.x -= 2;
        if (e.x < -e.size) return false;
        ctx.fillRect(e.x, e.y, e.size, e.size);
        // collision
        if (
          player.x < e.x+e.size && player.x+player.size > e.x &&
          player.y < e.y+e.size && player.y+player.size > e.y
        ) { return handleDeath(); }
        return true;
      });
      // update player
      // slow fall for first ~1.5s
      slowTimer++;
      const gravity = (slowTimer < 90 ? 0.05 : 0.3);
      player.vy += gravity;
      player.y += player.vy;
      if (player.y + player.size > gameCanvas.height) return handleDeath();
      // draw player
      ctx.fillStyle = '#9857d3';
      ctx.fillRect(player.x, player.y, player.size, player.size);
      // draw score
      ctx.fillStyle = '#333';
      ctx.font = '20px sans-serif';
      ctx.fillText(`Score: ${score}`, 10, 30);
      requestAnimationFrame(animate);
    }

    function spawnEnemy() {
      const size = 40;
      enemies.push({
        x: gameCanvas.width,
        y: Math.random()*(gameCanvas.height-size),
        size
      });
    }
    function spawnCoin() {
      const size = 20;
      coins.push({
        x: gameCanvas.width,
        y: Math.random()*(gameCanvas.height-size),
        size
      });
    }

    // input
    document.addEventListener('keydown', e => {
      if (e.code === 'Space') flap();
    });
    document.addEventListener('mousedown', flap);
    function flap() { player.vy = -5; }

    // death handler & animation
    function handleDeath() {
      isRunning = false;
      // vibrate mobile
      if (navigator.vibrate) navigator.vibrate(200);
      // animate player falling & rotating
      const fall = setInterval(() => {
        player.y += 6;
        player.x += 2;
        ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
        ctx.fillStyle = '#333';
        ctx.fillRect(player.x, player.y, player.size, player.size);
        if (player.y > gameCanvas.height) {
          clearInterval(fall);
          showGameOver();
        }
      }, 30);
      return false; // remove this enemy
    }

    // show Game Over
    function showGameOver() {
      // save high score
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('floppyHighScore', highScore);
      }
      // save to leaderboard
      const name = 'Player'; // static name
      const list = JSON.parse(localStorage.getItem('floppyScores')||'[]');
      list.push({ name, score });
      localStorage.setItem('floppyScores', JSON.stringify(list));
      // show popup
      gameOverText.innerHTML = `You scored <b>${score}</b>!<br>Your best: <b>${highScore}</b>`;
      showScreen(gameOverPopup);
    }
  </script>
</body>
</html>
