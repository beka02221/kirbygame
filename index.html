<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Floppy Bird — Telegram WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100vw; height: 100vh;
      font-family: 'Nunito', 'Poppins', 'Open Sans', sans-serif;
      background: #FFC0CB;
      overflow: hidden;
    }
    #mainMenu, #gameContainer, #leaderboardContainer, #infoContainer {
      width: 100vw; height: 100vh;
      display: none; position: fixed; top:0; left:0;
      overflow: hidden;
    }
    #mainMenu { display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(90deg, #FFC0CB 0%, #A2D2FF 100%);}
    .user-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
    .user-header img { width: 70px; height: 70px; border-radius: 50%; margin-bottom: 10px; border:3px solid #fff; }
    .user-header span { font-size: 1.2em; color:#fff; font-weight:bold; text-shadow: 0 1px 3px #888; }
    #coinsDisplay { color:#fff; font-size:1.1em; margin-bottom:30px;}
    #mainMenu button {
      margin: 8px; padding: 13px 28px;
      font-size: 1.2em;
      background: #FDFD96; border: none; border-radius: 30px;
      box-shadow: 0 3px 0 #C8A2C8;
      cursor: pointer; font-weight: bold; transition: 0.2s;
    }
    #mainMenu button:hover { background: #FFB4D9; }
    #mainMenu button:active { transform: scale(0.97); }
    #gameContainer { background: #fff; z-index: 20;}
    #leaderboardContainer, #infoContainer {
      background: linear-gradient(180deg, #A2D2FF 0%, #FFC0CB 100%);
      z-index: 50;
      padding: 40px 10px 10px 10px;
      overflow-y: auto;
    }
    #backToMenuBtn, #leaderboardBackBtn, #infoBackBtn {
      position: absolute; top: 18px; left: 18px;
      padding: 8px 22px;
      background: #FDFD96;
      border: none; border-radius: 24px;
      font-size: 1em; cursor:pointer;
      box-shadow: 0 3px 0 #C8A2C8;
      z-index: 99;
    }
    table { width: 95%; margin:20px auto 0 auto; background: #fff; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.08);}
    th, td { padding: 10px; text-align: left; font-size: 1.1em;}
    th { background: #C8A2C8; color: #fff;}
    @media (max-width:600px) {
      #mainMenu button, #backToMenuBtn, #leaderboardBackBtn, #infoBackBtn { font-size: 1em; padding:10px 15px;}
    }
  </style>
</head>
<body>
  <!-- Главное меню -->
  <div id="mainMenu">
    <div class="user-header">
      <img id="userPhoto" src="" alt="Avatar" />
      <span id="userName">@User</span>
    </div>
    <div id="coinsDisplay"></div>
    <button id="startGameBtn">Начать игру</button>
    <button id="leaderboardBtn">Таблица лидеров</button>
    <button id="infoBtn">Информация</button>
  </div>

  <!-- Игровой экран -->
  <div id="gameContainer">
    <button id="backToMenuBtn">В меню</button>
    <canvas id="gameCanvas"></canvas>
  </div>

  <!-- Таблица лидеров -->
  <div id="leaderboardContainer">
    <button id="leaderboardBackBtn">Назад</button>
    <h2>Таблица лидеров</h2>
    <table>
      <thead>
        <tr><th>Пользователь</th><th>Монет</th></tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>

  <!-- Информация -->
  <div id="infoContainer">
    <button id="infoBackBtn">Назад</button>
    <h2>Информация об игре</h2>
    <p>Кирби летит слева направо по бесконечному фону, собирая монеты и уклоняясь от врагов.<br>Если Кирби коснётся врага — игра окончена.</p>
  </div>

  <script type="module">
    // Telegram WebApp
    const tg = window.Telegram.WebApp;
    if (typeof tg.requestFullscreen === 'function') tg.requestFullscreen();
    else tg.expand();

    // Firebase 9+
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM Elements
    const mainMenu = document.getElementById("mainMenu");
    const userPhoto = document.getElementById("userPhoto");
    const userName = document.getElementById("userName");
    const coinsDisplay = document.getElementById("coinsDisplay");
    const startGameBtn = document.getElementById("startGameBtn");
    const leaderboardBtn = document.getElementById("leaderboardBtn");
    const infoBtn = document.getElementById("infoBtn");
    const gameContainer = document.getElementById("gameContainer");
    const backToMenuBtn = document.getElementById("backToMenuBtn");
    const gameCanvas = document.getElementById("gameCanvas");
    const leaderboardContainer = document.getElementById("leaderboardContainer");
    const leaderboardBackBtn = document.getElementById("leaderboardBackBtn");
    const leaderboardBody = document.getElementById("leaderboardBody");
    const infoContainer = document.getElementById("infoContainer");
    const infoBackBtn = document.getElementById("infoBackBtn");

    // User
    let tgUser = tg.initDataUnsafe?.user;
    if (!tgUser) {
      mainMenu.innerHTML = "<h2>Пожалуйста, откройте через Telegram!</h2>";
      throw new Error("Not Telegram WebApp");
    }
    const userId = tgUser.id.toString();
    let currentCoins = 0;

    // Main UI Load
    async function loadUser() {
      userPhoto.src = tgUser.photo_url || "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png";
      userName.textContent = tgUser.username ? "@" + tgUser.username : "Без username";
      // Получить прогресс (по userId)
      const userRef = ref(db, `users/${userId}`);
      let snapshot = await get(userRef);
      if (!snapshot.exists()) {
        // Новый пользователь
        await set(userRef, {
          coins: 0,
          username: tgUser.username || "",
          photo: tgUser.photo_url || ""
        });
        currentCoins = 0;
      } else {
        currentCoins = snapshot.val().coins || 0;
      }
      coinsDisplay.textContent = `Монет: ${currentCoins}`;
      mainMenu.style.display = "flex";
    }
    window.onload = loadUser;

    // Меню
    startGameBtn.onclick = () => { mainMenu.style.display = "none"; startGame(); };
    leaderboardBtn.onclick = () => { mainMenu.style.display = "none"; leaderboardContainer.style.display = "block"; loadLeaderboard(); };
    infoBtn.onclick = () => { mainMenu.style.display = "none"; infoContainer.style.display = "block"; };

    // Лидеры
    async function loadLeaderboard() {
      leaderboardBody.innerHTML = "";
      const usersRef = ref(db, "users/");
      const snapshot = await get(usersRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        const usersArray = Object.entries(data).map(([id, u]) => ({
          username: u.username ? `@${u.username}` : "User " + id,
          coins: u.coins || 0
        }));
        usersArray.sort((a, b) => b.coins - a.coins);
        usersArray.forEach(user => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${user.username}</td><td>${user.coins}</td>`;
          leaderboardBody.appendChild(tr);
        });
      }
    }
    leaderboardBackBtn.onclick = () => { leaderboardContainer.style.display = "none"; mainMenu.style.display = "flex"; };
    infoBackBtn.onclick = () => { infoContainer.style.display = "none"; mainMenu.style.display = "flex"; };

    // Game Logic
    let ctx, animationId, isGameRunning = false;
    let canvasWidth = 0, canvasHeight = 0;
    const player = { x: 100, y: 150, width: 45, height: 45, velocityY: 0, gravity: 0.3, lift: -5, alive: true, maxFallSpeed: 3, el: null };
    const scrollSpeed = 1.8;
    let enemies = [], enemyTimer = 0, enemyInterval = 150;
    const enemyGif = "https://i.pinimg.com/originals/4b/4f/a1/4b4fa16fff0d9782b6e53db976f89f78.gif";
    const enemyWidth = 80, enemyHeight = 80;
    let coins = [], coinTimer = 0, coinInterval = 80;
    const coinSize = 40, coinGifURL = "https://donatepay.ru/uploads/notification/images/830208_1664005822.gif";
    let scoreThisRun = 0, bgX = 0;
    const bgImage = new window.Image();
    bgImage.src = "https://i.pinimg.com/736x/20/e9/cf/20e9cf219337614640886180cc5d1c34.jpg";
    const collisionMargin = 10;

    function startGame() {
      gameContainer.style.display = "block";
      ctx = gameCanvas.getContext("2d");
      resizeCanvas();
      isGameRunning = true;
      player.y = canvasHeight / 2;
      player.velocityY = 0;
      player.alive = true;
      enemies = []; enemyTimer = 0;
      coins = []; coinTimer = 0;
      scoreThisRun = 0; bgX = 0;
      if (!player.el) {
        const kirby = document.createElement("img");
        kirby.src = "kirby.gif";
        kirby.style.position = "absolute";
        kirby.style.width = player.width + "px";
        kirby.style.height = player.height + "px";
        kirby.style.left = player.x + "px";
        kirby.style.top = player.y + "px";
        kirby.style.zIndex = "900";
        gameContainer.appendChild(kirby);
        player.el = kirby;
      } else { player.el.style.display = "block"; }
      document.addEventListener("keydown", onKeyDown);
      document.addEventListener("mousedown", onClickOrTouch);
      document.addEventListener("touchstart", onClickOrTouch);
      animationId = requestAnimationFrame(updateGame);
    }
    backToMenuBtn.onclick = endGameAndReturn;

    function resizeCanvas() {
      canvasWidth = window.innerWidth;
      canvasHeight = window.innerHeight;
      gameCanvas.width = canvasWidth;
      gameCanvas.height = canvasHeight;
    }
    window.addEventListener("resize", () => { if (isGameRunning) resizeCanvas(); });

    function updateGame() {
      if (!isGameRunning) return;
      ctx.clearRect(0, 0, canvasWidth, canvasHeight);
      drawScrollingBackground();
      enemyTimer++; if (enemyTimer > enemyInterval) { createEnemy(); enemyTimer = 0; }
      for (let i = 0; i < enemies.length; i++) {
        const e = enemies[i];
        e.x -= scrollSpeed;
        e.el.style.left = e.x + "px"; e.el.style.top = e.y + "px";
        if (checkCollision(player, e)) { gameOver(); }
      }
      enemies = enemies.filter(e => { if (e.x + e.width < 0) { gameContainer.removeChild(e.el); return false; } return true; });
      coinTimer++; if (coinTimer > coinInterval) { createCoin(); coinTimer = 0; }
      for (let i = 0; i < coins.length; i++) {
        const c = coins[i];
        c.x -= scrollSpeed;
        c.el.style.left = c.x + "px"; c.el.style.top = c.y + "px";
        if (checkCollision(player, c)) { scoreThisRun++; c.collected = true; }
      }
      coins = coins.filter(c => { if (c.collected || (c.x + c.size < 0)) { gameContainer.removeChild(c.el); return false; } return true; });
      updatePlayer();
      ctx.fillStyle = "white"; ctx.font = "24px Arial";
      ctx.fillText(`Монет за забег: ${scoreThisRun}`, 20, 40);
      if (player.alive) { animationId = requestAnimationFrame(updateGame); }
    }
    function drawScrollingBackground() {
      bgX -= 1; if (bgX <= -canvasWidth) { bgX = 0; }
      ctx.drawImage(bgImage, bgX, 0, canvasWidth, canvasHeight);
      ctx.drawImage(bgImage, bgX + canvasWidth, 0, canvasWidth, canvasHeight);
    }
    function createEnemy() {
      const randY = Math.random() * (canvasHeight - enemyHeight - 20) + 10;
      const enemyEl = document.createElement("img");
      enemyEl.src = enemyGif; enemyEl.style.position = "absolute";
      enemyEl.style.width = enemyWidth + "px"; enemyEl.style.height = enemyHeight + "px";
      enemyEl.style.left = canvasWidth + "px"; enemyEl.style.top = randY + "px";
      enemyEl.style.zIndex = "850"; gameContainer.appendChild(enemyEl);
      enemies.push({ x: canvasWidth, y: randY, width: enemyWidth, height: enemyHeight, el: enemyEl });
    }
    function createCoin() {
      const randY = Math.random() * (canvasHeight - coinSize - 20) + 10;
      const coinEl = document.createElement("img");
      coinEl.src = coinGifURL; coinEl.style.position = "absolute";
      coinEl.style.width = coinSize + "px"; coinEl.style.height = coinSize + "px";
      coinEl.style.left = canvasWidth + "px"; coinEl.style.top = randY + "px";
      coinEl.style.zIndex = "800"; gameContainer.appendChild(coinEl);
      coins.push({ x: canvasWidth, y: randY, size: coinSize, collected: false, el: coinEl });
    }
    function updatePlayer() {
      player.velocityY += player.gravity;
      if (player.velocityY > player.maxFallSpeed) player.velocityY = player.maxFallSpeed;
      player.y += player.velocityY;
      if (player.y < 0) { player.y = 0; player.velocityY = 0; }
      if (player.y + player.height > canvasHeight) { gameOver(); }
      player.el.style.left = player.x + "px"; player.el.style.top = player.y + "px";
    }
    function onKeyDown(e) { if (e.code === "Space") flap(); }
    function onClickOrTouch() { flap(); }
    function flap() { player.velocityY = player.lift; }
    function checkCollision(pl, obj) {
      const pr = { x: pl.x + collisionMargin, y: pl.y + collisionMargin, width: pl.width - collisionMargin * 2, height: pl.height - collisionMargin * 2 };
      const ow = (obj.width  || obj.size) - collisionMargin * 2;
      const oh = (obj.height || obj.size) - collisionMargin * 2;
      const or = { x: obj.x + collisionMargin, y: obj.y + collisionMargin, width:  ow > 0 ? ow : 0, height: oh > 0 ? oh : 0 };
      return !(
        or.x > pr.x + pr.width ||
        or.x + or.width < pr.x ||
        or.y > pr.y + pr.height ||
        or.y + or.height < pr.y
      );
    }
    function gameOver() {
      player.alive = false;
      cancelAnimationFrame(animationId);
      document.removeEventListener("keydown", onKeyDown);
      document.removeEventListener("mousedown", onClickOrTouch);
      document.removeEventListener("touchstart", onClickOrTouch);
      isGameRunning = false;
      currentCoins += scoreThisRun;
      updateCoinsInDB();
      setTimeout(endGameAndReturn, 500);
    }
    function endGameAndReturn() {
      if (isGameRunning) {
        cancelAnimationFrame(animationId);
        document.removeEventListener("keydown", onKeyDown);
        document.removeEventListener("mousedown", onClickOrTouch);
        document.removeEventListener("touchstart", onClickOrTouch);
        isGameRunning = false;
        currentCoins += scoreThisRun;
        updateCoinsInDB();
      }
      if (player.el) player.el.style.display = "none";
      for (const e of enemies) if (e.el) gameContainer.removeChild(e.el);
      enemies = [];
      for (const c of coins) if (c.el) gameContainer.removeChild(c.el);
      coins = [];
      gameContainer.style.display = "none";
      coinsDisplay.textContent = `Монет: ${currentCoins}`;
      mainMenu.style.display = "flex";
    }
    async function updateCoinsInDB() {
      const userRef = ref(db, `users/${userId}`);
      await update(userRef, { coins: currentCoins });
      coinsDisplay.textContent = `Монет: ${currentCoins}`;
    }
  </script>
</body>
</html>

