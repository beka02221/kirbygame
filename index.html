<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Floppy Kirby ‚Äî Telegram WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Nunito:800,700,600,400|Poppins:600,400&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0; padding: 0; width: 100vw; height: 100vh;
      font-family: 'Nunito', 'Poppins', 'Open Sans', sans-serif;
      background: #f7f4ff;
      overflow: hidden; user-select: none;
    }
    #mainMenu, #leaderboardContainer, #infoContainer, #gameOverPopup {
      width: 100vw; height: 100vh;
      display: none; position: fixed; top:0; left:0;
      flex-direction: column; align-items: center; justify-content: flex-start;
      background: linear-gradient(120deg, #a2d2ff 0%, #ffe7f3 100%);
      overflow-y: auto; padding: 0 !important;
    }
    #mainMenu .menu-inner,
    #leaderboardContainer .menu-inner,
    #infoContainer .menu-inner,
    #gameOverPopup .menu-inner {
      margin-top: 80px;
      width: 100%;
      display: flex; flex-direction: column; align-items: center;
    }
    #gameContainer {
      width: 100vw; height: 100vh;
      display: none; position: fixed; top:0; left:0;
      background: #fff; z-index: 20; overflow: hidden; padding: 0;
    }
    .tooltip { margin-bottom: 22px; background: #fff4; color: #7e47a8; font-size: 1.13em;
      padding: 9px 22px; border-radius: 20px; box-shadow: 0 8px 22px #b8d8fa36;
      letter-spacing: .03em; transition: background 0.3s; max-width: 90vw; text-align: center; }
    .user-header {
      display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; gap: 6px;
      background: rgba(255,255,255,0.63); border-radius: 18px;
      box-shadow: 0 4px 16px #c8a2c866; padding: 18px 32px 15px 32px;
    }
    .user-header img { width: 72px; height: 72px; border-radius: 50%; border:3.5px solid #fff;
      box-shadow: 0 4px 24px 0 #a2d2ff61; background: #fff; margin-bottom: 3px; }
    .user-header span { font-size: 1.14em; color: #4b3570; font-weight: 700;
      text-shadow: 0 2px 4px #eee; max-width: 200px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; letter-spacing: .01em;}
    .user-meta { display: flex; flex-direction: row; gap: 10px; margin-bottom: 18px; align-items: center; width: 100%; justify-content: center;}
    .user-meta div { font-size: 1.01em; color: #44335b; background: #fff9; border-radius: 13px; padding: 5px 18px; margin: 2px 0;
      box-shadow: 0 2px 8px #a2d2ff1a; min-width: 90px; text-align: center; font-weight: 600; }
    #coinsDisplay { color: #fff; background: linear-gradient(90deg,#c186fd 0,#ffb5d1 100%);
      font-size: 1.12em; font-weight: 700; margin-bottom: 16px; padding: 8px 24px; border-radius: 30px;
      box-shadow: 0 3px 12px #c2a4ff1a; text-shadow: 0 2px 2px #fff9; border: 2px solid #fff; letter-spacing: .04em; display: inline-block;}
    .main-btn { margin: 14px 0; padding: 15px 36px; font-size: 1.15em;
      background: linear-gradient(90deg, #f7c8e0 0%, #b6eaff 100%);
      border: none; border-radius: 29px; box-shadow: 0 3px 16px #a2d2ff4d, 0 1px 1px #fff;
      cursor: pointer; font-weight: 700; color: #493a66; transition: 0.16s; display: block;}
    .main-btn:hover { background: linear-gradient(90deg, #ffc0cb 10%, #a2d2ff 100%); transform: scale(1.06);}
    .main-btn:active { transform: scale(0.96);}
    #leaderboardContainer h2 { margin-bottom: 10px; }
    table { width: 94%; margin: 12px auto 0 auto; background: #fff; border-radius: 18px; box-shadow: 0 4px 18px 0 #c2a4ff29;}
    th, td { padding: 15px 10px; text-align: left; font-size: 1.08em;}
    th { background: #c186fd; color: #fff; border-radius: 12px 12px 0 0;}
    tr:nth-child(odd) { background: #f9f5ff; }
    tr:nth-child(even) { background: #f4ecfb; }
    #leaderboardBackBtn, #infoBackBtn {
      position: absolute; top: 40px; left: 24px;
      padding: 11px 30px; background: linear-gradient(90deg, #f8daea 0%, #d1eaff 100%);
      border: none; border-radius: 22px; font-size: 1.04em; font-weight: 700; color: #4e3888;
      cursor: pointer; box-shadow: 0 3px 0 #c8a2c8, 0 2px 8px #ffdbf933; z-index: 99; transition: background 0.22s;}
    #leaderboardBackBtn:hover, #infoBackBtn:hover { background: linear-gradient(90deg, #c186fd 0, #ffb5d1 100%); color: #fff;}
    #infoContainer p { font-size: 1.10em; color: #493A64; background: #fff7; border-radius: 12px; padding: 10px 14px; margin-top: 0;}
    #gameOverPopup { z-index: 999; display: none; align-items: center; justify-content: center;
      background: rgba(60,30,80,0.42); animation: fadeIn 0.23s;}
    .popup-box { background: linear-gradient(120deg, #fff 63%, #ffe3fa 100%);
      border-radius: 32px; padding: 34px 36px 28px 36px; min-width: 240px;
      box-shadow: 0 8px 30px #e3caff88; display: flex; flex-direction: column; align-items: center; gap: 18px; margin-top: 80px;}
    .popup-box h2 { margin:0 0 8px 0; color: #9857d3; font-size: 1.23em;}
    .popup-box p { color: #47366b; font-size: 1.07em; margin: 0; }
    .popup-box button { margin-top: 5px; padding: 13px 32px;
      background: linear-gradient(90deg,#f7c8e0 0,#b6eaff 100%);
      border-radius: 20px; border: none; color: #44335b; font-weight: 700; font-size: 1.09em; box-shadow: 0 2px 12px #a2d2ff3b;
      cursor: pointer; transition: background 0.14s; display: none;}
    .popup-box button#gameOverCloseBtn { display: block; }
    #countdownOverlay { display:none;position:absolute;top:0;left:0;width:100vw;height:100vh;z-index:222;
      align-items:center;justify-content:center; background:rgba(248,245,255,0.78);
      font-size:3em;color:#9857d3;font-weight:900; font-family:'Nunito',sans-serif;
      letter-spacing:.08em; text-shadow:0 2px 12px #fff;}
    #coinsTextInGame { position: absolute; left: 50%; transform: translateX(-50%); top: 50px; z-index: 300;
      background: linear-gradient(90deg,#b07cff44 0,#ffb5d133 100%);
      border-radius: 19px; padding: 9px 28px; color: #483977; font-weight: 800;
      font-size: 1.32em; text-shadow: 0 2px 9px #fff9; letter-spacing: .08em;
      box-shadow: 0 2px 9px #b07cff13; user-select: none; pointer-events: none;}
    #splashScreen {
      position:fixed; top:0; left:0; width:100vw; height:100vh; background:#120021;
      z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;
      transition:opacity 0.7s; opacity:1;
    }
    #splashLogo {
      font-family: 'Nunito', 'Poppins', sans-serif; color: #ffddff;
      font-size: 3em; font-weight: 900; letter-spacing: .09em;
      text-shadow: 0 6px 40px #6e49ff, 0 1px 0 #fff;
      animation: splash-fadein 0.9s;
    }
    #splashBy {
      font-family: 'Nunito', sans-serif; color: #6e49ff;
      margin-top: 24px; font-size: 1.5em; letter-spacing:.13em;
      opacity:0.8; animation: splash-fadein 1.5s;
    }
    @keyframes splash-fadein { 0% {opacity:0;transform:scale(0.8);} 100% {opacity:1;transform:scale(1);}}
    @media (max-width: 600px) { .main-btn, #leaderboardBackBtn, #infoBackBtn, .popup-box button { font-size: 0.97em; padding:11px 12px;}
      .user-header img { width: 60px; height: 60px;} .popup-box {padding:22px 10vw;} #coinsTextInGame { font-size: 1em; padding:7px 14px;}}
    @media (max-width: 390px) { #coinsDisplay { font-size: 0.94em; padding: 7px 10px;} .user-meta div { font-size: 0.92em;}
      .user-header {padding:10px 7vw;} #coinsTextInGame { font-size: 0.9em;}}
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div id="splashScreen">
    <div id="splashLogo">GalaxyTon</div>
    <div id="splashBy">by Barry</div>
  </div>
  <!-- Main Menu -->
  <div id="mainMenu" style="display:none;">
    <div class="menu-inner">
      <div class="tooltip">Collect coins and dodge enemies! ü™ô</div>
      <div class="user-header">
        <img id="userPhoto" src="" alt="Avatar" />
        <span id="userName">@User</span>
      </div>
      <div class="user-meta">
        <div id="yourPlace">Rank: ...</div>
        <div id="yourHighScore">Best: ...</div>
      </div>
      <div id="coinsDisplay"></div>
      <button id="startGameBtn" class="main-btn">Start Game</button>
      <button id="leaderboardBtn" class="main-btn">Leaderboard</button>
      <button id="infoBtn" class="main-btn">How to Play?</button>
    </div>
  </div>
  <!-- Game, Leaderboard, Info, Game Over (–æ—Å—Ç–∞–≤—å, –∫–∞–∫ —Ä–∞–Ω—å—à–µ) ... -->
  <div id="gameContainer"><canvas id="gameCanvas"></canvas><div id="countdownOverlay"></div><div id="coinsTextInGame">Coins: 0</div></div>
  <div id="leaderboardContainer"><div class="menu-inner"><button id="leaderboardBackBtn" class="main-btn" style="position:absolute;">Back</button><h2 style="color:#7c46a3;text-align:center;margin:8px 0 0 0">Leaderboard</h2><table><thead><tr><th>User</th><th>Best</th></tr></thead><tbody id="leaderboardBody"></tbody></table></div></div>
  <div id="infoContainer"><div class="menu-inner"><button id="infoBackBtn" class="main-btn" style="position:absolute;">Back</button><h2 style="color:#7c46a3;text-align:center;margin:5px 0 10px 0;">How to Play?</h2><p><b>Kirby</b> flies endlessly, collecting coins and dodging enemies.<br>If Kirby hits an enemy or falls ‚Äî the game is over.<br><b>Controls:</b> Tap / Click or Space.<br>The goal is to collect as many coins as possible in one run!<br><br>Your record is saved and displayed in the leaderboard. Good luck!</p></div></div>
  <div id="gameOverPopup"><div class="menu-inner"><div class="popup-box"><h2>Game Over!</h2><p id="gameOverText"></p><button id="gameOverCloseBtn" class="main-btn">Back to Menu</button></div></div></div>
  <script type="module">
    // Telegram
    const tg = window.Telegram.WebApp;
    if (typeof tg.requestFullscreen === 'function') tg.requestFullscreen();
    else tg.expand();

    // 1. Load all resources before showing menu (Kirby, Enemy, Coin, BG)
    const resources = {
      kirby: "kirby.gif",
      enemy: "https://i.pinimg.com/originals/4b/4f/a1/4b4fa16fff0d9782b6e53db976f89f78.gif",
      coin: "https://donatepay.ru/uploads/notification/images/830208_1664005822.gif",
      bg: "https://i.pinimg.com/736x/20/e9/cf/20e9cf219337614640886180cc5d1c34.jpg"
    };
    let imagesLoaded = 0;
    let images = {};
    function preloadResources(cb) {
      let total = Object.keys(resources).length;
      for (let key in resources) {
        let img = new window.Image();
        img.onload = () => {
          imagesLoaded++;
          images[key] = img;
          if (imagesLoaded >= total) cb();
        };
        img.src = resources[key];
      }
    }
    function showSplashThenMenu() {
      setTimeout(() => {
        const splash = document.getElementById("splashScreen");
        splash.style.opacity = 0;
        setTimeout(() => { splash.style.display = "none"; mainMenu.style.display = "flex"; }, 700);
      }, 1500);
    }

    // Firebase –∏ UI –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–æ—Å—Ç–∞–≤—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM
    const mainMenu = document.getElementById("mainMenu");
    const userPhoto = document.getElementById("userPhoto");
    const userName = document.getElementById("userName");
    const coinsDisplay = document.getElementById("coinsDisplay");
    const startGameBtn = document.getElementById("startGameBtn");
    const leaderboardBtn = document.getElementById("leaderboardBtn");
    const infoBtn = document.getElementById("infoBtn");
    const gameContainer = document.getElementById("gameContainer");
    const gameCanvas = document.getElementById("gameCanvas");
    const coinsTextInGame = document.getElementById("coinsTextInGame");
    const leaderboardContainer = document.getElementById("leaderboardContainer");
    const leaderboardBackBtn = document.getElementById("leaderboardBackBtn");
    const leaderboardBody = document.getElementById("leaderboardBody");
    const infoContainer = document.getElementById("infoContainer");
    const infoBackBtn = document.getElementById("infoBackBtn");
    const yourPlace = document.getElementById("yourPlace");
    const yourHighScore = document.getElementById("yourHighScore");
    const gameOverPopup = document.getElementById("gameOverPopup");
    const gameOverText = document.getElementById("gameOverText");
    const gameOverCloseBtn = document.getElementById("gameOverCloseBtn");
    const countdownOverlay = document.getElementById("countdownOverlay");

    // User
    let tgUser;
    let userId;
    let highScore = 0;
    function loadUser() {
      tgUser = tg.initDataUnsafe?.user;
      if (!tgUser) {
        mainMenu.innerHTML = "<h2>Please open in Telegram!</h2>";
        throw new Error("Not Telegram WebApp");
      }
      userId = tgUser.id.toString();
      userPhoto.src = tgUser.photo_url || "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png";
      userName.textContent = tgUser.username ? "@" + tgUser.username : "No username";
      const userRef = ref(db, `users/${userId}`);
      get(userRef).then(snapshot => {
        if (!snapshot.exists()) {
          set(userRef, {
            highScore: 0,
            username: tgUser.username || "",
            photo: tgUser.photo_url || ""
          });
          highScore = 0;
        } else {
          highScore = snapshot.val().highScore || 0;
        }
        coinsDisplay.textContent = `Best: ${highScore}`;
        yourHighScore.textContent = `Best: ${highScore}`;
        updatePlace();
        mainMenu.style.display = "flex";
      });
    }
    async function updatePlace() {
      yourPlace.textContent = "Rank: ...";
      const usersRef = ref(db, "users/");
      const snapshot = await get(usersRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        const usersArray = Object.entries(data).map(([id, u]) => ({
          id, highScore: u.highScore || 0
        }));
        usersArray.sort((a, b) => b.highScore - a.highScore);
        const place = usersArray.findIndex(x => x.id === userId) + 1;
        if (place > 0) yourPlace.textContent = `Rank: ${place} of ${usersArray.length}`;
        else yourPlace.textContent = `Rank: ‚Äî`;
      }
    }
    startGameBtn.onclick = () => { mainMenu.style.display = "none"; startGameWithCountdown(); };
    leaderboardBtn.onclick = () => { mainMenu.style.display = "none"; leaderboardContainer.style.display = "flex"; loadLeaderboard(); };
    infoBtn.onclick = () => { mainMenu.style.display = "none"; infoContainer.style.display = "flex"; };
    leaderboardBackBtn.onclick = () => { leaderboardContainer.style.display = "none"; mainMenu.style.display = "flex"; };
    infoBackBtn.onclick = () => { infoContainer.style.display = "none"; mainMenu.style.display = "flex"; };
    async function loadLeaderboard() {
      leaderboardBody.innerHTML = "";
      const usersRef = ref(db, "users/");
      const snapshot = await get(usersRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        const usersArray = Object.entries(data).map(([id, u]) => ({
          username: u.username ? `@${u.username}` : "User " + id,
          highScore: u.highScore || 0,
        }));
        usersArray.sort((a, b) => b.highScore - a.highScore);
        usersArray.forEach(user => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${user.username}</td><td>${user.highScore}</td>`;
          leaderboardBody.appendChild(tr);
        });
      }
    }

    // ----------------- GAME LOGIC ------------------
    // 1 virtual "game unit" = 1 px on 360x640 screen
    const GAME_WIDTH = 360;
    const GAME_HEIGHT = 640;

    // Player config
    const playerConf = {
      width: 42, height: 42, x: 100, gravity: 800, jump: -350, maxFall: 600
    };
    // Game speed config
    const SPEEDS = {
      background: 120,  // px per sec
      enemy: 180,       // px per sec
      coin: 180,
      spawnEnemy: 1.2,  // sec interval
      spawnCoin: 0.7
    };

    // For scaling to any device
    function scaleX(val) { return val * (canvasWidth / GAME_WIDTH); }
    function scaleY(val) { return val * (canvasHeight / GAME_HEIGHT); }

    // Game state
    let ctx, animationId, isGameRunning = false;
    let canvasWidth = 0, canvasHeight = 0, gameScale = 1;
    let player, enemies, coins, scoreThisRun, bgX, ticksAfterStart;
    let enemyTimer, coinTimer;
    let slowStart = true, showPlayer = false, deathFall = false;

    function resizeCanvas() {
      canvasWidth = window.innerWidth;
      canvasHeight = window.innerHeight;
      gameCanvas.width = canvasWidth;
      gameCanvas.height = canvasHeight;
    }

    // Start after 3s countdown (player not visible)
    function startGameWithCountdown() {
      resizeCanvas();
      gameContainer.style.display = "block";
      gameOverPopup.style.display = "none";
      coinsTextInGame.textContent = "Coins: 0";
      coinsTextInGame.style.display = "block";
      player = { ...playerConf, y: GAME_HEIGHT / 2, velocityY: 0, alive: true, rotating: false };
      enemies = []; coins = [];
      scoreThisRun = 0; bgX = 0; ticksAfterStart = 0;
      enemyTimer = 0; coinTimer = 0;
      slowStart = true; showPlayer = false; deathFall = false;
      document.removeEventListener("keydown", onKeyDown);
      document.removeEventListener("mousedown", onClickOrTouch);
      document.removeEventListener("touchstart", onClickOrTouch);

      let countdown = 3;
      countdownOverlay.style.display = "flex";
      countdownOverlay.textContent = countdown;
      let cdInt = setInterval(() => {
        countdown--;
        if (countdown === 0) {
          countdownOverlay.textContent = "GO!";
        } else if (countdown < 0) {
          countdownOverlay.style.display = "none";
          clearInterval(cdInt);
          showPlayer = true;
          startGameCore();
        } else {
          countdownOverlay.textContent = countdown;
        }
      }, 900);
    }

    function startGameCore() {
      isGameRunning = true;
      document.addEventListener("keydown", onKeyDown);
      document.addEventListener("mousedown", onClickOrTouch);
      document.addEventListener("touchstart", onClickOrTouch);
      lastTimestamp = undefined;
      requestAnimationFrame(gameLoop);
    }

    function drawImage(img, x, y, w, h, rotateDeg=0) {
      ctx.save();
      ctx.translate(x + w/2, y + h/2);
      ctx.rotate(rotateDeg * Math.PI / 180);
      ctx.drawImage(img, -w/2, -h/2, w, h);
      ctx.restore();
    }

    function createEnemy() {
      let y = 40 + Math.random() * (GAME_HEIGHT - 120);
      enemies.push({ x: GAME_WIDTH, y, w: 56, h: 56 });
    }
    function createCoin() {
      let y = 50 + Math.random() * (GAME_HEIGHT - 100);
      coins.push({ x: GAME_WIDTH, y, size: 36, collected: false });
    }
    function rectsCollide(a, b) {
      return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
    }
    // --- GAMELOOP WITH DELTATIME ---
    let lastTimestamp;
    function gameLoop(ts) {
      if (!lastTimestamp) lastTimestamp = ts;
      let delta = Math.min((ts - lastTimestamp) / 1000, 0.033);
      lastTimestamp = ts;
      ctx = gameCanvas.getContext("2d");
      ctx.clearRect(0, 0, canvasWidth, canvasHeight);

      // Draw background, scroll
      bgX = (bgX - SPEEDS.background * delta) % GAME_WIDTH;
      ctx.drawImage(images.bg, scaleX(bgX), 0, canvasWidth, canvasHeight);
      ctx.drawImage(images.bg, scaleX(bgX + GAME_WIDTH), 0, canvasWidth, canvasHeight);

      // Only show player after countdown
      if (showPlayer) {
        // Enemies
        enemyTimer += delta;
        if (enemyTimer > SPEEDS.spawnEnemy) {
          createEnemy(); enemyTimer = 0;
        }
        for (let e of enemies) {
          e.x -= SPEEDS.enemy * delta;
        }
        enemies = enemies.filter(e => e.x > -e.w);

        // Coins
        coinTimer += delta;
        if (coinTimer > SPEEDS.spawnCoin) {
          createCoin(); coinTimer = 0;
        }
        for (let c of coins) {
          c.x -= SPEEDS.coin * delta;
        }
        coins = coins.filter(c => !c.collected && c.x > -c.size);

        // Draw coins
        for (let c of coins) {
          drawImage(images.coin, scaleX(c.x), scaleY(c.y), scaleX(c.size), scaleY(c.size));
        }

        // Gravity
        let gravity = slowStart ? 200 : playerConf.gravity;
        let maxFall = slowStart ? 120 : playerConf.maxFall;
        player.velocityY += gravity * delta;
        if (player.velocityY > maxFall) player.velocityY = maxFall;
        player.y += player.velocityY * delta;
        // First jump disables slow
        if (player.y < 0) { player.y = 0; player.velocityY = 0; }
        // Draw player (Kirby), rotation on death
        let angle = player.rotating ? 90 : (player.velocityY / playerConf.maxFall) * 25;
        drawImage(images.kirby, scaleX(player.x), scaleY(player.y), scaleX(player.width), scaleY(player.height), angle);

        // Collisions (enemies)
        for (let e of enemies) {
          if (!player.rotating && rectsCollide(
            {x:player.x+5, y:player.y+5, w:player.width-10, h:player.height-10},
            {x:e.x+4, y:e.y+4, w:e.w-8, h:e.h-8}
          )) {
            handleDeathAnimation();
            return;
          }
          drawImage(images.enemy, scaleX(e.x), scaleY(e.y), scaleX(e.w), scaleY(e.h));
        }

        // Collisions (coins)
        for (let c of coins) {
          if (!c.collected && rectsCollide(
            {x:player.x+8, y:player.y+8, w:player.width-16, h:player.height-16},
            {x:c.x, y:c.y, w:c.size, h:c.size}
          )) {
            c.collected = true;
            scoreThisRun++;
          }
        }
        coinsTextInGame.textContent = "Coins: " + scoreThisRun;

        // Out of screen (death)
        if (player.y + player.height > GAME_HEIGHT && !player.rotating) {
          handleDeathAnimation();
          return;
        }

        // After slow start, normal gravity
        if (slowStart) {
          ticksAfterStart = (ticksAfterStart || 0) + delta;
          if (ticksAfterStart > 2.0) slowStart = false;
        }
      }
      if (isGameRunning) animationId = requestAnimationFrame(gameLoop);
      if (deathFall) updateDeathFall(delta);
    }
    function flap() {
      if (!showPlayer || !isGameRunning || player.rotating) return;
      player.velocityY = playerConf.jump;
    }
    function onKeyDown(e) { if (e.code === "Space") flap(); }
    function onClickOrTouch() { flap(); }
    function handleDeathAnimation() {
      if (!player.alive || player.rotating) return;
      player.alive = false;
      isGameRunning = false;
      player.rotating = true;
      player.velocityY = 250;
      document.removeEventListener("keydown", onKeyDown);
      document.removeEventListener("mousedown", onClickOrTouch);
      document.removeEventListener("touchstart", onClickOrTouch);
      deathFall = true;
    }
    function updateDeathFall(delta) {
      player.y += player.velocityY * delta;
      player.velocityY += 700 * delta;
      ctx = gameCanvas.getContext("2d");
      ctx.clearRect(0, 0, canvasWidth, canvasHeight);
      bgX = (bgX - SPEEDS.background * delta) % GAME_WIDTH;
      ctx.drawImage(images.bg, scaleX(bgX), 0, canvasWidth, canvasHeight);
      ctx.drawImage(images.bg, scaleX(bgX + GAME_WIDTH), 0, canvasWidth, canvasHeight);
      // Draw player rotated
      drawImage(images.kirby, scaleX(player.x), scaleY(player.y), scaleX(player.width), scaleY(player.height), 90);
      if (player.y > GAME_HEIGHT + 80) {
        deathFall = false;
        showGameOverSequence();
      } else {
        requestAnimationFrame(gameLoop);
      }
    }
    function showGameOverSequence() {
      let newHigh = false;
      if (scoreThisRun > highScore) {
        highScore = scoreThisRun;
        newHigh = true;
      }
      updateScoreInDB(newHigh, scoreThisRun);
      let popupText = `You collected <b>${scoreThisRun}</b> coins.<br>`;
      if (newHigh) popupText += "<span style='color:#b13df3'>NEW RECORD!</span><br>";
      popupText += `Your best: <b>${highScore}</b>`;
      coinsTextInGame.style.display = "none";
      setTimeout(() => showGameOverPopup(popupText), 600);
    }
    function showGameOverPopup(html) {
      gameOverText.innerHTML = html;
      gameOverPopup.style.display = "flex";
    }
    gameOverCloseBtn.onclick = endGameAndReturn;
    function endGameAndReturn() {
      cancelAnimationFrame(animationId);
      document.removeEventListener("keydown", onKeyDown);
      document.removeEventListener("mousedown", onClickOrTouch);
      document.removeEventListener("touchstart", onClickOrTouch);
      gameContainer.style.display = "none";
      gameOverPopup.style.display = "none";
      coinsDisplay.textContent = `Best: ${highScore}`;
      yourHighScore.textContent = `Best: ${highScore}`;
      updatePlace();
      mainMenu.style.display = "flex";
    }
    async function updateScoreInDB(isNewHigh, latestScore) {
      const userRef = ref(db, `users/${userId}`);
      let updateData = {};
      if (isNewHigh) updateData.highScore = latestScore;
      await update(userRef, updateData);
      coinsDisplay.textContent = `Best: ${highScore}`;
      yourHighScore.textContent = `Best: ${highScore}`;
    }

    // --- –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤, Splash, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º loadUser ---
    window.onload = () => {
      preloadResources(() => {
        showSplashThenMenu();
        setTimeout(() => { loadUser(); }, 2200);
      });
    };
  </script>
</body>
</html>
