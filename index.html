<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Floppy Kirby ‚Äî Telegram WebApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Nunito:800,700,600,400|Poppins:600,400&display=swap" rel="stylesheet">
  <!-- –ò–∫–æ–Ω–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ About -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; font-family:'Nunito','Poppins','Open Sans',sans-serif; background:#f7f4ff; overflow:hidden; user-select:none;}
 html, body {
  margin: 0; padding: 0;
  width: 100vw; height: 100vh;
  font-family: 'Nunito', 'Poppins', 'Open Sans', sans-serif;
  background: #f7f4ff;
  overflow: hidden;
  user-select: none;
}

/* PRELOADER */
#preloader {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  background: #eee;
  display: flex; align-items: center; justify-content: center;
  z-index: 2000;
  transition: opacity .3s;
}
.loader {
  border: 10px solid #e0d4fe;
  border-top: 10px solid #a98be7;
  border-radius: 50%;
  width: 72px; height: 72px;
  animation: spin 1s linear infinite;
  box-shadow: 0 2px 22px #d1b6e799;
}
@keyframes spin { 100% { transform: rotate(360deg); } }

/* MAIN MENU / LEADERBOARD / INFO / GAME OVER POPUP */
#mainMenu, #leaderboardContainer, #infoContainer, #gameOverPopup {
  width: 100vw; height: 100vh;
  display: none; position: fixed; top: 0; left: 0;
  flex-direction: column; align-items: center; justify-content: flex-start;
  background: linear-gradient(120deg, #a2d2ff 0%, #ffe7f3 100%);
  overflow-y: auto;
  padding-top: 20px !important;
  z-index: 100;
}

#mainMenu .menu-inner,
#leaderboardContainer .menu-inner,
#infoContainer .menu-inner,
#gameOverPopup .menu-inner {
  margin-top: 100px; width: 100%;
  display: flex; flex-direction: column; align-items: center;
}

/* GAME CANVAS + HUD */
#gameContainer {
  width: 100vw; height: 100vh; display: none;
  position: fixed; top: 0; left: 0;
  background: #fff; z-index: 120; overflow: hidden;
}
#gameHudCoins {
  position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
  font-size: 2em; font-weight: 900; color: #fff;
  background: linear-gradient(90deg, #b07cff 0, #ffb5d1 100%);
  padding: 10px 32px; border-radius: 28px;
  box-shadow: 0 6px 28px #c2a4ff22;
  text-shadow: 0 2px 6px #a2d2ffb2;
  border: 2px solid #fff;
  pointer-events: none; z-index: 110;
  letter-spacing: .02em; font-family: 'Nunito','Poppins',sans-serif;
  transition: background 0.28s;
  user-select: none;
}

.tooltip {
  margin-bottom: 22px;
  background: #fff4;
  color: #7e47a8;
  font-size: 1.13em;
  padding: 9px 22px;
  border-radius: 20px;
  box-shadow: 0 8px 22px #b8d8fa36;
  letter-spacing: .03em;
  transition: background 0.3s;
  max-width: 90vw;
  text-align: center;
}

.user-header {
  display: flex; flex-direction: column; align-items: center;
  margin-bottom: 20px; gap: 6px;
  background: rgba(255,255,255,0.63);
  border-radius: 18px;
  box-shadow: 0 4px 16px #c8a2c866;
  padding: 18px 32px 15px 32px;
}
.user-header img {
  width: 72px; height: 72px;
  border-radius: 50%; border: 3.5px solid #fff;
  box-shadow: 0 4px 24px 0 #a2d2ff61;
  background: #fff; margin-bottom: 3px;
  object-fit: cover;
}
.user-header span {
  font-size: 1.14em; color: #4b3570; font-weight: 700;
  text-shadow: 0 2px 4px #eee; max-width: 200px;
  text-overflow: ellipsis; overflow: hidden; white-space: nowrap;
  letter-spacing: .01em;
}
.user-meta {
  display: flex; flex-direction: row; gap: 10px;
  margin-bottom: 18px; align-items: center;
  width: 100%; justify-content: center;
}
.user-meta div {
  font-size: 1.01em; color: #44335b;
  background: #fff9; border-radius: 13px;
  padding: 5px 18px; margin: 2px 0;
  box-shadow: 0 2px 8px #a2d2ff1a;
  min-width: 90px; text-align: center; font-weight: 600;
}
#coinsDisplay {
  color: #fff;
  background: linear-gradient(90deg,#c186fd 0,#ffb5d1 100%);
  font-size: 1.12em; font-weight: 700;
  margin-bottom: 16px;
  padding: 8px 24px; border-radius: 30px;
  box-shadow: 0 3px 12px #c2a4ff1a;
  text-shadow: 0 2px 2px #fff9;
  border: 2px solid #fff; letter-spacing: .04em;
  display: inline-block;
}
.main-btn {
  margin: 14px 0 0 0; padding: 15px 36px;
  font-size: 1.15em;
  background: linear-gradient(90deg,#f7c8e0 0%,#b6eaff 100%);
  border: none; border-radius: 29px;
  box-shadow: 0 3px 16px #a2d2ff4d, 0 1px 1px #fff;
  cursor: pointer; font-weight: 700; color: #493a66;
  transition: 0.16s; display: block;
}
.main-btn:hover {
  background: linear-gradient(90deg,#ffc0cb 10%,#a2d2ff 100%);
  transform: scale(1.06);
}
.main-btn:active { transform: scale(0.96); }
#leaderboardBackBtn, #infoBackBtn {
  position: absolute; top: 100px; left: 24px;
  padding: 11px 30px;
  background: linear-gradient(90deg,#f8daea 0%,#d1eaff 100%);
  border: none; border-radius: 22px;
  font-size: 1.04em; font-weight: 700;
  color: #4e3888; cursor: pointer;
  box-shadow: 0 3px 0 #c8a2c8, 0 2px 8px #ffdbf933;
  z-index: 99; transition: background 0.22s;
}
#leaderboardBackBtn:hover, #infoBackBtn:hover {
  background: linear-gradient(90deg,#c186fd 0,#ffb5d1 100%);
  color: #fff;
}
#infoContainer p {
  font-size: 1.10em; color: #493A64;
  background: #fff7; border-radius: 12px;
  padding: 10px 14px; margin-top: 0;
}
#gameOverPopup {
  z-index: 999; display: none; align-items: center; justify-content: center;
  background: rgba(60,30,80,0.42); animation: fadeIn 0.23s;
}
.popup-box {
  background: linear-gradient(120deg,#fff 63%,#ffe3fa 100%);
  border-radius: 32px;
  padding: 34px 36px 28px 36px;
  min-width: 240px;
  box-shadow: 0 8px 30px #e3caff88;
  display: flex; flex-direction: column; align-items: center; gap: 18px;
  margin: 0; position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
}
.popup-box h2 { margin: 0 0 8px 0; color: #9857d3; font-size: 1.23em; }
.popup-box p { color: #47366b; font-size: 1.07em; margin: 0; }
.popup-box button { margin-top: 5px; padding: 13px 32px;
  background: linear-gradient(90deg,#f7c8e0 0,#b6eaff 100%);
  border-radius: 20px; border: none; color: #44335b; font-weight: 700;
  font-size: 1.09em; box-shadow: 0 2px 12px #a2d2ff3b; cursor: pointer;
  transition: background 0.14s; display: block;
}
.popup-box button#gameOverCloseBtn { display: block; }
#countdownOverlay {
  display: none; position: absolute; top: 0; left: 0;
  width: 100vw; height: 100vh; z-index: 222;
  align-items: center; justify-content: center;
  background: rgba(248,245,255,0.78);
  font-size: 3em; color: #9857d3; font-weight: 900;
  font-family: 'Nunito',sans-serif;
  letter-spacing: .08em; text-shadow: 0 2px 12px #fff;
}

/* LEADERBOARD */
#leaderboardContainer .menu-inner { width: 95%; max-width: 440px; }
#leaderboardBody tr { transition: background 0.17s; }
#leaderboardBody tr:nth-child(odd) { background: #f8e7fd70; }
#leaderboardBody tr:hover { background: #c186fd33; }
#leaderboardContainer table {
  width: 100%;
  border-radius: 19px;
  box-shadow: 0 2px 16px #e9c3ff5b;
  overflow: hidden;
  margin-top: 15px;
  font-size: 1.12em;
  background: #fff8;
  border-collapse: separate;
  border-spacing: 0 6px;
}
#leaderboardContainer th, #leaderboardContainer td {
  padding: 14px 0; text-align: center; color: #68318d;
  border-bottom: 1.5px solid #e8c8fd;
  font-weight: 700; letter-spacing: .02em;
}
#leaderboardContainer th {
  background: linear-gradient(90deg,#e7cbfa 0,#fbe1fd 100%);
}
#leaderboardContainer td { font-weight: 600; }

/* ABOUT SECTION (–ù–û–í–´–ô –î–ò–ó–ê–ô–ù) */
#aboutSection {
  display: none; flex-direction: column; align-items: center; justify-content: flex-start;
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  background: linear-gradient(120deg,#ffe7f3 0,#a2d2ff 100%);
  z-index: 1100; overflow-y: auto; padding-top: 42px;
}
#aboutSection h2 {
  color: #7c46a3; margin: 8px 0 25px 0; font-size: 2em;
}
.about-cards { display: flex; flex-direction: column; gap: 22px; align-items: center; }
.about-card {
  background: linear-gradient(120deg,#fff 65%,#f5e7fa 100%);
  border-radius: 26px; box-shadow: 0 4px 20px #c2a4ff22;
  min-width: 260px; max-width: 92vw;
  display: flex; flex-direction: row; align-items: center;
  gap: 20px; padding: 18px 30px;
  transition: box-shadow 0.15s,transform 0.15s;
  text-decoration: none; color: inherit;
}
.about-card:hover {
  box-shadow: 0 8px 36px #c2a4ff55;
  transform: scale(1.035);
}
.about-card .icon {
  width: 54px; height: 54px;
  display: flex; align-items: center; justify-content: center;
  font-size: 2.2em; color: #b07cff; background: #fff; border-radius: 50%;
  box-shadow: 0 2px 14px #c8a2c866; margin-right: 5px; flex-shrink: 0;
}
.about-card .desc { display: flex; flex-direction: column; }
.about-card .desc .title { font-size: 1.18em; font-weight: 800; color: #7c46a3; margin-bottom: 2px; }
.about-card .desc .text { font-size: 1.03em; color: #493A64; }
.about-card .desc .link { color: #7c46a3; font-weight: 700; text-decoration: underline; }
.about-close-btn {
  margin-top: 38px; padding: 13px 32px;
  background: linear-gradient(90deg,#f7c8e0 0,#b6eaff 100%);
  border-radius: 20px; border: none;
  color: #44335b; font-weight: 700;
  font-size: 1.09em; box-shadow: 0 2px 12px #a2d2ff3b;
  cursor: pointer; transition: background 0.14s; display: block;
}

/* –ù–ê–í–ò–ì–ê–¶–ò–Ø –°–ù–ò–ó–£ */
#bottomNav {
  position: fixed; left: 0; right: 0; bottom: 40px;
  display: flex; justify-content: center; gap: 26px;
  z-index: 1200; pointer-events: none;
  transition: opacity 0.25s;
}
.nav-btn {
  display: flex; flex-direction: column; align-items: center;
  background: linear-gradient(90deg,#e0d4fe 0,#ffe7f3 100%);
  border: none; border-radius: 26px;
  box-shadow: 0 4px 16px #c8a2c866;
  color: #7c46a3;
  font-size: 1.01em; font-weight: 700;
  padding: 8px 28px 8px 28px; cursor: pointer;
  transition: 0.14s; min-width: 84px; pointer-events: auto;
}
.nav-btn i { font-size: 1.6em; margin-bottom: 3px; }
.nav-btn.active, .nav-btn:hover {
  background: linear-gradient(90deg,#b07cff 0,#ffb5d1 100%);
  color: #fff;
}

/* –ö–ù–û–ü–ö–ê –ù–ê–°–¢–†–û–ï–ö (–°–ù–ò–ó–£) */
#settingsBtn {
  position: fixed; left: 50%; transform: translateX(-50%);
  bottom: 120px; z-index: 1300;
  background: linear-gradient(90deg,#f7c8e0 0,#b6eaff 100%);
  border: none; border-radius: 50px;
  box-shadow: 0 4px 16px #c8a2c866;
  color: #7c46a3; font-size: 1.12em; font-weight: 700;
  padding: 10px 38px 10px 38px;
  display: flex; align-items: center; gap: 10px;
  cursor: pointer; transition: 0.16s;
}
#settingsBtn i { font-size: 1.45em; }
#settingsBtn.hide { display: none; }

/* –ü–ê–ù–ï–õ–¨ –ù–ê–°–¢–†–û–ï–ö */
#settingsPanel {
  display: none; flex-direction: column; align-items: center; justify-content: center;
  position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(230,225,255,0.92); z-index: 2000; animation: fadeIn 0.23s;
}
#settingsPanel .panel-box {
  background: linear-gradient(120deg,#fff 65%,#ffe3fa 100%);
  border-radius: 28px; box-shadow: 0 6px 30px #e3caff88;
  padding: 36px 38px 30px 38px; min-width: 220px;
  display: flex; flex-direction: column; align-items: center; gap: 19px;
}
#settingsPanel .panel-box h2 { margin: 0 0 12px 0; color: #7c46a3; }
.slider-group { display: flex; flex-direction: row; align-items: center; gap: 16px; }
.slider-label { font-size: 1.08em; min-width: 64px; color: #493a64; }
.slider { width: 128px; }
#settingsCloseBtn {
  margin-top: 10px; padding: 11px 28px;
  background: linear-gradient(90deg,#f7c8e0 0,#b6eaff 100%);
  border-radius: 20px; border: none; color: #44335b;
  font-weight: 700; font-size: 1.01em;
  box-shadow: 0 2px 12px #a2d2ff3b; cursor: pointer;
  transition: background 0.14s; display: block;
}

/* –°–ö–†–´–¢–ò–ï –ù–ê–í–ò–ì–ê–¶–ò–ò –í–û –í–†–ï–ú–Ø –ò–ì–†–´ */
.nav-hide { opacity: 0; pointer-events: none !important; }

@media (max-width:600px) {
  .main-btn,#leaderboardBackBtn,#infoBackBtn,.popup-box button{font-size:0.97em;padding:11px 12px;}
  .user-header img{width:60px;height:60px;}
  .popup-box{padding:22px 10vw;}
  #gameHudCoins{font-size:1.3em;padding:7px 10vw;}
  #leaderboardContainer .menu-inner {margin-top:75px;}
  .about-card{min-width:92vw;padding:11px 12px;}
  #settingsBtn{font-size:0.98em;padding:9px 16vw;}
}
@media (max-width:390px) {
  #coinsDisplay{font-size:0.94em;padding:7px 10px;}
  .user-meta div{font-size:0.92em;}
  .user-header{padding:10px 7vw;}
  #gameHudCoins{font-size:1.12em;padding:7px 4vw;}
  #leaderboardContainer table{font-size:0.98em;}
}
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

  </style>
</head>
<body>
  <!-- ... –û—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ —Ç–≤–æ–∏ —Å–µ–∫—Ü–∏–∏ ... -->
  <!-- Main Menu -->
  <div id="mainMenu">
    <div class="menu-inner">
      <div class="tooltip">Collect coins and dodge enemies! ü™ô</div>
      <div class="user-header">
        <img id="userPhoto" src="" alt="Avatar" />
        <span id="userName">@User</span>
      </div>
      <div class="user-meta">
        <div id="yourPlace">Rank: ...</div>
        <div id="yourHighScore">Best: ...</div>
      </div>
      <div id="coinsDisplay"></div>
      <button id="startGameBtn" class="main-btn">Start Game</button>
      <button id="leaderboardBtn" class="main-btn">Leaderboard</button>
      <button id="infoBtn" class="main-btn">How to Play?</button>
    </div>
  </div>
  <!-- Game Screen -->
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="gameHudCoins" style="display:none;">Coins: 0</div>
    <div id="countdownOverlay"></div>
  </div>
  <!-- Leaderboard -->
  <div id="leaderboardContainer">
    <div class="menu-inner">
      <button id="leaderboardBackBtn" class="main-btn" style="position:absolute;">Back</button>
      <h2 style="color:#7c46a3;text-align:center;margin:8px 0 0 0">Leaderboard</h2>
      <table>
        <thead>
          <tr><th style="border-radius:15px 0 0 0;">User</th><th style="border-radius:0 15px 0 0;">Best</th></tr>
        </thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </div>
  </div>
  <!-- Info -->
  <div id="infoContainer">
    <div class="menu-inner">
      <button id="infoBackBtn" class="main-btn" style="position:absolute;">Back</button>
      <h2 style="color:#7c46a3;text-align:center;margin:5px 0 10px 0;">How to Play?</h2>
      <p>
        <b>Kirby</b> flies endlessly, collecting coins and dodging enemies.<br>
        If Kirby hits an enemy or falls ‚Äî the game is over.<br>
        <b>Controls:</b> Tap / Click or Space.<br>
        The goal is to collect as many coins as possible in one run!<br>
        <br>
        Your record is saved and displayed in the leaderboard. Good luck!
      </p>
    </div>
  </div>
  <!-- Game Over Popup -->
  <div id="gameOverPopup">
    <div class="menu-inner">
      <div class="popup-box">
        <h2>Game Over!</h2>
        <p id="gameOverText"></p>
        <button id="gameOverCloseBtn" class="main-btn">Back to Menu</button>
      </div>
    </div>
  </div>
  <!-- --- ABOUT SECTION --- -->
 <div id="aboutSection">
  <h2>About the Game</h2>
  <div class="about-cards">
    <a class="about-card" href="https://t.me/bigkirby" target="_blank">
      <div class="icon" style="background:#ffe1f0;"><i class="fa-solid fa-crown"></i></div>
      <div class="desc">
        <div class="title">Powered by BigKirby</div>
        <div class="text">
          This game is created <b>exclusively</b> for the <span class="link">@bigkirby</span> community.<br>
          <span style="font-size:0.97em;color:#8e4898;">Play, compete, and be part of the legend!</span>
        </div>
      </div>
    </a>
    <a class="about-card" href="https://t.me/ontonlive" target="_blank">
      <div class="icon" style="background:#daf5ff;"><i class="fa-solid fa-network-wired"></i></div>
      <div class="desc">
        <div class="title">ONTON Platform</div>
        <div class="text">
          Hosted on <span class="link">ONTON</span> ‚Äî your gateway to Web3 gaming.<br>
          <span style="color:#2471b8;">Winners receive exclusive SBT rewards from ONTON!</span>
        </div>
      </div>
    </a>
    <a class="about-card" href="https://t.me/galaxyton" target="_blank">
      <div class="icon" style="background:#f5eaff;"><i class="fa-solid fa-user-astronaut"></i></div>
      <div class="desc">
        <div class="title">Developed by Galaxyton</div>
        <div class="text">
          Crafted and coded by <span class="link">@galaxyton</span>.<br>
          <span style="color:#8460b7;">Bringing unique game experiences to Telegram.</span>
        </div>
      </div>
    </a>

  <!-- --- –ù–ê–í–ò–ì–ê–¶–ò–Ø --- -->
  <div id="bottomNav">
    <button class="nav-btn active" id="navGameBtn">
      <i class="fa-solid fa-gamepad"></i>
      Game
    </button>
    <button class="nav-btn" id="navAboutBtn">
      <i class="fa-solid fa-circle-info"></i>
      About
    </button>
  </div>
  <!-- --- –ö–ù–û–ü–ö–ê –ù–ê–°–¢–†–û–ï–ö --- -->
  <button id="settingsBtn"><i class="fa-solid fa-sliders"></i>Settings</button>
  <!-- --- –ü–ê–ù–ï–õ–¨ –ù–ê–°–¢–†–û–ï–ö --- -->
  <div id="settingsPanel">
    <div class="panel-box">
      <h2>Settings</h2>
      <div class="slider-group">
        <span class="slider-label">Music</span>
        <input type="range" id="musicSlider" class="slider" min="0" max="1" step="0.01" value="0.85">
      </div>
      <div class="slider-group">
        <span class="slider-label">Sounds</span>
        <input type="range" id="sfxSlider" class="slider" min="0" max="1" step="0.01" value="0.8">
      </div>
      <button id="settingsCloseBtn">Close</button>
    </div>
  </div>
  <div id="preloader"><div class="loader"></div></div>
<script type="module">
// --- SOUNDS ---
const sfx_die = new Audio("sfx_die.mp3");
const sfx_point = new Audio("sfx_point.mp3");
sfx_die.preload = sfx_point.preload = "auto";
sfx_die.volume = 0.7; sfx_point.volume = 0.9;

// --- GAME MUSIC ---
const music = new Audio("game1.wav");
music.preload = "auto";
music.loop = true;
music.volume = 0.85;

// Telegram WebApp
const tg = window.Telegram.WebApp;
if (typeof tg.requestFullscreen === 'function') tg.requestFullscreen();
else tg.expand();

// Firebase 9+
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyBsYVTUOqyeneSEPgW81bX_Cmb6DABPiws",
  authDomain: "kirby-fly.firebaseapp.com",
  databaseURL: "https://kirby-fly-default-rtdb.firebaseio.com",
  projectId: "kirby-fly",
  storageBucket: "kirby-fly.firebasestorage.app",
  messagingSenderId: "100130749805",
  appId: "1:100130749805:web:4466d63dc2654fec172e64",
  measurementId: "G-1HNHYTGNYG"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM Elements (—Ç–≤–æ–∏ —Å—Ç–∞—Ä—ã–µ + –Ω–æ–≤—ã–µ)
const mainMenu = document.getElementById("mainMenu");
const userPhoto = document.getElementById("userPhoto");
const userName = document.getElementById("userName");
const coinsDisplay = document.getElementById("coinsDisplay");
const startGameBtn = document.getElementById("startGameBtn");
const leaderboardBtn = document.getElementById("leaderboardBtn");
const infoBtn = document.getElementById("infoBtn");
const gameContainer = document.getElementById("gameContainer");
const gameCanvas = document.getElementById("gameCanvas");
const leaderboardContainer = document.getElementById("leaderboardContainer");
const leaderboardBackBtn = document.getElementById("leaderboardBackBtn");
const leaderboardBody = document.getElementById("leaderboardBody");
const infoContainer = document.getElementById("infoContainer");
const infoBackBtn = document.getElementById("infoBackBtn");
const yourPlace = document.getElementById("yourPlace");
const yourHighScore = document.getElementById("yourHighScore");
const gameOverPopup = document.getElementById("gameOverPopup");
const gameOverText = document.getElementById("gameOverText");
const gameOverCloseBtn = document.getElementById("gameOverCloseBtn");
const countdownOverlay = document.getElementById("countdownOverlay");
const gameHudCoins = document.getElementById("gameHudCoins");
const preloader = document.getElementById("preloader");
// --- NEW:
const bottomNav = document.getElementById("bottomNav");
const navGameBtn = document.getElementById("navGameBtn");
const navAboutBtn = document.getElementById("navAboutBtn");
const aboutSection = document.getElementById("aboutSection");
const aboutCloseBtn = document.getElementById("aboutCloseBtn");
const settingsBtn = document.getElementById("settingsBtn");
const settingsPanel = document.getElementById("settingsPanel");
const settingsCloseBtn = document.getElementById("settingsCloseBtn");
const musicSlider = document.getElementById("musicSlider");
const sfxSlider = document.getElementById("sfxSlider");

// --- –ü–û–õ–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–ò–í–Ø–ó–ö–ò ---
// --- –ü—Ä–µ–ª–æ–∞–¥ –∏ —Å—Ç–∞—Ä—ã–π –∫–æ–¥ ---
let tgUser;
let userId, highScore = 0;
let allLoaded = 0;
let loadTotal = 5;
let kirbyImgs = [new Image(), new Image()];
let kirbyEatImg = new Image();
let enemyImgs = [new Image(), new Image()];
let coinImg = new Image(), bgImage = new Image();
kirbyImgs[0].src = "k1.png"; kirbyImgs[1].src = "k2.png";
kirbyEatImg.src = "k3.png";
enemyImgs[0].src = "e1.png"; enemyImgs[1].src = "e2.png";
coinImg.src = "https://pixelartmaker-data-78746291193.nyc3.digitaloceanspaces.com/image/c07093d1e8085ba.png";
bgImage.src = "https://blog.itselectlab.com/wp-content/uploads/background.png";
function assetLoaded() { allLoaded++; if(allLoaded>=loadTotal) showApp(); }
[kirbyImgs[0], kirbyImgs[1], kirbyEatImg, enemyImgs[0], enemyImgs[1]].forEach(img => img.onload = assetLoaded);
function showApp() { preloader.style.opacity = 0; setTimeout(()=>{preloader.style.display="none";},320); }
async function finishLoading() {
  tgUser = tg.initDataUnsafe?.user;
  if (!tgUser) {
    mainMenu.innerHTML = "<h2>Please open in Telegram!</h2>";
    throw new Error("Not Telegram WebApp");
  }
  userId = tgUser.id.toString();
  await loadUser();
  showApp();
}
finishLoading();
async function loadUser() {
  userPhoto.src = tgUser.photo_url || "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png";
  userPhoto.onerror = function() {
    if (userPhoto.src !== "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png") {
      userPhoto.src = "https://raw.githubusercontent.com/qnexst/404token/main/avatar.png";
    }
  };
  userName.textContent = tgUser.username ? "@" + tgUser.username : "No username";
  const userRef = ref(db, `users/${userId}`);
  let snapshot = await get(userRef);
  if (!snapshot.exists()) {
    await set(userRef, {highScore:0,username:tgUser.username||"",photo:tgUser.photo_url||""});
    highScore = 0;
  } else {
    highScore = snapshot.val().highScore || 0;
  }
  coinsDisplay.textContent = `Best: ${highScore}`;
  yourHighScore.textContent = `Best: ${highScore}`;
  await updatePlace();
  mainMenu.style.display = "flex";
}
async function updatePlace() {
  yourPlace.textContent = "Rank: ...";
  const usersRef = ref(db, "users/");
  const snapshot = await get(usersRef);
  if (snapshot.exists()) {
    const data = snapshot.val();
    const usersArray = Object.entries(data).map(([id, u]) => ({id,highScore:u.highScore||0}));
    usersArray.sort((a, b) => b.highScore - a.highScore);
    const place = usersArray.findIndex(x => x.id === userId) + 1;
    if (place > 0) yourPlace.textContent = `Rank: ${place} of ${usersArray.length}`;
    else yourPlace.textContent = `Rank: ‚Äî`;
  }
}
startGameBtn.onclick = () => { mainMenu.style.display = "none"; startGameWithCountdown(); };
leaderboardBtn.onclick = () => { mainMenu.style.display = "none"; leaderboardContainer.style.display = "flex"; loadLeaderboard(); };
infoBtn.onclick = () => { mainMenu.style.display = "none"; infoContainer.style.display = "flex"; };
leaderboardBackBtn.onclick = () => { leaderboardContainer.style.display = "none"; mainMenu.style.display = "flex"; };
infoBackBtn.onclick = () => { infoContainer.style.display = "none"; mainMenu.style.display = "flex"; };
async function loadLeaderboard() {
  leaderboardBody.innerHTML = "";
  const usersRef = ref(db, "users/");
  const snapshot = await get(usersRef);
  if (snapshot.exists()) {
    const data = snapshot.val();
    const usersArray = Object.entries(data).map(([id, u]) => ({username:u.username?`@${u.username}`:"User "+id,highScore:u.highScore||0,}));
    usersArray.sort((a, b) => b.highScore - a.highScore);
    usersArray.forEach((user, idx) => {
      const tr = document.createElement("tr");
      let topStyle = "";
      if(idx === 0) topStyle = "font-weight:900;color:#a934db;background:linear-gradient(90deg,#ffd2fb 50%,#e6d7ff 100%)";
      else if(idx === 1) topStyle = "font-weight:800;color:#5351d9;background:linear-gradient(90deg,#f9e6ff 50%,#cde7f7 100%)";
      else if(idx === 2) topStyle = "font-weight:800;color:#ffb300;background:linear-gradient(90deg,#f3ebfd 50%,#fceabb 100%)";
      tr.innerHTML = `<td style="${topStyle}">${user.username}</td><td style="${topStyle}">${user.highScore}</td>`;
      leaderboardBody.appendChild(tr);
    });
  }
}

// --- GAME LOGIC ... (–æ—Å—Ç–∞–≤–ª—è–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
// -------- CANVAS GAME --------
// ... –≤–µ—Å—å —Ç–≤–æ–π –∏–≥—Ä–æ–≤–æ–π –¥–≤–∏–∂–æ–∫ –Ω–∏–∂–µ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –¥–æ —Ñ—É–Ω–∫—Ü–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã –∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –º–µ–Ω—é ...
let BASE_GRAVITY = 0.23;
let BASE_LIFT = -4.6;
let BASE_SCROLL = 2.16;
let BASE_MAXFALL = 4.7;
let ENEMY_SPAWN_SEC = 1;
let COIN_SPAWN_SEC = 0.95;
let DIFFICULTY_SPEEDUP = 1.13;
let ENEMY_SPAWN_ACCEL = 0.16;

let ctx, animationId, isGameRunning = false;
let canvasWidth = 0, canvasHeight = 0;
let player = {};
let enemies = [];
let coins = [];
let enemySpawnTimer = 0;
let coinSpawnTimer = 0;
let scoreThisRun = 0, bgX = 0;
let showPlayer = false, slowStart = true, deathFall = false;
let gameStartTime = 0, lastFrameTime = 0, firstTapDone = false;

let kirbyCurrentFrame = 0;
let kirbyAngle = 0;
const MIN_ANGLE = -27;
const MAX_ANGLE = 78;
const ANGLE_RETURN_SPEED = 8;

// –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è k3 (–∫—É—à–∞–µ—Ç –º–æ–Ω–µ—Ç—É)
let kirbyEatAnimation = false;
let kirbyEatTimer = 0;
const KIRBY_EAT_DURATION = 220; // –º—Å (0.22 —Å–µ–∫)

let enemyAnimFrame = 0;
let enemyAnimLastTime = performance.now();

function resizeCanvas() {
  canvasWidth = window.innerWidth;
  canvasHeight = window.innerHeight;
  gameCanvas.width = canvasWidth;
  gameCanvas.height = canvasHeight;
  if (ctx) ctx.imageSmoothingEnabled = false;
}
window.addEventListener("resize", () => { if (isGameRunning) resizeCanvas(); });

function startGameWithCountdown() {
  BASE_GRAVITY = 0.23; BASE_LIFT = -4.6; BASE_SCROLL = 2.16;
  BASE_MAXFALL = 4.7; ENEMY_SPAWN_SEC = 1; COIN_SPAWN_SEC = 0.95;
  ctx = gameCanvas.getContext("2d", { alpha: false });
  resizeCanvas();
  gameContainer.style.display = "block";
  gameOverPopup.style.display = "none";
  gameHudCoins.style.display = "none";
  scoreThisRun = 0;
  player = {
    x: 100, y: canvasHeight/2, width: 48, height: 48, velocityY: 0, gravity: BASE_GRAVITY,
    lift: BASE_LIFT, alive: true, maxFallSpeed: BASE_MAXFALL, rotating: false
  };
  enemies = [];
  coins = [];
  enemySpawnTimer = 0;
  coinSpawnTimer = 0;
  bgX = 0;
  deathFall = false;
  showPlayer = false;
  slowStart = true;
  slowStartFrame = 0;
  gameStartTime = performance.now();
  lastFrameTime = gameStartTime;
  firstTapDone = false;
  kirbyCurrentFrame = 0;
  kirbyAngle = 0;
  kirbyEatAnimation = false;
  kirbyEatTimer = 0;
  let countdown = 3;
  countdownOverlay.style.display = "flex";
  countdownOverlay.textContent = countdown;

  // --- Hide navigation and settings while playing ---
  bottomNav.classList.add('nav-hide');
  settingsBtn.classList.add('hide');

  // Start music
  try { music.currentTime = 0; music.play(); } catch(e){}

  let cdInt = setInterval(() => {
    countdown--;
    if (countdown === 0) {
      countdownOverlay.textContent = "GO!";
    } else if (countdown < 0) {
      countdownOverlay.style.display = "none";
      clearInterval(cdInt);
      showPlayer = true;
      startGameCore();
    } else {
      countdownOverlay.textContent = countdown;
    }
  }, 900);
}
let slowStartFrame = 0, ticksAfterStart = 0;

// --- ONLY ONE INPUT PER FLAP ---
let inputLock = false;
function startGameCore() {
  isGameRunning = true;
  slowStart = true; slowStartFrame = 0; ticksAfterStart = 0;
  gameHudCoins.textContent = "Coins: 0";
  gameHudCoins.style.display = "block";
  document.addEventListener("keydown", onKeyDown, { passive: false });
  gameCanvas.addEventListener("touchstart", onTouch, { passive: false });
  gameCanvas.addEventListener("mousedown", onMouse, { passive: false });
  lastFrameTime = performance.now();
  animationId = requestAnimationFrame(updateGame);
}
function stopInputListeners() {
  document.removeEventListener("keydown", onKeyDown);
  gameCanvas.removeEventListener("touchstart", onTouch);
  gameCanvas.removeEventListener("mousedown", onMouse);
}
function onKeyDown(e) {
  if (e.code === "Space") {
    if (!inputLock) {
      inputLock = true;
      handleFlap();
      switchKirbyFrame();
      setTimeout(() => {inputLock = false;}, 120);
    }
    e.preventDefault();
  }
}
function onTouch(e) {
  if (!inputLock) {
    inputLock = true;
    handleFlap();
    switchKirbyFrame();
    setTimeout(() => {inputLock = false;}, 120);
  }
  e.preventDefault();
}
function onMouse(e) {
  if (!inputLock) {
    inputLock = true;
    handleFlap();
    switchKirbyFrame();
    setTimeout(() => {inputLock = false;}, 120);
  }
  e.preventDefault();
}

function updateGame(now = performance.now()) {
  let dt = Math.min((now - lastFrameTime) / 1000, 0.2);
  lastFrameTime = now;
  bgX -= BASE_SCROLL * dt * 60;
  if (bgX <= -canvasWidth) { bgX += canvasWidth; }
  ctx.drawImage(bgImage, Math.round(bgX), 0, canvasWidth, canvasHeight);
  ctx.drawImage(bgImage, Math.round(bgX + canvasWidth), 0, canvasWidth, canvasHeight);

  if (now - enemyAnimLastTime > 160) {
    enemyAnimFrame = 1 - enemyAnimFrame;
    enemyAnimLastTime = now;
  }

  if (showPlayer) {
    updatePlayer(dt);
    drawPlayer();
    if (isGameRunning) {
      ticksAfterStart++;
      if (ticksAfterStart > 120) {
        enemySpawnTimer += dt;
        if (enemySpawnTimer > ENEMY_SPAWN_SEC) { createEnemy(); enemySpawnTimer = 0; }
      }
      coinSpawnTimer += dt;
      if (coinSpawnTimer > COIN_SPAWN_SEC) { createCoin(); coinSpawnTimer = 0; }

      for (let i = 0; i < enemies.length; i++) {
        enemies[i].x -= enemies[i].speed * dt * 60;
        drawEnemy(enemies[i]);
        if (checkCollision(player, enemies[i])) { handleDeathAnimation(); return; }
      }
      enemies = enemies.filter(e => e.x + e.width > 0);

      for (let i = 0; i < coins.length; i++) {
        coins[i].x -= BASE_SCROLL * dt * 60;
        drawCoin(coins[i]);
        if (!coins[i].collected && checkCollision(player, coins[i])) {
          scoreThisRun++;
          coins[i].collected = true;
          kirbyEatAnimation = true;
          kirbyEatTimer = performance.now();
          if (scoreThisRun % 5 === 0) {
            sfx_point.volume = sfxSlider.value;
            sfx_point.currentTime = 0; sfx_point.play();
          }
          if (scoreThisRun % 10 === 0) {
            BASE_SCROLL *= DIFFICULTY_SPEEDUP;
            BASE_GRAVITY *= DIFFICULTY_SPEEDUP;
            BASE_LIFT *= DIFFICULTY_SPEEDUP;
            ENEMY_SPAWN_SEC = Math.max(ENEMY_SPAWN_SEC - ENEMY_SPAWN_ACCEL, 0.36);
          }
        }
      }
      coins = coins.filter(c => !c.collected && c.x + c.size > 0);

      gameHudCoins.textContent = "Coins: " + scoreThisRun;
      if (player.alive) { animationId = requestAnimationFrame(updateGame); }
    }
  }
  if (deathFall) updateDeathFall(dt);

  if (kirbyEatAnimation && (performance.now() - kirbyEatTimer > KIRBY_EAT_DURATION)) {
    kirbyEatAnimation = false;
  }
}
function drawPlayer() {
  let img = kirbyEatAnimation ? kirbyEatImg : kirbyImgs[kirbyCurrentFrame];
  ctx.save();
  ctx.translate(player.x + player.width/2, player.y + player.height/2);
  ctx.rotate((kirbyAngle * Math.PI) / 180);
  ctx.drawImage(img, -player.width/2, -player.height/2, player.width, player.height);
  ctx.restore();
}
function drawEnemy(e) {
  ctx.drawImage(enemyImgs[enemyAnimFrame], e.x, e.y, e.width, e.height);
}
function drawCoin(c) {
  ctx.drawImage(coinImg, c.x, c.y, c.size, c.size);
}
function createEnemy() {
  const randY = Math.random() * (canvasHeight - 42 - 20) + 10;
  const speed = BASE_SCROLL * (1 + Math.random() * 0.7);
  enemies.push({ x: canvasWidth, y: randY, width: 54, height: 40, speed: speed });
}
function createCoin() {
  const randY = Math.random() * (canvasHeight - 40 - 20) + 10;
  coins.push({ x: canvasWidth, y: randY, size: 40, collected: false });
}
function updatePlayer(dt) {
  let gravity = player.gravity;
  if (slowStart) {
    slowStartFrame++;
    gravity = 0.07;
    if (slowStartFrame > 72) slowStart = false;
  }
  player.velocityY += gravity * dt * 60;
  if (player.velocityY > player.maxFallSpeed) player.velocityY = player.maxFallSpeed;
  player.y += player.velocityY * dt * 60;
  if (player.y < 0) { player.y = 0; player.velocityY = 0; }
  let targetAngle = 0;
  if (player.velocityY < -1) targetAngle = MIN_ANGLE;
  else if (player.velocityY > 2) targetAngle = MAX_ANGLE;
  else targetAngle = 24;
  kirbyAngle += (targetAngle - kirbyAngle) * Math.min(dt * ANGLE_RETURN_SPEED, 1);
  if (player.y + player.height > canvasHeight) { handleDeathAnimation(); }
}
function handleFlap() {
  if (!player.alive) return;
  if (!firstTapDone) { firstTapDone = true; player.velocityY = player.lift; }
  else player.velocityY = player.lift;
  kirbyAngle = MIN_ANGLE;
}
function switchKirbyFrame() { kirbyCurrentFrame = 1 - kirbyCurrentFrame; }
function checkCollision(pl, obj) {
  const pr = { x: pl.x + 10, y: pl.y + 10, width: pl.width - 20, height: pl.height - 20 };
  const ow = (obj.width  || obj.size) - 20;
  const oh = (obj.height || obj.size) - 20;
  const or = { x: obj.x + 10, y: obj.y + 10, width:  ow > 0 ? ow : 0, height: oh > 0 ? oh : 0 };
  return !(
    or.x > pr.x + pr.width ||
    or.x + or.width < pr.x ||
    or.y > pr.y + pr.height ||
    or.y + or.height < pr.y
  );
}
function handleDeathAnimation() {
  if (!player.alive) return;
  player.alive = false;
  isGameRunning = false;
  deathFall = true;
  gameHudCoins.style.display = "none";
  stopInputListeners();
  player.rotating = true;
  kirbyAngle = MAX_ANGLE;
  player.velocityY = 3.5;
  lastFrameTime = performance.now();

  // SFX
  sfx_die.volume = sfxSlider.value;
  sfx_die.currentTime = 0; sfx_die.play();
  if (window.navigator.vibrate) window.navigator.vibrate([190,80,90]);

  // –ú—É–∑—ã–∫—É –≤—ã–∫–ª—é—á–∞–µ–º!
  music.pause();

  animationId = requestAnimationFrame(updateGame);
}
function updateDeathFall(dt) {
  player.y += player.velocityY * dt * 60 * 1.1;
  player.velocityY += 0.33 * dt * 60;
  kirbyAngle += (MAX_ANGLE - kirbyAngle) * Math.min(dt * 8, 1);
  if (player.y > canvasHeight + player.height) {
    deathFall = false;
    showGameOverSequence();
  } else {
    animationId = requestAnimationFrame(updateGame);
  }
}
function showGameOverSequence() {
  let newHigh = false;
  if (scoreThisRun > highScore) {
    highScore = scoreThisRun;
    newHigh = true;
  }
  updateScoreInDB(newHigh, scoreThisRun);
  let popupText = `You collected <b>${scoreThisRun}</b> coins this run.<br>`;
  if (newHigh) popupText += "<span style='color:#b13df3'>NEW RECORD!</span><br>";
  popupText += `Your best: <b>${highScore}</b>`;
  setTimeout(() => showGameOverPopup(popupText), 500);
}
function showGameOverPopup(html) {
  gameOverText.innerHTML = html;
  gameOverPopup.style.display = "flex";
}
gameOverCloseBtn.onclick = endGameAndReturn;
function endGameAndReturn() {
  if (isGameRunning || deathFall) {
    cancelAnimationFrame(animationId);
    stopInputListeners();
    isGameRunning = false; deathFall = false;
  }
  gameContainer.style.display = "none";
  gameOverPopup.style.display = "none";
  coinsDisplay.textContent = `Best: ${highScore}`;
  yourHighScore.textContent = `Best: ${highScore}`;
  updatePlace();
  mainMenu.style.display = "flex";

  // –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞–∑–∞–¥ –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∏ –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
  bottomNav.classList.remove('nav-hide');
  settingsBtn.classList.remove('hide');

  // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º—É–∑—ã–∫—É, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å
  music.pause();
  ticksAfterStart = 0;
}
async function updateScoreInDB(isNewHigh, latestScore) {
  const userRef = ref(db, `users/${userId}`);
  let updateData = {};
  if (isNewHigh) updateData.highScore = latestScore;
  await update(userRef, updateData);
  coinsDisplay.textContent = `Best: ${highScore}`;
  yourHighScore.textContent = `Best: ${highScore}`;
}


// === –ù–ê–í–ò–ì–ê–¶–ò–Ø: Game / About ===
navGameBtn.onclick = function() {
  // –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
  aboutSection.style.display = "none";
  mainMenu.style.display = "flex";
  navGameBtn.classList.add("active");
  navAboutBtn.classList.remove("active");
};
navAboutBtn.onclick = function() {
  mainMenu.style.display = "none";
  aboutSection.style.display = "flex";
  navGameBtn.classList.remove("active");
  navAboutBtn.classList.add("active");
};
// –ó–∞–∫—Ä—ã—Ç—å about —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
aboutCloseBtn.onclick = function() {
  aboutSection.style.display = "none";
  mainMenu.style.display = "flex";
  navGameBtn.classList.add("active");
  navAboutBtn.classList.remove("active");
};

// --- –°–∫—Ä—ã–≤–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é –∏ –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã ---
// (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤—ã—à–µ –≤ startGameWithCountdown –∏ endGameAndReturn)

// === –ö–ù–û–ü–ö–ê –ù–ê–°–¢–†–û–ï–ö –∏ –ü–ê–ù–ï–õ–¨ ===
settingsBtn.onclick = () => {
  settingsPanel.style.display = "flex";
  setTimeout(()=>{settingsPanel.querySelector('.panel-box').style.transform='scale(1.04)';},50)
};
settingsCloseBtn.onclick = () => {
  settingsPanel.style.display = "none";
};
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
musicSlider.oninput = () => { music.volume = musicSlider.value; };
sfxSlider.oninput = () => {
  sfx_point.volume = sfxSlider.value;
  sfx_die.volume = sfxSlider.value;
};
// –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–∞–Ω–µ–ª–∏ ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–ª–∑—É–Ω–∫–∏
settingsPanel.addEventListener("show",()=>{
  musicSlider.value = music.volume;
  sfxSlider.value = sfx_point.volume;
});

</script>
</body>
</html>

